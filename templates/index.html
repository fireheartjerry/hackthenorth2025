{% extends "base.html" %} {% block content %}
<!-- Modern Hero Section with Real-time Updates -->
<div class="hero-dashboard glass-panel mb-6">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="hero-avatar">
        <div class="status-indicator online"></div>
      </div>
      <div>
        <div id="hero_greet" class="text-2xl font-bold tracking-tight bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Welcome</div>
        <div id="hero_sub" class="text-sm opacity-75 mt-1 flex items-center gap-2">
          <span class="pulse-dot"></span>
          <span id="opportunities_count">‚Äî</span> high-priority opportunities ready for review
        </div>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <div class="quick-stats hidden md:flex items-center gap-4 px-4 py-2 bg-white/5 rounded-lg border border-white/10">
        <div class="stat-item">
          <div class="stat-value text-emerald-400" id="active_targets">‚Äî</div>
          <div class="stat-label">Active Targets</div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <div class="stat-value text-blue-400" id="win_rate">‚Äî%</div>
          <div class="stat-label">Win Rate</div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <div class="stat-value text-purple-400" id="avg_premium">‚Äî</div>
          <div class="stat-label">Avg Premium</div>
        </div>
      </div>
      <button id="btn_persona" class="quick-action primary hover-lift">
        <span class="icon">üéØ</span>
        Build Persona
      </button>
      <button id="btn_refresh_home" class="quick-action hover-lift">
        <span class="icon">üîÑ</span>
        Refresh
      </button>
    </div>
  </div>
  
  <!-- Real-time Activity Feed -->
  <div class="activity-ticker mt-4 p-3 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 rounded-lg border border-indigo-400/20">
    <div class="flex items-center gap-2">
      <div class="live-indicator">
        <span class="live-dot"></span>
        LIVE
      </div>
      <div id="activity_feed" class="flex-1 text-sm">
        <span class="opacity-75">Monitoring submissions in real-time...</span>
      </div>
    </div>
  </div>
  
  <script>
    (function(){
      // Seed quick stats from backend so they are factual on first paint
      window._dashboardMetrics = {
        targets: {{ tgt_ct|int }},
        winRate: {{ (avg_win*100)|round(0) if avg_win is defined else 0 }},
        avgPremium: {{ avg_premium|round(0) }},
        opportunities: {{ (tgt_ct + in_ct)|int }}
      };
      function greet(){
        const n = localStorage.getItem('USER_NAME') || '';
        const h = new Date().getHours();
        const g = h<12? 'Good morning' : h<18? 'Good afternoon' : 'Good evening';
        document.getElementById('hero_greet').textContent = n ? `${g}, ${n} üëã` : `${g} üëã`;
      }
      
      function updateQuickStats() {
        // This will be populated by the main script
        const metrics = window._dashboardMetrics || {};
        document.getElementById('active_targets').textContent = metrics.targets || '‚Äî';
        document.getElementById('win_rate').textContent = metrics.winRate ? Math.round(metrics.winRate) + '%' : '‚Äî%';
        document.getElementById('avg_premium').textContent = metrics.avgPremium ? '$' + Math.round(metrics.avgPremium/1000) + 'K' : '‚Äî';
        document.getElementById('opportunities_count').textContent = metrics.opportunities || '‚Äî';
      }
      
      function simulateActivityFeed() {
        const activities = [
          'üìã New submission from Acme Corp - $125K premium',
          'üéØ High-priority target identified in CA',
          '‚úÖ Submission #1234 moved to In-Appetite',
          'üìä Portfolio metrics updated',
          'üîÑ Data refresh completed'
        ];
        let currentIndex = 0;
        
        setInterval(() => {
          const feed = document.getElementById('activity_feed');
          if (feed) {
            feed.innerHTML = `<span class="text-indigo-300">${activities[currentIndex]}</span>`;
            currentIndex = (currentIndex + 1) % activities.length;
          }
        }, 3000);
      }
      
      greet();
      updateQuickStats();
      simulateActivityFeed();
      
      window.addEventListener('storage', (e) => {
        if(e.key === 'USER_NAME') greet();
      });
      document.getElementById('btn_persona')?.addEventListener('click', (e)=>{
        e.preventDefault();
        if(typeof _openPersona !== 'undefined') _openPersona();
      });
      greet(); vibe();
      window.addEventListener('storage', (e)=>{ if(e.key==='USER_NAME'||e.key==='VIBE'){ greet(); vibe(); }});
    })();
  </script>
</div>

<!-- Interactive Metrics Dashboard -->
<div class="metrics-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="metric-card-enhanced target-metric hover-lift" data-metric="target">
        <div class="metric-header">
            <div class="metric-icon target-icon">üéØ</div>
            {% set t = trend_target %}
            <div class="metric-trend {% if t>0 %}trend-up{% elif t<0 %}trend-down{% else %}trend-neutral{% endif %}">
                <span class="trend-icon">{% if t>0 %}‚Üó{% elif t<0 %}‚Üò{% else %}‚Üí{% endif %}</span>
                <span class="trend-value">{{ '%+d' % t }}%</span>
            </div>
        </div>
        <div class="metric-content">
            <div class="metric-value text-purple-400 animate-counter" data-target="{{ tgt_ct }}">0</div>
            <div class="metric-label">Target Opportunities</div>
            <div class="metric-subtitle">High priority submissions</div>
        </div>
        <div class="metric-progress">
            <div class="progress-bar bg-purple-500/30">
                <div class="progress-fill bg-purple-400" style="width: {{ pct_tgt }}%"></div>
            </div>
            <div class="progress-text">{{ pct_tgt }}% of submissions</div>
        </div>
    </div>
    
    <div class="metric-card-enhanced in-metric hover-lift" data-metric="in">
        <div class="metric-header">
            <div class="metric-icon in-icon">‚úÖ</div>
            {% set t = trend_in %}
            <div class="metric-trend {% if t>0 %}trend-up{% elif t<0 %}trend-down{% else %}trend-neutral{% endif %}">
                <span class="trend-icon">{% if t>0 %}‚Üó{% elif t<0 %}‚Üò{% else %}‚Üí{% endif %}</span>
                <span class="trend-value">{{ '%+d' % t }}%</span>
            </div>
        </div>
        <div class="metric-content">
            <div class="metric-value text-emerald-400 animate-counter" data-target="{{ in_ct }}">0</div>
            <div class="metric-label">In-Appetite</div>
            <div class="metric-subtitle">Ready for review</div>
        </div>
        <div class="metric-progress">
            <div class="progress-bar bg-emerald-500/30">
                <div class="progress-fill bg-emerald-400" style="width: {{ pct_in }}%"></div>
            </div>
            <div class="progress-text">{{ pct_in }}% of submissions</div>
        </div>
    </div>
    
    <div class="metric-card-enhanced total-metric hover-lift" data-metric="total">
        <div class="metric-header">
            <div class="metric-icon total-icon">üìä</div>
            {% set t = trend_total %}
            <div class="metric-trend {% if t>0 %}trend-up{% elif t<0 %}trend-down{% else %}trend-neutral{% endif %}">
                <span class="trend-icon">{% if t>0 %}‚Üó{% elif t<0 %}‚Üò{% else %}‚Üí{% endif %}</span>
                <span class="trend-value">{{ '%+d' % t }}%</span>
            </div>
        </div>
        <div class="metric-content">
            <div class="metric-value text-blue-400 animate-counter" data-target="{{ total }}">0</div>
            <div class="metric-label">Total Submissions</div>
            <div class="metric-subtitle">This period</div>
        </div>
        <div class="metric-progress">
            <div class="progress-bar bg-blue-500/30">
                <div class="progress-fill bg-blue-400" style="width: 100%"></div>
            </div>
            <div class="progress-text">Avg premium {{ avg_premium_str }}</div>
        </div>
    </div>
    
    <div class="metric-card-enhanced out-metric hover-lift" data-metric="out">
        <div class="metric-header">
            <div class="metric-icon out-icon">‚ùå</div>
            {% set t = trend_out %}
            <div class="metric-trend {% if t>0 %}trend-up{% elif t<0 %}trend-down{% else %}trend-neutral{% endif %}">
                <span class="trend-icon">{% if t>0 %}‚Üó{% elif t<0 %}‚Üò{% else %}‚Üí{% endif %}</span>
                <span class="trend-value">{{ '%+d' % t }}%</span>
            </div>
        </div>
        <div class="metric-content">
            <div class="metric-value text-rose-400 animate-counter" data-target="{{ out_ct }}">0</div>
            <div class="metric-label">Out-of-Appetite</div>
            <div class="metric-subtitle">Need attention</div>
        </div>
        <div class="metric-progress">
            <div class="progress-bar bg-rose-500/30">
                <div class="progress-fill bg-rose-400" style="width: {{ pct_out }}%"></div>
            </div>
            <div class="progress-text">{{ pct_out }}% of submissions</div>
        </div>
    </div>
</div>

<!-- Quick Actions Bar -->
<div class="quick-actions-bar glass-panel p-4 mb-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
            <h3 class="text-lg font-semibold">Quick Actions</h3>
            <span class="chip">Workflow shortcuts</span>
        </div>
        <button id="customize_actions" class="pill pill-sub hover-glow">Customize</button>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mt-4">
        <button class="action-button hover-lift" onclick="window.location.href='/submissions?status=TARGET'">
            <div class="action-icon">üéØ</div>
            <div class="action-label">Review Targets</div>
            <div class="action-count">{{ tgt_ct }}</div>
        </button>
        <button class="action-button hover-lift" onclick="exportOpportunities()">
            <div class="action-icon">üìä</div>
            <div class="action-label">Export Data</div>
            <div class="action-count">CSV/Excel</div>
        </button>
        <button class="action-button hover-lift" onclick="showBulkActions()">
            <div class="action-icon">‚ö°</div>
            <div class="action-label">Bulk Actions</div>
            <div class="action-count">Multi-edit</div>
        </button>
        <button class="action-button hover-lift" onclick="showAnalytics()">
            <div class="action-icon">üìà</div>
            <div class="action-label">Analytics</div>
            <div class="action-count">Deep dive</div>
        </button>
        <button class="action-button hover-lift" onclick="openCommandPalette()">
            <div class="action-icon">‚åò</div>
            <div class="action-label">Command</div>
            <div class="action-count">‚åòK</div>
        </button>
        <button class="action-button hover-lift" onclick="showHelp()">
            <div class="action-icon">‚ùì</div>
            <div class="action-label">Help</div>
            <div class="action-count">Guide</div>
        </button>
    </div>
</div>

<!-- Modern Workload Management -->
<div class="workload-section mb-6">
    <!-- Prioritized Submissions - Full Width -->
    <div class="w-full">
        <div class="workload-panel glass-panel">
            <div class="panel-header">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <span class="workload-icon">üìã</span>
                        Today's Priority Worklist
                    </h2>
                    <div class="mode-selector">
                        <label class="text-xs opacity-75">Analysis Mode</label>
                        <select id="home_mode" class="mode-select">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>
                <div class="panel-controls">
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="list">
                            <span class="icon">‚ò∞</span>
                            List
                        </button>
                        <button class="view-btn" data-view="cards">
                            <span class="icon">‚äû</span>
                            Cards
                        </button>
                        <button class="view-btn" data-view="kanban">
                            <span class="icon">‚ãØ</span>
                            Kanban
                        </button>
                    </div>
                    <button id="workload_settings" class="settings-btn">
                        <span class="icon">‚öô</span>
                    </button>
                </div>
            </div>
            
            <div class="workload-filters">
                <div class="filter-chips">
                    <button class="filter-chip active" data-filter="all">All</button>
                    <button class="filter-chip" data-filter="urgent">Urgent</button>
                    <button class="filter-chip" data-filter="due-today">Due Today</button>
                    <button class="filter-chip" data-filter="high-value">High Value</button>
                </div>
                <div class="sort-options">
                    <select id="sort_mode" class="sort-select">
                        <option value="priority">Priority Score</option>
                        <option value="premium">Premium Amount</option>
                        <option value="deadline">Deadline</option>
                        <option value="created">Date Created</option>
                    </select>
                </div>
            </div>
            
            <div id="worklist" class="worklist-content">
                <div class="loading-skeleton">
                    <div class="skeleton-item"></div>
                    <div class="skeleton-item"></div>
                    <div class="skeleton-item"></div>
                </div>
            </div>
            
            <!-- Workload Stats -->
            <div class="workload-stats">
                <div class="stat">
                    <span class="stat-label">Today's Focus</span>
                    <span class="stat-value" id="focus_count">‚Äî</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Completion Rate</span>
                    <span class="stat-value" id="completion_rate">‚Äî%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Avg Review Time</span>
                    <span class="stat-value" id="avg_time">‚Äîmin</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Accounts Table -->
<div class="accounts-table-section mt-6">
    <div class="accounts-panel glass-panel">
        <div class="table-header">
            <div class="table-header-left">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="table-icon">üìä</span>
                    Priority Account Review
                </h2>
                <div class="table-subtitle">
                    Top submissions ranked by appetite and urgency
                </div>
            </div>
            <div class="table-header-right">
                <div class="table-controls">
                    <button class="control-btn" id="table_filters">
                        <span class="icon">üîç</span>
                        Filters
                    </button>
                    <button class="control-btn" id="table_columns">
                        <span class="icon">‚öô</span>
                        Columns
                    </button>
                    <button class="control-btn" id="table_export">
                        <span class="icon">üì§</span>
                        Export
                    </button>
                </div>
                <a href="{{ url_for('submissions') }}" class="view-all-link">
                    View All Submissions ‚Üí
                </a>
            </div>
        </div>
        
        <div class="table-filters-bar hidden" id="filters_bar">
            <div class="filter-row">
                <select class="filter-select" id="status_filter">
                    <option value="">All Statuses</option>
                    <option value="TARGET">üéØ Target</option>
                    <option value="IN">‚úÖ In-Appetite</option>
                    <option value="OUT">‚ùå Out-of-Appetite</option>
                </select>
                <select class="filter-select" id="state_filter">
                    <option value="">All States</option>
                    <option value="CA">California</option>
                    <option value="FL">Florida</option>
                    <option value="TX">Texas</option>
                </select>
                <input type="text" class="filter-input" id="search_filter" placeholder="Search accounts...">
                <button class="filter-apply-btn">Apply</button>
                <button class="filter-clear-btn">Clear</button>
            </div>
        </div>
        
        <div class="table-container">
            <table class="modern-table">
                <thead class="table-head">
                    <tr>
                        <th class="th sortable" data-sort="account_name">
                            <div class="th-content">
                                <span>Account</span>
                                <span class="sort-icon">‚Üï</span>
                            </div>
                        </th>
                        <th class="th sortable" data-sort="appetite_status">
                            <div class="th-content">
                                <span>Status</span>
                                <span class="sort-icon">‚Üï</span>
                            </div>
                        </th>
                        <th class="th sortable" data-sort="total_premium">
                            <div class="th-content">
                                <span>Premium</span>
                                <span class="sort-icon">‚Üï</span>
                            </div>
                        </th>
                        <th class="th sortable" data-sort="primary_risk_state">
                            <div class="th-content">
                                <span>State</span>
                                <span class="sort-icon">‚Üï</span>
                            </div>
                        </th>
                        <th class="th sortable" data-sort="winnability">
                            <div class="th-content">
                                <span>Win %</span>
                                <span class="sort-icon">‚Üï</span>
                            </div>
                        </th>
                        <th class="th sortable" data-sort="mode_score">
                            <div class="th-content">
                                <span>Mode</span>
                                <span class="sort-icon">‚Üï</span>
                            </div>
                        </th>
                        <th class="th sortable" data-sort="priority_score">
                            <div class="th-content">
                                <span>Priority</span>
                                <span class="sort-icon">‚Üï</span>
                            </div>
                        </th>
                        <th class="th">Actions</th>
                    </tr>
                </thead>
                <tbody id="acct_body" class="table-body">
                    <!-- Loading skeleton -->
                    <tr class="loading-row">
                        <td colspan="8">
                            <div class="loading-content">
                                <div class="skeleton-row" style="width: 100%; height: 3rem;"></div>
                                <div class="skeleton-row" style="width: 95%; height: 2.5rem;"></div>
                                <div class="skeleton-row" style="width: 98%; height: 2.5rem;"></div>
                                <div class="skeleton-row" style="width: 92%; height: 2.5rem;"></div>
                                <div class="skeleton-row" style="width: 97%; height: 2.5rem;"></div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="table-footer">
            <div class="table-info">
                <span id="results_count">Loading...</span> ‚Ä¢
                <span id="last_updated">‚Äî</span>
            </div>
            <div class="table-pagination">
                <button class="pagination-btn" id="prev_page" disabled>Previous</button>
                <span class="pagination-info">Page 1 of 1</span>
                <button class="pagination-btn" id="next_page" disabled>Next</button>
            </div>
        </div>
    </div>
</div>

<!-- Command Palette -->
<div id="command_palette" class="command-palette hidden">
    <div class="command-overlay"></div>
    <div class="command-container">
        <div class="command-input-section">
            <span class="command-icon">‚åò</span>
            <input type="text" id="command_input" class="command-input" placeholder="Type a command or search...">
            <kbd class="command-shortcut">ESC</kbd>
        </div>
        <div class="command-results" id="command_results">
            <div class="command-group">
                <div class="command-group-title">Quick Actions</div>
                <div class="command-item" data-action="goto-targets">
                    <span class="command-item-icon">üéØ</span>
                    <span class="command-item-text">Review Target Opportunities</span>
                    <span class="command-item-shortcut">‚åòT</span>
                </div>
                <div class="command-item" data-action="export-data">
                    <span class="command-item-icon">üìä</span>
                    <span class="command-item-text">Export Current Data</span>
                    <span class="command-item-shortcut">‚åòE</span>
                </div>
                <div class="command-item" data-action="refresh-data">
                    <span class="command-item-icon">üîÑ</span>
                    <span class="command-item-text">Refresh Dashboard</span>
                    <span class="command-item-shortcut">‚åòR</span>
                </div>
            </div>
            <div class="command-group">
                <div class="command-group-title">Navigation</div>
                <div class="command-item" data-action="goto-submissions">
                    <span class="command-item-icon">üìã</span>
                    <span class="command-item-text">Go to Submissions</span>
                </div>
                <div class="command-item" data-action="goto-insights">
                    <span class="command-item-icon">üìà</span>
                    <span class="command-item-text">Portfolio Insights</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Persona Modal: removed (use global in base.html) -->

<script>
    // Ensure utility functions are available (fallback if app.js hasn't loaded yet)
    if (typeof window.fetchJSON === 'undefined') {
        window.fetchJSON = async function(url, opts={}){
            const res = await fetch(url, opts);
            if(!res.ok){
                let msg = `${res.status} ${res.statusText}`;
                try { const j = await res.json(); if(j && j.error) msg = j.error; } catch (e) {}
                throw new Error(msg);
            }
            return res.json();
        }
    }
    
    if (typeof window.withLoading === 'undefined') {
        window.withLoading = async function(el, fn){
            try{ el?.classList?.add("is-loading"); return await fn(); } finally { el?.classList?.remove("is-loading"); }
        }
    }
    
    if (typeof window.toast === 'undefined') {
        window.toast = function(msg, type = "info") {
            const host = document.getElementById("toasts") || (function(){
                const d = document.createElement("div");
                d.id = "toasts"; d.className = "toasts"; document.body.appendChild(d); return d;
            })();
            const el = document.createElement("div");
            el.className = `toast ${type}`;
            el.textContent = msg;
            host.appendChild(el);
            setTimeout(()=>{ el.classList.add("out"); setTimeout(()=>host.removeChild(el), 200); }, 2800);
        }
    }
    
    let ALL = [];

    function getActiveMode() {
        return localStorage.getItem("ACTIVE_MODE") || "balanced_growth";
    }
    function setActiveMode(m) {
        localStorage.setItem("ACTIVE_MODE", m);
    }

    function prettyMode(name){
        const s = String(name || "");
        return s.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
    }
    function updateModeChip(){
        const mode = getActiveMode();
        const at = localStorage.getItem("LAST_REFINED_AT");
        const mch = document.getElementById("mode_chip");
        if (mch) {
            mch.textContent = at && mode === 'custom' ? `Mode: ${prettyMode(mode)} ¬∑ ${at}` : `Mode: ${prettyMode(mode)}`;
        }
    }
    function updateLastUpdated(elId){
        const el = document.getElementById(elId);
        if(!el) return;
        const d = new Date();
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        el.textContent = `Last updated ${hh}:${mm}`;
    }

    // Worklist view state helpers
    function getWorklistView(){
        try { return localStorage.getItem('WORKLIST_VIEW') || 'list'; } catch(e){ return 'list'; }
    }
    function setWorklistView(v){
        try { localStorage.setItem('WORKLIST_VIEW', v); } catch(e){}
        // reflect active state on buttons if present
        document.querySelectorAll('.view-btn').forEach(b=>{
            b.classList.toggle('active', b.dataset.view===v);
        });
    }

    async function loadHome() {
        const el = document.getElementById("worklist");
        if (!el) return;
        await withLoading(el, async () => {
            const sel = document.getElementById("home_mode");
            const mode = (sel?.value && sel.value !== "") ? sel.value : getActiveMode();
            const j = await fetchJSON(`/api/classified_mode?mode=${encodeURIComponent(mode)}`);
            // Fallback if custom yields no rows
            if ((j.count || 0) === 0 && mode === "custom") {
                const last = localStorage.getItem("LAST_NON_EMPTY_MODE") || "balanced_growth";
                toast("Custom mode empty ‚Äî showing " + last, "error");
                setActiveMode(last);
                if (sel) sel.value = last;
                const jj = await fetchJSON(`/api/classified_mode?mode=${encodeURIComponent(last)}`);
                renderWorklistRows(jj.data || [], last);
                return;
            }
            if ((j.count || 0) > 0) {
                localStorage.setItem("LAST_NON_EMPTY_MODE", mode);
            }
            // cache rows so view toggle can re-render without refetch
            window._worklistRows = j.data || [];
            renderWorklistRows(window._worklistRows, mode);
            updateModeChip();
            updateLastUpdated('worklist_last');
        });
    }

    function renderWorklistRows(rows, mode) {
        const el = document.getElementById("worklist");
        if (!el) return;
        const view = getWorklistView();
        const top = (rows || []).slice(0, 8);
        // If empty, show the helper banner regardless of view
        if (!top.length) return renderWorklistEmpty();

        if (view === 'list') return renderWorklistList(top, mode);
        if (view === 'cards') return renderWorklistCards(top, mode);
        return renderWorklistKanban(rows || [], mode);
    }

    function badge(s) {
        if (s === "TARGET") return `<span class="pill pill-indigo">Target</span>`;
        if (s === "IN") return `<span class="pill pill-emerald">In</span>`;
        return `<span class="pill pill-rose">Out</span>`;
    }
    function renderWorklistEmpty(){
        const el = document.getElementById('worklist');
        if(!el) return;
        el.innerHTML = `
            <div class="glass p-4 rounded-lg border border-dashed border-slate-600">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold">No results for current mode</div>
                  <div class="text-xs opacity-80">Try Balanced Growth or relax filters (+0.1 LR, +20% premium band)</div>
                </div>
                <div class="flex items-center gap-2">
                  <button id="btn_switch_bal" class="pill pill-sub">Switch to Balanced Growth</button>
                  <button id="btn_relax" class="pill pill-sub">Relax Filters</button>
                </div>
              </div>
            </div>`;
        document.getElementById('btn_switch_bal')?.addEventListener('click', () => {
            setActiveMode('balanced_growth');
            const sel = document.getElementById('home_mode');
            if (sel) sel.value = 'balanced_growth';
            loadHome();
            toast('Switched to Balanced Growth mode', 'success');
        });
        document.getElementById('btn_relax')?.addEventListener('click', () => {
            toast('Relaxing filter criteria...', 'info');
            const currentMode = getActiveMode();
            localStorage.setItem('LAST_STRICT_MODE', currentMode);
            setActiveMode('loose_fits');
            const sel = document.getElementById('home_mode');
            if (sel) sel.value = 'loose_fits';
            loadHome().then(()=> toast('Filters relaxed - showing broader results', 'success'))
                     .catch(()=> toast('Could not relax filters', 'error'));
        });
    }

    function renderWorklistList(rows, mode){
        const el = document.getElementById('worklist');
        el.innerHTML = rows.map(r => `
            <a href="/detail/${r.id}?mode=${encodeURIComponent(mode)}" class="row">
              <div class="row-main">
                <div class="row-title">${r.account_name || "-"}</div>
                <div class="row-sub">${r.primary_risk_state || "-"} ¬∑ ${r.line_of_business || "-"} ¬∑ $${Math.round(r.total_premium || 0).toLocaleString()}</div>
              </div>
              <div class="row-badges">
                ${badge(r.appetite_status)}
                <span class="chip">Score ${Number(r.priority_score || 0).toFixed(2)}</span>
              </div>
            </a>
        `).join("");
    }

    function renderWorklistCards(rows, mode){
        const el = document.getElementById('worklist');
        el.innerHTML = `
          <div class="worklist-cards">${rows.map(r => `
            <a href="/detail/${r.id}?mode=${encodeURIComponent(mode)}" class="work-card ${r.appetite_status?.toLowerCase() || ''}">
              <div class="work-card-head">
                <div class="work-card-title">${r.account_name || '-'}</div>
                <div class="work-card-badges">${badge(r.appetite_status)}</div>
              </div>
              <div class="work-card-sub">${r.primary_risk_state || '-'} ¬∑ ${r.line_of_business || '-'} </div>
              <div class="work-card-meta">
                <span>$${Math.round(r.total_premium || 0).toLocaleString()} premium</span>
                <span>Score ${Number(r.priority_score || 0).toFixed(2)}</span>
              </div>
            </a>`).join('')}
          </div>`;
    }

    function renderWorklistKanban(rows, mode){
        const el = document.getElementById('worklist');
        // group by appetite_status
        const groups = { TARGET: [], IN: [], OUT: [] };
        rows.forEach(r=>{ (groups[r.appetite_status]||groups.OUT).push(r); });
        // sort each group by priority_score desc and take top 8 across columns
        Object.keys(groups).forEach(k=> groups[k] = groups[k].sort((a,b)=> (b.priority_score||0)-(a.priority_score||0)).slice(0,8));
        const col = (k,label,emoji)=>`
          <div class="kanban-col">
            <div class="kanban-header">
              <div class="kanban-title">${emoji} ${label}</div>
              <div class="kanban-count">${groups[k].length}</div>
            </div>
            <div class="kanban-items">
              ${groups[k].map(r=>`
                <a href="/detail/${r.id}?mode=${encodeURIComponent(mode)}" class="kanban-card">
                  <div class="k-title">${r.account_name || '-'}</div>
                  <div class="k-sub">${r.primary_risk_state || '-'} ¬∑ ${r.line_of_business || '-'}</div>
                  <div class="k-meta">
                    <span>$${Math.round(r.total_premium || 0).toLocaleString()}</span>
                    <span>Score ${Number(r.priority_score || 0).toFixed(1)}</span>
                  </div>
                </a>`).join('')}
            </div>
          </div>`;
        el.innerHTML = `<div class="kanban-board">${
            col('TARGET','Target','üéØ') + col('IN','In-Appetite','‚úÖ') + col('OUT','Out','‚ùå')
        }</div>`;
    }

    // Priority Accounts functionality
    let PRIORITY_ACCOUNTS_DATA = [];
    let PRIORITY_ACCOUNTS_PAGINATION = {
        page: 1,
        per_page: 20,
        total_count: 0,
        total_pages: 1,
        has_next: false,
        has_prev: false
    };
    let PRIORITY_ACCOUNTS_FILTERS = {
        state: '',
        status: '',
        min_premium: null,
        max_premium: null,
        search: '',
        sort_by: 'priority_score',
        sort_dir: 'desc'
    };

    async function loadPriorityAccounts(page = 1) {
        const tbody = document.getElementById("acct_body");
        if (!tbody) return;

        try {
            // Build query parameters
            const params = new URLSearchParams({
                page: page,
                per_page: PRIORITY_ACCOUNTS_PAGINATION.per_page,
                sort_by: PRIORITY_ACCOUNTS_FILTERS.sort_by,
                sort_dir: PRIORITY_ACCOUNTS_FILTERS.sort_dir
            });

            // Add filters if they exist
            if (PRIORITY_ACCOUNTS_FILTERS.state) params.append('state', PRIORITY_ACCOUNTS_FILTERS.state);
            if (PRIORITY_ACCOUNTS_FILTERS.status) params.append('status', PRIORITY_ACCOUNTS_FILTERS.status);
            if (PRIORITY_ACCOUNTS_FILTERS.min_premium) params.append('min_premium', PRIORITY_ACCOUNTS_FILTERS.min_premium);
            if (PRIORITY_ACCOUNTS_FILTERS.max_premium) params.append('max_premium', PRIORITY_ACCOUNTS_FILTERS.max_premium);
            if (PRIORITY_ACCOUNTS_FILTERS.search) params.append('q', PRIORITY_ACCOUNTS_FILTERS.search);

            // Show loading
            tbody.innerHTML = `
                <tr class="loading-row">
                    <td colspan="8">
                        <div class="loading-content">
                            <div class="skeleton-row" style="width: 100%; height: 3rem;"></div>
                            <div class="skeleton-row" style="width: 95%; height: 2.5rem;"></div>
                            <div class="skeleton-row" style="width: 98%; height: 2.5rem;"></div>
                            <div class="skeleton-row" style="width: 92%; height: 2.5rem;"></div>
                            <div class="skeleton-row" style="width: 97%; height: 2.5rem;"></div>
                        </div>
                    </td>
                </tr>
            `;

            // Fetch data
            const response = await fetchJSON(`/api/priority-accounts?${params}`);
            
            PRIORITY_ACCOUNTS_DATA = response.data || [];
            PRIORITY_ACCOUNTS_PAGINATION = response.pagination || PRIORITY_ACCOUNTS_PAGINATION;
            
            // Render table
            renderPriorityAccountsTable();
            
            // Update pagination controls
            updatePriorityAccountsPagination();
            
            // Update results count
            updatePriorityAccountsCount();
            
        } catch (error) {
            console.error('Error loading priority accounts:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-red-400 py-8">
                        <div class="flex flex-col items-center gap-2">
                            <span class="text-2xl">‚ö†Ô∏è</span>
                            <span>Failed to load priority accounts</span>
                            <button onclick="loadPriorityAccounts(1)" class="text-blue-400 hover:text-blue-300">
                                Try Again
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    function renderPriorityAccountsTable() {
        const tbody = document.getElementById("acct_body");
        if (!tbody) return;

        if (!PRIORITY_ACCOUNTS_DATA.length) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-gray-400 py-8">
                        <div class="flex flex-col items-center gap-2">
                            <span class="text-3xl">üéØ</span>
                            <span class="text-lg">No priority accounts found</span>
                            <span class="text-sm opacity-75">Try adjusting your filters</span>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        const rows = PRIORITY_ACCOUNTS_DATA.map(account => {
            const statusEmoji = account.appetite_status === 'TARGET' ? 'üéØ' : 
                               account.appetite_status === 'IN' ? '‚úÖ' : '‚ùå';
            const statusClass = account.appetite_status === 'TARGET' ? 'text-purple-400' : 
                               account.appetite_status === 'IN' ? 'text-green-400' : 'text-red-400';
            
            const priorityClass = account.priority_score >= 7 ? 'priority-high' : 
                                account.priority_score >= 4 ? 'priority-medium' : 'priority-low';
            
            const premiumFormatted = account.total_premium ? 
                new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 })
                    .format(account.total_premium) : '‚Äî';

            return `
                <tr class="table-row hover:bg-white/5 transition-all duration-200" data-account-id="${account.id}">
                    <td class="table-cell">
                        <div class="flex flex-col">
                            <span class="font-medium text-white">${account.account_name || '‚Äî'}</span>
                            <span class="text-sm text-gray-400">${account.line_of_business || '‚Äî'}</span>
                        </div>
                    </td>
                    <td class="table-cell">
                        <span class="status-badge ${statusClass} bg-opacity-20 px-2 py-1 rounded-md text-xs font-medium">
                            ${statusEmoji} ${account.appetite_status}
                        </span>
                    </td>
                    <td class="table-cell">
                        <span class="font-mono text-emerald-400">${premiumFormatted}</span>
                    </td>
                    <td class="table-cell">
                        <span class="px-2 py-1 bg-gray-700 rounded text-xs font-medium">
                            ${account.primary_risk_state || '‚Äî'}
                        </span>
                    </td>
                    <td class="table-cell">
                        <span class="font-medium">${Math.round(account.winnability * 100)}%</span>
                    </td>
                    <td class="table-cell">
                        <span class="font-medium">${account.mode_score.toFixed(1)}</span>
                    </td>
                    <td class="table-cell">
                        <span class="priority-score ${priorityClass} px-2 py-1 rounded-md text-xs font-bold">
                            ${account.priority_score.toFixed(1)}
                        </span>
                    </td>
                    <td class="table-cell">
                        <div class="flex gap-2">
                            <button 
                                onclick="viewAccountDetail(${account.id})" 
                                class="action-btn bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded transition-colors"
                                title="View Details">
                                View
                            </button>
                            <button 
                                onclick="explainAccount(${account.id})" 
                                class="action-btn bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded transition-colors"
                                title="AI Explanation">
                                Explain
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rows;
    }

    function updatePriorityAccountsPagination() {
        const paginationInfo = document.querySelector('.pagination-info');
        const prevBtn = document.getElementById('prev_page');
        const nextBtn = document.getElementById('next_page');
        
        if (paginationInfo) {
            paginationInfo.textContent = `Page ${PRIORITY_ACCOUNTS_PAGINATION.page} of ${PRIORITY_ACCOUNTS_PAGINATION.total_pages}`;
        }
        
        if (prevBtn) {
            prevBtn.disabled = !PRIORITY_ACCOUNTS_PAGINATION.has_prev;
            prevBtn.onclick = () => {
                if (PRIORITY_ACCOUNTS_PAGINATION.has_prev) {
                    loadPriorityAccounts(PRIORITY_ACCOUNTS_PAGINATION.page - 1);
                }
            };
        }
        
        if (nextBtn) {
            nextBtn.disabled = !PRIORITY_ACCOUNTS_PAGINATION.has_next;
            nextBtn.onclick = () => {
                if (PRIORITY_ACCOUNTS_PAGINATION.has_next) {
                    loadPriorityAccounts(PRIORITY_ACCOUNTS_PAGINATION.page + 1);
                }
            };
        }
    }

    function updatePriorityAccountsCount() {
        const resultsCount = document.getElementById('results_count');
        const lastUpdated = document.getElementById('last_updated');
        
        if (resultsCount) {
            resultsCount.textContent = `${PRIORITY_ACCOUNTS_PAGINATION.total_count} priority accounts`;
        }
        
        if (lastUpdated) {
            lastUpdated.textContent = `Updated ${new Date().toLocaleTimeString()}`;
        }
    }

    // Priority account actions
    function viewAccountDetail(accountId) {
        window.location.href = `/detail/${accountId}`;
    }

    function explainAccount(accountId) {
        // Find the account data
        const account = PRIORITY_ACCOUNTS_DATA.find(a => a.id === accountId);
        if (!account) return;
        
        toast(`Explaining account "${account.account_name}"...`, 'info');
        
        fetchJSON(`/api/explain/${accountId}`, { method: 'POST' })
            .then(response => {
                if (response.explanation) {
                    showAccountExplanationModal(account, response.explanation);
                } else {
                    toast('No explanation available', 'warning');
                }
            })
            .catch(error => {
                console.error('Error explaining account:', error);
                toast('Failed to get explanation', 'error');
            });
    }

    function showAccountExplanationModal(account, explanation) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-lg p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-white">Account Explanation</h3>
                        <p class="text-gray-400">${account.account_name}</p>
                    </div>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                        ‚úï
                    </button>
                </div>
                <div class="prose prose-invert max-w-none">
                    <p class="text-gray-300">${explanation}</p>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded transition-colors">
                        Close
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Enhanced utility functions for modern UI
    function exportOpportunities() {
        const modal = createExportModal();
        document.body.appendChild(modal);
    }

    function showBulkActions() {
        const modal = createBulkActionsModal();
        document.body.appendChild(modal);
    }

    function showAnalytics() {
        window.location.href = '/insights';
    }
    
    function openCommandPalette() {
        const palette = document.getElementById('command_palette');
        const input = document.getElementById('command_input');
        if (palette) {
            palette.classList.remove('hidden');
            input.focus();
        }
    }
    
    function showHelp() {
        const modal = createHelpModal();
        document.body.appendChild(modal);
    }
    
    // Modern modal creators
    function createExportModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 export-modal';
        modal.innerHTML = `
            <div class="glass-panel max-w-md mx-4 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <span>üìä</span>
                        Export Data
                    </h3>
                    <button class="close-modal text-2xl hover:text-red-400">√ó</button>
                </div>
                <div class="space-y-4">
                    <div class="export-option active" data-format="csv">
                        <span class="option-icon">üìÑ</span>
                        <span class="option-text">CSV Spreadsheet</span>
                        <span class="option-desc">For Excel analysis</span>
                    </div>
                    <div class="export-option" data-format="excel">
                        <span class="option-icon">üìä</span>
                        <span class="option-text">Excel Workbook</span>
                        <span class="option-desc">With charts and formatting</span>
                    </div>
                    <div class="export-option" data-format="pdf">
                        <span class="option-icon">üìã</span>
                        <span class="option-text">PDF Report</span>
                        <span class="option-desc">Executive summary</span>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button class="btn-cancel close-modal">Cancel</button>
                    <button class="btn-primary" onclick="performExport()">Export</button>
                </div>
            </div>
        `;
        
        modal.querySelectorAll('.close-modal').forEach(btn => {
            btn.onclick = () => modal.remove();
        });
        
        modal.querySelectorAll('.export-option').forEach(option => {
            option.onclick = () => {
                modal.querySelectorAll('.export-option').forEach(o => o.classList.remove('active'));
                option.classList.add('active');
            };
        });
        
        return modal;
    }
    
    function createBulkActionsModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 bulk-modal';
        modal.innerHTML = `
            <div class="glass-panel max-w-lg mx-4 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <span>‚ö°</span>
                        Bulk Actions
                    </h3>
                    <button class="close-modal text-2xl hover:text-red-400">√ó</button>
                </div>
                <div class="bulk-actions-grid">
                    <button class="bulk-action-btn">
                        <span class="action-icon">‚úÖ</span>
                        <span class="action-text">Mark as Reviewed</span>
                    </button>
                    <button class="bulk-action-btn">
                        <span class="action-icon">üéØ</span>
                        <span class="action-text">Add to Targets</span>
                    </button>
                    <button class="bulk-action-btn">
                        <span class="action-icon">üìß</span>
                        <span class="action-text">Send Notifications</span>
                    </button>
                    <button class="bulk-action-btn">
                        <span class="action-icon">üìä</span>
                        <span class="action-text">Generate Reports</span>
                    </button>
                    <button class="bulk-action-btn">
                        <span class="action-icon">üè∑Ô∏è</span>
                        <span class="action-text">Apply Tags</span>
                    </button>
                    <button class="bulk-action-btn">
                        <span class="action-icon">üóÇÔ∏è</span>
                        <span class="action-text">Archive Items</span>
                    </button>
                </div>
                <div class="flex justify-end mt-6">
                    <button class="btn-cancel close-modal">Close</button>
                </div>
            </div>
        `;
        
        modal.querySelectorAll('.close-modal').forEach(btn => {
            btn.onclick = () => modal.remove();
        });
        
        modal.querySelectorAll('.bulk-action-btn').forEach(btn => {
            btn.onclick = () => {
                toast('Bulk action executed', 'success');
                modal.remove();
            };
        });
        
        return modal;
    }
    
    function createHelpModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 help-modal';
        modal.innerHTML = `
            <div class="glass-panel max-w-2xl mx-4 p-6 max-h-[80vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <span>‚ùì</span>
                        Help & Shortcuts
                    </h3>
                    <button class="close-modal text-2xl hover:text-red-400">√ó</button>
                </div>
                <div class="help-content space-y-6">
                    <div class="help-section">
                        <h4 class="font-semibold mb-2">Keyboard Shortcuts</h4>
                        <div class="shortcut-list">
                            <div class="shortcut-item">
                                <kbd>‚åòK</kbd>
                                <span>Open command palette</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>‚åòT</kbd>
                                <span>View target opportunities</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>‚åòE</kbd>
                                <span>Export data</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>‚åòR</kbd>
                                <span>Refresh dashboard</span>
                            </div>
                        </div>
                    </div>
                    <div class="help-section">
                        <h4 class="font-semibold mb-2">Dashboard Features</h4>
                        <ul class="feature-list">
                            <li>üéØ Priority scoring based on appetite and winnability</li>
                            <li>üìä Real-time portfolio analytics</li>
                            <li>üîç Smart filtering and search</li>
                            <li>üìà Performance goal tracking</li>
                            <li>ü§ñ AI-powered insights</li>
                        </ul>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button class="btn-primary close-modal">Got it</button>
                </div>
            </div>
        `;
        
        modal.querySelectorAll('.close-modal').forEach(btn => {
            btn.onclick = () => modal.remove();
        });
        
        return modal;
    }
    
    function createWorkloadSettingsModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 workload-settings-modal';
        modal.innerHTML = `
            <div class="glass-panel max-w-lg mx-4 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <span>‚öôÔ∏è</span>
                        Workload Settings
                    </h3>
                    <button class="close-modal text-2xl hover:text-red-400">√ó</button>
                </div>
                <div class="space-y-4">
                    <div class="setting-group">
                        <label class="setting-label">Items per page</label>
                        <select class="setting-select" id="items_per_page">
                            <option value="5">5 items</option>
                            <option value="10" selected>10 items</option>
                            <option value="15">15 items</option>
                            <option value="20">20 items</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Auto-refresh interval</label>
                        <select class="setting-select" id="refresh_interval">
                            <option value="30">30 seconds</option>
                            <option value="45" selected>45 seconds</option>
                            <option value="60">1 minute</option>
                            <option value="120">2 minutes</option>
                            <option value="0">Disabled</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="show_priorities" checked class="setting-checkbox">
                            <span>Show priority scores</span>
                        </label>
                    </div>
                    <div class="setting-group">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="compact_view" class="setting-checkbox">
                            <span>Compact view</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button class="btn-cancel close-modal">Cancel</button>
                    <button class="btn-primary" onclick="applyWorkloadSettings()">Apply</button>
                </div>
            </div>
        `;
        
        modal.querySelectorAll('.close-modal').forEach(btn => {
            btn.onclick = () => modal.remove();
        });
        
        // Load current settings
        document.getElementById('items_per_page').value = localStorage.getItem('workload_items_per_page') || '10';
        document.getElementById('refresh_interval').value = localStorage.getItem('workload_refresh_interval') || '45';
        document.getElementById('show_priorities').checked = localStorage.getItem('workload_show_priorities') !== 'false';
        document.getElementById('compact_view').checked = localStorage.getItem('workload_compact_view') === 'true';
        
        return modal;
    }
    
    function applyWorkloadSettings() {
        const itemsPerPage = document.getElementById('items_per_page').value;
        const refreshInterval = document.getElementById('refresh_interval').value;
        const showPriorities = document.getElementById('show_priorities').checked;
        const compactView = document.getElementById('compact_view').checked;
        
        localStorage.setItem('workload_items_per_page', itemsPerPage);
        localStorage.setItem('workload_refresh_interval', refreshInterval);
        localStorage.setItem('workload_show_priorities', showPriorities);
        localStorage.setItem('workload_compact_view', compactView);
        
        toast('Workload settings saved', 'success');
        document.querySelector('.workload-settings-modal')?.remove();
        
        // Reload workload with new settings
        loadHome();
    }
    
    function performExport() {
        const activeFormat = document.querySelector('.export-option.active')?.dataset.format || 'csv';
        toast(`Exporting as ${activeFormat.toUpperCase()}...`, 'info');
        
        // Simulate export
        setTimeout(() => {
            toast(`Export completed: portfolio_data.${activeFormat}`, 'success');
            document.querySelector('.export-modal')?.remove();
        }, 2000);
    }

    async function populateHomeModes() {
        try {
            const j = await fetchJSON('/api/modes');
            const sel = document.getElementById('home_mode');
            if (sel && j && Array.isArray(j)) {
                // Add placeholder option first
                const options = ['<option value="" disabled selected>Mode</option>'];
                options.push(...j.map(m => `<option value="${m.key}">${m.label}</option>`));
                sel.innerHTML = options.join('');
                // Don't set a default value - let the placeholder show
            }
        } catch (e) {
            console.error('Failed to load modes:', e);
        }
    }

    // Event handlers
    const refreshBtn = document.getElementById("btn_refresh_home");
    if (refreshBtn) {
        refreshBtn.onclick = () => {
            fetchJSON("/api/refresh", { method: "POST" })
                .then(() => {
                    toast("Data refreshed", "success");
                    loadHome();
                })
                .catch((err) => toast("Refresh failed: " + err.message, "error"));
        };
    }

    // Workload settings button
    const workloadSettingsBtn = document.getElementById("workload_settings");
    if (workloadSettingsBtn) {
        workloadSettingsBtn.onclick = () => {
            const modal = createWorkloadSettingsModal();
            document.body.appendChild(modal);
        };
    }

    const modeSelect = document.getElementById('home_mode');
    if (modeSelect) {
        modeSelect.addEventListener('change', (e) => {
            if (e.target.value && e.target.value !== "") {
                setActiveMode(e.target.value);
                updateModeChip();
                loadHome();
            }
        });
    }

    // Initialize page
    populateHomeModes().then(() => {
        loadHome();
        loadPriorityAccounts(); // Load priority accounts table
        updateModeChip();
    }).catch(() => {
        loadHome();
        loadPriorityAccounts(); // Load priority accounts table even if modes fail
        updateModeChip();
    });

    // Priority Accounts Filter Controls
    function setupPriorityAccountsFilters() {
        // Table filter toggle
        const filtersBtn = document.getElementById('table_filters');
        const filtersBar = document.getElementById('filters_bar');
        if (filtersBtn && filtersBar) {
            filtersBtn.addEventListener('click', () => {
                filtersBar.classList.toggle('hidden');
            });
        }

        // Filter controls
        const statusFilter = document.getElementById('status_filter');
        const stateFilter = document.getElementById('state_filter');
        const searchFilter = document.getElementById('search_filter');
        const applyBtn = document.querySelector('.filter-apply-btn');
        const clearBtn = document.querySelector('.filter-clear-btn');

        if (applyBtn) {
            applyBtn.addEventListener('click', () => {
                PRIORITY_ACCOUNTS_FILTERS.status = statusFilter?.value || '';
                PRIORITY_ACCOUNTS_FILTERS.state = stateFilter?.value || '';
                PRIORITY_ACCOUNTS_FILTERS.search = searchFilter?.value || '';
                loadPriorityAccounts(1); // Reset to first page
            });
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                PRIORITY_ACCOUNTS_FILTERS = {
                    state: '',
                    status: '',
                    min_premium: null,
                    max_premium: null,
                    search: '',
                    sort_by: 'priority_score',
                    sort_dir: 'desc'
                };
                if (statusFilter) statusFilter.value = '';
                if (stateFilter) stateFilter.value = '';
                if (searchFilter) searchFilter.value = '';
                loadPriorityAccounts(1);
            });
        }

        // Search on Enter key
        if (searchFilter) {
            searchFilter.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    PRIORITY_ACCOUNTS_FILTERS.search = searchFilter.value || '';
                    loadPriorityAccounts(1);
                }
            });
        }

        // Table sorting
        document.querySelectorAll('.table-head .sortable').forEach(th => {
            th.addEventListener('click', () => {
                const sortKey = th.dataset.sort;
                if (!sortKey) return;

                // Toggle sort direction if same column
                if (PRIORITY_ACCOUNTS_FILTERS.sort_by === sortKey) {
                    PRIORITY_ACCOUNTS_FILTERS.sort_dir = PRIORITY_ACCOUNTS_FILTERS.sort_dir === 'desc' ? 'asc' : 'desc';
                } else {
                    PRIORITY_ACCOUNTS_FILTERS.sort_by = sortKey;
                    PRIORITY_ACCOUNTS_FILTERS.sort_dir = 'desc'; // Default to desc for new column
                }

                // Update sort indicators
                document.querySelectorAll('.table-head .sort-icon').forEach(icon => {
                    icon.textContent = '‚Üï';
                });
                
                const sortIcon = th.querySelector('.sort-icon');
                if (sortIcon) {
                    sortIcon.textContent = PRIORITY_ACCOUNTS_FILTERS.sort_dir === 'desc' ? '‚Üì' : '‚Üë';
                }

                loadPriorityAccounts(1);
            });
        });
    }

    // Call setup after DOM is ready
    setTimeout(setupPriorityAccountsFilters, 100);

    // Legacy persona functions for compatibility
    function gatherAnswers() {
        const con = document.getElementById("ans_con_list")?.value || "";
        const ans = {
            aggressiveness: Number(document.getElementById("ans_aggr")?.value || 5),
            objective: document.getElementById("ans_obj")?.value || "balance",
            premium_lo: Number(document.getElementById("ans_prem_lo")?.value || 75000),
            premium_hi: Number(document.getElementById("ans_prem_hi")?.value || 1500000),
            max_lr: Number(document.getElementById("ans_lr")?.value || 0.65),
            tiv_max: Number(document.getElementById("ans_tiv")?.value || 150000000),
            new_only: !!document.getElementById("ans_new_only")?.checked,
            strict_construction: !!document.getElementById("ans_good_con")?.checked,
            construction_pref: con ? con.split(',').map(s => s.trim()).filter(Boolean) : [],
            comments: document.getElementById("ans_comments")?.value || "",
        };
        try { localStorage.setItem('personaAnswers', JSON.stringify(ans)); } catch (e) {}
        return ans;
    }

    // Enhanced keyboard shortcuts and command palette
    document.addEventListener('keydown', (e) => {
        // Command/Ctrl key combinations
        if (e.metaKey || e.ctrlKey) {
            switch(e.key) {
                case 'k':
                    e.preventDefault();
                    openCommandPalette();
                    break;
                case 't':
                    e.preventDefault();
                    window.location.href = '/submissions?status=TARGET';
                    break;
                case 'e':
                    e.preventDefault();
                    exportOpportunities();
                    break;
                case 'r':
                    e.preventDefault();
                    fetchJSON("/api/refresh", { method: "POST" })
                        .then(() => {
                            toast("Data refreshed", "success");
                            loadHome();
                        })
                        .catch((err) => toast("Refresh failed: " + err.message, "error"));
                    break;
            }
        }
        
        // ESC key to close command palette
        if (e.key === 'Escape') {
            const palette = document.getElementById('command_palette');
            if (palette && !palette.classList.contains('hidden')) {
                palette.classList.add('hidden');
            }
        }
    });
    
    // Command palette functionality
    function setupCommandPalette() {
        const input = document.getElementById('command_input');
        const results = document.getElementById('command_results');
        
        if (!input || !results) return;
        
        input.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            filterCommandResults(query);
        });
        
        // Handle command execution
        results.addEventListener('click', (e) => {
            const item = e.target.closest('.command-item');
            if (item) {
                const action = item.dataset.action;
                executeCommand(action);
                document.getElementById('command_palette').classList.add('hidden');
                input.value = '';
            }
        });
    }
    
    function filterCommandResults(query) {
        const items = document.querySelectorAll('.command-item');
        items.forEach(item => {
            const text = item.querySelector('.command-item-text').textContent.toLowerCase();
            const visible = text.includes(query) || query === '';
            item.style.display = visible ? 'flex' : 'none';
        });
    }
    
    function executeCommand(action) {
        switch(action) {
            case 'goto-targets':
                window.location.href = '/submissions?status=TARGET';
                break;
            case 'export-data':
                exportOpportunities();
                break;
            case 'refresh-data':
                fetchJSON("/api/refresh", { method: "POST" })
                    .then(() => {
                        toast("Data refreshed", "success");
                        loadHome();
                    })
                    .catch((err) => toast("Refresh failed: " + err.message, "error"));
                break;
            case 'goto-submissions':
                window.location.href = '/submissions';
                break;
            case 'goto-insights':
                window.location.href = '/insights';
                break;
            default:
                toast('Command executed: ' + action, 'info');
        }
    }
    
    // Enhanced UI interactions
    function setupModernInteractions() {
        // Metric card interactions
        document.querySelectorAll('.metric-card-enhanced').forEach(card => {
            card.addEventListener('click', () => {
                const metric = card.dataset.metric;
                let filter = '';
                switch(metric) {
                    case 'target':
                        filter = '?status=TARGET';
                        break;
                    case 'in':
                        filter = '?status=IN';
                        break;
                    case 'out':
                        filter = '?status=OUT';
                        break;
                    case 'total':
                        filter = '';
                        break;
                }
                window.location.href = '/submissions' + filter;
            });
        });
        
        // View toggle functionality: switch rendering modes
        const current = getWorklistView();
        setWorklistView(current); // sync active state on load
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                setWorklistView(view);
                const rows = window._worklistRows || [];
                const mode = document.getElementById('home_mode')?.value || getActiveMode();
                renderWorklistRows(rows, mode);
            });
        });
        
        // Filter chips
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                const filter = chip.dataset.filter;
                // Apply filter logic here
                toast(`Applied ${filter} filter`, 'info');
            });
        });
        
        // Table controls
        const filtersBtn = document.getElementById('table_filters');
        const filtersBar = document.getElementById('filters_bar');
        if (filtersBtn && filtersBar) {
            filtersBtn.addEventListener('click', () => {
                filtersBar.classList.toggle('hidden');
            });
        }
        
        // Animate counters
        animateCounters();
    }
    
    function animateCounters() {
        document.querySelectorAll('.animate-counter').forEach(counter => {
            const target = parseInt(counter.dataset.target) || 0;
            const duration = 1500;
            const start = 0;
            const increment = target / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                counter.textContent = Math.round(current);
            }, 16);
        });
    }
    
    // Auto-refresh functionality
    let autoH;
    function startAuto() {
        clearInterval(autoH);
        autoH = setInterval(() => {
            if (!document.hidden) {
                loadHome().catch((err) => console.error("Auto-refresh failed:", err));
            }
        }, 45000);
    }
    function stopAuto() {
        clearInterval(autoH);
    }
    
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) stopAuto();
        else startAuto();
    });
    
    // Chart initialization and management
    function initializeCharts() {
        // Initialize trend chart
        initializeTrendChart();
        
        // Initialize donut chart
        initializeDonutChart();
        
        // Animate progress bars
        animateProgressBars();
    }

    function initializeTrendChart() {
        const canvas = document.getElementById('portfolioTrendChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Sample data for the trend line
        const dataPoints = [45, 52, 48, 65, 59, 72, 68, 78, 85, 89, 95, 92];
        const maxValue = Math.max(...dataPoints);
        const minValue = Math.min(...dataPoints);
        const range = maxValue - minValue;
        
        // Create gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, height);
        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.8)');
        gradient.addColorStop(1, 'rgba(99, 102, 241, 0.1)');
        
        // Draw the trend line
        ctx.strokeStyle = '#6366f1';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // Start path for line
        ctx.beginPath();
        const stepX = width / (dataPoints.length - 1);
        
        for (let i = 0; i < dataPoints.length; i++) {
            const x = i * stepX;
            const y = height - ((dataPoints[i] - minValue) / range) * height;
            
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();
        
        // Fill area under curve
        ctx.lineTo(width, height);
        ctx.lineTo(0, height);
        ctx.closePath();
        ctx.fillStyle = gradient;
        ctx.fill();
    }

    function initializeDonutChart() {
        const canvas = document.getElementById('riskDonutChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 35;
        const innerRadius = 25;
        
        // Data percentages
        const data = [
            { label: 'Target', value: 35, color: '#8b5cf6' },
            { label: 'In-Appetite', value: 45, color: '#10b981' },
            { label: 'Out-of-Appetite', value: 20, color: '#f43f5e' }
        ];
        
        let currentAngle = -Math.PI / 2; // Start at top
        
        data.forEach((segment, index) => {
            const sliceAngle = (segment.value / 100) * 2 * Math.PI;
            
            // Create gradient for each segment
            const gradient = ctx.createRadialGradient(centerX, centerY, innerRadius, centerX, centerY, radius);
            gradient.addColorStop(0, segment.color + '80');
            gradient.addColorStop(1, segment.color);
            
            // Draw segment
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
            ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
            ctx.closePath();
            
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // Add subtle border
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            ctx.stroke();
            
            currentAngle += sliceAngle;
        });
    }

    function animateProgressBars() {
        const progressBars = document.querySelectorAll('.progress-bar');
        
        progressBars.forEach((bar, index) => {
            const targetWidth = bar.style.width;
            bar.style.width = '0%';
            
            setTimeout(() => {
                bar.style.width = targetWidth;
            }, 200 + (index * 100)); // Stagger animations
        });
    }

    function setupChartInteractions() {
        // Chart tab switching
        document.querySelectorAll('.chart-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Simulate chart update
                const metric = tab.dataset.metric;
                window.toast(`Switched to ${metric} view`, 'info');
                
                // Redraw chart with animation
                setTimeout(() => {
                    initializeTrendChart();
                }, 200);
            });
        });
        
        // Chart hover effects
        const chartContainers = document.querySelectorAll('.trend-chart-container, .risk-distribution');
        chartContainers.forEach(container => {
            container.addEventListener('mouseenter', () => {
                container.style.transform = 'translateY(-2px)';
                container.style.boxShadow = '0 12px 32px rgba(0,0,0,0.25)';
            });
            
            container.addEventListener('mouseleave', () => {
                container.style.transform = 'translateY(0)';
                container.style.boxShadow = 'none';
            });
        });
    }

    // Initialize everything
    setupCommandPalette();
    setupModernInteractions();
    startAuto();
    
    // Initialize charts with delay for smoother loading
    setTimeout(() => {
        initializeCharts();
        setupChartInteractions();
        console.log('üìä Enhanced analytics and charts initialized');
    }, 1000);
</script>

<!-- Removed duplicate script block with orphaned code to prevent JS errors -->
{% endblock %}
