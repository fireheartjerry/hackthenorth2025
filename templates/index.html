{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
  <div class="card glass hover-up">
    <div class="card-title">Total Submissions</div>
    <div class="card-value">{{ total }}</div>
  </div>
  <div class="card glass hover-up">
    <div class="card-title">In-Appetite</div>
    <div class="card-value text-emerald-300">{{ in_ct }}</div>
  </div>
  <div class="card glass hover-up">
    <div class="card-title">Target</div>
    <div class="card-value text-indigo-300">{{ tgt_ct }}</div>
  </div>
  <div class="card glass hover-up">
    <div class="card-title">Out-of-Appetite</div>
    <div class="card-value text-rose-300">{{ out_ct }}</div>
  </div>
</div>

<div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div class="lg:col-span-2 glass-panel">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h2 class="text-lg font-semibold">Today’s Prioritized Worklist</h2>
        <div>
          <label class="lbl">Mode</label>
          <select id="home_mode" class="inp text-xs"></select>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="btn_refresh_home" class="text-sm pill pill-sub hover-glow">Refresh</button>
        <a href="{{ url_for('submissions') }}" class="text-indigo-300 text-sm hover:underline">Open full table →</a>
      </div>
    </div>
    <div id="worklist" class="mt-4 text-sm"></div>
  </div>
  <div class="glass-panel">
    <h2 class="text-lg font-semibold">Quick Stats</h2>
    <div class="mt-4 space-y-2 text-sm">
      <div class="flex justify-between"><span>Avg Premium</span><span>${{ '%.0f'|format(avg_premium) }}</span></div>
      <div class="flex justify-between"><span>Focus Metric</span><span>Winability-weighted</span></div>
      <div class="flex justify-between"><span>Alerts</span><span>—</span></div>
    </div>
  </div>
</div>
<script>
async function loadHome(){
  const el = document.getElementById("worklist")
  await withLoading(el, async ()=>{
    const mode = document.getElementById('home_mode')?.value || 'balanced_growth'
    const j = await fetchJSON("/api/classified_mode?mode="+encodeURIComponent(mode))
    const rows = (j.data||[]).slice(0,8)
    el.innerHTML = rows.map(r=>`
    <a href="/detail/${r.id}?mode=${encodeURIComponent(mode)}" class="row">
      <div class="row-main">
        <div class="row-title">${r.account_name||"-"}</div>
        <div class="row-sub">${r.primary_risk_state||"-"} · ${r.line_of_business||"-"} · $${Math.round(r.total_premium||0).toLocaleString()}</div>
      </div>
      <div class="row-badges">
        ${badge(r.appetite_status)}
        <span class="chip">Score ${Number(r.priority_score||0).toFixed(2)}</span>
      </div>
    </a>
    `).join("")
  })
}
function badge(s){
  if(s==="TARGET") return `<span class="pill pill-indigo">Target</span>`
  if(s==="IN") return `<span class="pill pill-emerald">In</span>`
  return `<span class="pill pill-rose">Out</span>`
}
document.getElementById("btn_refresh_home").onclick=()=>{
  fetchJSON("/api/refresh",{method:"POST"})
    .then(()=>{ toast("Data refreshed","success"); loadHome() })
    .catch(err=>toast("Refresh failed: "+err.message, "error"))
}

async function populateHomeModes(){
  try{
    const j = await fetchJSON('/api/modes')
    const modes = j.modes||[]
    const sel = document.getElementById('home_mode')
    if(!sel) return
    sel.innerHTML = modes.map(m=>`<option value="${m}">${m}</option>`).join('')
    sel.value = modes.includes('balanced_growth')? 'balanced_growth' : (modes[0]||'')
    sel.addEventListener('change', ()=> loadHome().catch(err=>toast('Load failed: '+err.message,'error')))
  }catch(e){ console.warn('Failed to load modes', e) }
}

populateHomeModes().then(()=>{
  loadHome().catch(err=>toast("Failed to load worklist: "+err.message, "error"))
}).catch(()=>{
  loadHome().catch(err=>toast("Failed to load worklist: "+err.message, "error"))
})
</script>
{% endblock %}
