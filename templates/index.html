{% extends "base.html" %} {% block content %}
<!-- Enhanced Underwriter Dashboard -->
<div class="glass-panel mb-6 flex items-center justify-between">
  <div>
    <div id="hero_greet" class="text-2xl font-semibold tracking-tight">Welcome</div>
    <div id="hero_sub" class="text-xs opacity-70 mt-1">High-value opportunities ready for your review</div>
  </div>
  <div class="hidden md:flex items-center gap-3">
    <button id="btn_persona" class="quick-action primary">Build Persona</button>
    <button id="btn_refresh_home" class="quick-action">Refresh Data</button>
    <span class="chip">Vibe: <span id="hero_vibe" class="ml-1">â€”</span></span>
    <a href="#" id="open_vibes" class="pill pill-sub hover-glow">Tweak vibe</a>
  </div>
  <script>
    (function(){
      function greet(){
        const n = localStorage.getItem('USER_NAME') || '';
        const h = new Date().getHours();
        const g = h<12? 'Good morning' : h<18? 'Good afternoon' : 'Good evening';
        document.getElementById('hero_greet').textContent = n ? `${g}, ${n} ðŸ‘‹` : `${g} ðŸ‘‹`;
      }
      function vibe(){
        const v = (localStorage.getItem('VIBE') || 'aurora');
        const pretty = v.charAt(0).toUpperCase()+v.slice(1);
        document.getElementById('hero_vibe').textContent = pretty;
      }
      document.getElementById('open_vibes')?.addEventListener('click', (e)=>{
        e.preventDefault();
        document.getElementById('vibe_btn')?.click();
      });
      greet(); vibe();
      window.addEventListener('storage', (e)=>{ if(e.key==='USER_NAME'||e.key==='VIBE'){ greet(); vibe(); }});
    })();
  </script>
</div>

<!-- Enhanced Metrics Dashboard -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="metric-card">
        <div class="metric-value text-purple-300">{{ tgt_ct }}</div>
        <div class="metric-label">Target Opportunities</div>
        <div class="text-xs text-purple-200 mt-1">High priority</div>
    </div>
    <div class="metric-card">
        <div class="metric-value text-emerald-300">{{ in_ct }}</div>
        <div class="metric-label">In-Appetite</div>
        <div class="text-xs text-emerald-200 mt-1">Ready to review</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">{{ total }}</div>
        <div class="metric-label">Total Submissions</div>
        <div class="text-xs opacity-60 mt-1">This period</div>
    </div>
    <div class="metric-card">
        <div class="metric-value text-rose-300">{{ out_ct }}</div>
        <div class="metric-label">Out-of-Appetite</div>
        <div class="text-xs text-rose-200 mt-1">Review criteria</div>
    </div>
</div>

<div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left: Recent workload with tabs -->
    <div class="lg:col-span-2 glass-panel">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <h2 class="text-lg font-semibold">
                    Todayâ€™s Prioritized Worklist
                </h2>
                <div>
                    <label class="lbl">Mode</label>
                    <select id="home_mode" class="inp text-xs"></select>
                    <span id="mode_expl" class="ml-2 text-xs opacity-70"></span>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="glass-panel">
            <h3 class="text-sm font-semibold mb-3">Quick Actions</h3>
            <div class="space-y-2">
                <button class="w-full quick-action text-left" onclick="window.location.href='/submissions?status=TARGET'">
                    ðŸŽ¯ Review All Targets
                </button>
                <button class="w-full quick-action text-left" onclick="exportOpportunities()">
                    ðŸ“Š Export Current View
                </button>
                <button class="w-full quick-action text-left" onclick="showBulkActions()">
                    âš¡ Bulk Actions
                </button>
                <button class="w-full quick-action text-left" onclick="showAnalytics()">
                    ðŸ“ˆ Portfolio Analytics
                </button>
            </div>
        </div>
    </div>
</div>
        <div id="worklist" class="mt-4 text-sm"></div>
    </div>

    <!-- Right: Goals and quick stats -->
    <div class="space-y-6">
        <div class="glass-panel">
            <h2 class="text-lg font-semibold">My Portfolio Goals</h2>
            <div class="mt-3 grid grid-cols-1 gap-4 text-sm">
                <div>
                    <div class="font-semibold text-emerald-300">
                        Overperforming Goals
                    </div>
                    <ul class="list-disc pl-5 mt-1 opacity-90">
                        <li>Retain 90% of accounts with a loss ratio â‰¤ 50%</li>
                        <li>No more than $150M of TIV in Zone 6</li>
                    </ul>
                </div>
                <div>
                    <div class="font-semibold text-rose-300">
                        Underperforming Goals
                    </div>
                    <ul class="list-disc pl-5 mt-1 opacity-90">
                        <li>Get more rate on accounts with loss â‰¥ 100k</li>
                        <li>20% rate target on West Commercial</li>
                        <li>
                            30% rate increase on hazmat truckers with high LR
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="glass-panel">
            <h2 class="text-lg font-semibold">Quick Stats</h2>
            <div class="mt-4 space-y-2 text-sm">
                <div class="flex justify-between">
                    <span>Avg Premium</span
                    ><span>${{ '%.0f'|format(avg_premium) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>Focus Metric</span><span>Winnability-weighted</span>
                </div>
                <div class="flex justify-between">
                    <span>Alerts</span><span>â€”</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accounts table -->
<div class="mt-6 glass-panel p-0 overflow-x-auto">
    <div class="flex items-center justify-between px-4 py-3">
        <h2 class="text-lg font-semibold">My Accounts</h2>
        <div class="text-xs opacity-70">
            Top prioritized accounts â€¢
            <a href="{{ url_for('submissions') }}" class="link">view all</a>
        </div>
    </div>
    <table class="table table-glass text-sm">
        <thead>
            <tr>
                <th class="th">Account Name</th>
                <th class="th">Type</th>
                <th class="th">Estimated Premium</th>
                <th class="th">Broker</th>
                <th class="th">Effective Date</th>
                <th class="th">Loss Ratio</th>
                <th class="th">Status</th>
                <th class="th">Appetite</th>
                <th class="th">Triage Score</th>
                <th class="th">Winnability</th>
                <th class="th">Rated Premium</th>
            </tr>
        </thead>
        <tbody id="acct_body"></tbody>
    </table>
    <div class="px-4 py-3 text-xs opacity-70">
        Showing top results by priority score
    </div>
</div>

<!-- Persona Modal: removed (use global in base.html) -->

<script>
    // Ensure utility functions are available (fallback if app.js hasn't loaded yet)
    if (typeof window.fetchJSON === 'undefined') {
        window.fetchJSON = async function(url, opts={}){
            const res = await fetch(url, opts);
            if(!res.ok){
                let msg = `${res.status} ${res.statusText}`;
                try { const j = await res.json(); if(j && j.error) msg = j.error; } catch {}
                throw new Error(msg);
            }
            return res.json();
        }
    }
    
    if (typeof window.withLoading === 'undefined') {
        window.withLoading = async function(el, fn){
            try{ el?.classList?.add("is-loading"); return await fn(); } finally { el?.classList?.remove("is-loading"); }
        }
    }
    
    if (typeof window.toast === 'undefined') {
        window.toast = function(msg, type = "info") {
            const host = document.getElementById("toasts") || (function(){
                const d = document.createElement("div");
                d.id = "toasts"; d.className = "toasts"; document.body.appendChild(d); return d;
            })();
            const el = document.createElement("div");
            el.className = `toast ${type}`;
            el.textContent = msg;
            host.appendChild(el);
            setTimeout(()=>{ el.classList.add("out"); setTimeout(()=>host.removeChild(el), 200); }, 2800);
        }
    }
    
    let ALL = [];

    function getActiveMode() {
        return localStorage.getItem("ACTIVE_MODE") || "balanced_growth";
    }
    function setActiveMode(m) {
        localStorage.setItem("ACTIVE_MODE", m);
    }

    function prettyMode(name){
        const s = String(name || "");
        return s.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
    }
    function updateModeChip(){
        const mode = getActiveMode();
        const at = localStorage.getItem("LAST_REFINED_AT");
        const mch = document.getElementById("mode_chip");
        if (mch) {
            mch.textContent = at && mode === 'custom' ? `Mode: ${prettyMode(mode)} Â· ${at}` : `Mode: ${prettyMode(mode)}`;
        }
    }
    function updateLastUpdated(elId){
        const el = document.getElementById(elId);
        if(!el) return;
        const d = new Date();
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        el.textContent = `Last updated ${hh}:${mm}`;
    }

    async function loadHome() {
        const el = document.getElementById("worklist");
        if (!el) return;
        await withLoading(el, async () => {
            const sel = document.getElementById("home_mode");
            const mode = sel?.value || getActiveMode();
            const j = await fetchJSON(`/api/classified_mode?mode=${encodeURIComponent(mode)}`);
            // Fallback if custom yields no rows
            if ((j.count || 0) === 0 && mode === "custom") {
                const last = localStorage.getItem("LAST_NON_EMPTY_MODE") || "balanced_growth";
                toast("Custom mode empty â€” showing " + last, "error");
                setActiveMode(last);
                if (sel) sel.value = last;
                const jj = await fetchJSON(`/api/classified_mode?mode=${encodeURIComponent(last)}`);
                renderWorklistRows(jj.data || [], last);
                return;
            }
            if ((j.count || 0) > 0) {
                localStorage.setItem("LAST_NON_EMPTY_MODE", mode);
            }
            renderWorklistRows(j.data || [], mode);
            updateModeChip();
            updateLastUpdated('worklist_last');
        });
    }

    function renderWorklistRows(rows, mode) {
        const el = document.getElementById("worklist");
        if (!el) return;
        const top = (rows || []).slice(0, 8);
        // Empty state banner with relax option
        if (!top.length) {
            el.innerHTML = `
                <div class="glass p-4 rounded-lg border border-dashed border-slate-600">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-semibold">No results for current mode</div>
                      <div class="text-xs opacity-80">Try Balanced Growth or relax filters (+0.1 LR, +20% premium band)</div>
                    </div>
                    <div class="flex items-center gap-2">
                      <button id="btn_switch_bal" class="pill pill-sub">Switch to Balanced Growth</button>
                      <button id="btn_relax" class="pill pill-sub">Relax Filters</button>
                    </div>
                  </div>
                </div>`;
            document.getElementById('btn_switch_bal')?.addEventListener('click', () => {
                setActiveMode('balanced_growth');
                const sel = document.getElementById('home_mode');
                if (sel) sel.value = 'balanced_growth';
                loadHome();
            });
            return;
        }
        el.innerHTML = top.map(r => `
            <a href="/detail/${r.id}?mode=${encodeURIComponent(mode)}" class="row">
              <div class="row-main">
                <div class="row-title">${r.account_name || "-"}</div>
                <div class="row-sub">${r.primary_risk_state || "-"} Â· ${r.line_of_business || "-"} Â· $${Math.round(r.total_premium || 0).toLocaleString()}</div>
              </div>
              <div class="row-badges">
                ${badge(r.appetite_status)}
                <span class="chip">Score ${Number(r.priority_score || 0).toFixed(2)}</span>
              </div>
            </a>
        `).join("");
    }

    function badge(s) {
        if (s === "TARGET") return `<span class="pill pill-indigo">Target</span>`;
        if (s === "IN") return `<span class="pill pill-emerald">In</span>`;
        return `<span class="pill pill-rose">Out</span>`;
    }

    // Utility functions for quick actions
    function exportOpportunities() {
        toast('Export functionality coming soon', 'info');
    }

    function showBulkActions() {
        toast('Bulk actions panel coming soon', 'info');
    }

    function showAnalytics() {
        window.location.href = '/insights';
    }

    async function populateHomeModes() {
        try {
            const j = await fetchJSON('/api/modes');
            const sel = document.getElementById('home_mode');
            if (sel && j && Array.isArray(j)) {
                sel.innerHTML = j.map(m => `<option value="${m.key}">${m.label}</option>`).join('');
                sel.value = getActiveMode();
            }
        } catch (e) {
            console.error('Failed to load modes:', e);
        }
    }

    // Event handlers
    const refreshBtn = document.getElementById("btn_refresh_home");
    if (refreshBtn) {
        refreshBtn.onclick = () => {
            fetchJSON("/api/refresh", { method: "POST" })
                .then(() => {
                    toast("Data refreshed", "success");
                    loadHome();
                })
                .catch((err) => toast("Refresh failed: " + err.message, "error"));
        };
    }

    const refreshBtn2 = document.getElementById("btn_refresh_home_2");
    if (refreshBtn2) {
        refreshBtn2.onclick = () => {
            fetchJSON("/api/refresh", { method: "POST" })
                .then(() => {
                    toast("Data refreshed", "success");
                    loadHome();
                })
                .catch((err) => toast("Refresh failed: " + err.message, "error"));
        };
    }

    const modeSelect = document.getElementById('home_mode');
    if (modeSelect) {
        modeSelect.addEventListener('change', (e) => {
            setActiveMode(e.target.value);
            updateModeChip();
            loadHome();
        });
    }

    // Initialize page
    populateHomeModes().then(() => {
        loadHome();
        updateModeChip();
    }).catch(() => {
        loadHome();
        updateModeChip();
    });

    // Legacy persona functions for compatibility
    function gatherAnswers() {
        const con = document.getElementById("ans_con_list")?.value || "";
        const ans = {
            aggressiveness: Number(document.getElementById("ans_aggr")?.value || 5),
            objective: document.getElementById("ans_obj")?.value || "balance",
            premium_lo: Number(document.getElementById("ans_prem_lo")?.value || 75000),
            premium_hi: Number(document.getElementById("ans_prem_hi")?.value || 1500000),
            max_lr: Number(document.getElementById("ans_lr")?.value || 0.65),
            tiv_max: Number(document.getElementById("ans_tiv")?.value || 150000000),
            new_only: !!document.getElementById("ans_new_only")?.checked,
            strict_construction: !!document.getElementById("ans_good_con")?.checked,
            construction_pref: con ? con.split(',').map(s => s.trim()).filter(Boolean) : [],
            comments: document.getElementById("ans_comments")?.value || "",
        };
        try { localStorage.setItem('personaAnswers', JSON.stringify(ans)); } catch {}
        return ans;
    }

    // Auto-refresh functionality
    let autoH;
    function startAuto() {
        clearInterval(autoH);
        autoH = setInterval(() => {
            if (!document.hidden) {
                loadHome().catch((err) => console.error("Auto-refresh failed:", err));
            }
        }, 45000);
    }
    function stopAuto() {
        clearInterval(autoH);
    }
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) stopAuto();
        else startAuto();
    });
    startAuto();
</script>

<script>
    // Orphaned JavaScript code cleanup - moved all code into proper script structure
    // Enhanced data loading and initialization
    async function loadHome() {
        try {
            const mode = getActiveMode();
            const response = await fetchJSON(`/api/classified_mode?mode=${encodeURIComponent(mode)}`);
            
            // Store all data
            ALL = response.data || [];
            
            // Apply current filter
            applyFilter(currentFilter);
            
            updateModeChip();
            updateLastUpdated('worklist_last');
        } catch (error) {
            toast('Failed to load opportunities: ' + error.message, 'error');
        }
    }

    // Event handlers
    document.addEventListener('DOMContentLoaded', () => {
        // Filter button handlers
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                applyFilter(btn.dataset.filter);
            });
        });

        // Refresh handler
        document.getElementById('btn_refresh_home')?.addEventListener('click', () => {
            fetchJSON('/api/refresh', { method: 'POST' })
                .then(() => {
                    toast('Data refreshed', 'success');
                    loadHome();
                })
                .catch(err => toast('Refresh failed: ' + err.message, 'error'));
        });

        // Mode change handler
        document.getElementById('home_mode')?.addEventListener('change', (e) => {
            setActiveMode(e.target.value);
            loadHome();
        });

        // Load modes and initialize
        loadModes().then(() => {
            loadHome();
        });
    });

    // Load available modes
    async function loadModes() {
        try {
            const modes = await fetchJSON('/api/modes');
            const selects = ['home_mode'];
            
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                
                sel.innerHTML = modes.map(m => 
                    `<option value="${m.key}">${m.label}</option>`
                ).join('');
                
                sel.value = getActiveMode();
            });
        } catch (error) {
            console.error('Failed to load modes:', error);
        }
    }
    };

    // Persona modal wiring
    const modal = document.getElementById("persona_modal");
    document.getElementById("btn_persona").onclick = () => {
        modal.classList.remove("hidden");
    };
    document.getElementById("persona_close").onclick = () => {
        modal.classList.add("hidden");
    };

    function gatherAnswers() {
        const con = (document.getElementById("ans_con_list").value || "")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
        const a = {
            aggressiveness: Number(
                document.getElementById("ans_aggr").value || 3
            ),
            objective: document.getElementById("ans_obj").value || "balance",
            premium_lo: Number(
                document.getElementById("ans_prem_lo").value || 100000
            ),
            premium_hi: Number(
                document.getElementById("ans_prem_hi").value || 1500000
            ),
            max_lr: Number(document.getElementById("ans_lr").value || 0.65),
            tiv_max: Number(
                document.getElementById("ans_tiv").value || 150000000
            ),
            new_only: !!document.getElementById("ans_new_only").checked,
            strict_construction:
                !!document.getElementById("ans_good_con").checked,
            construction_pref: con,
            comments: document.getElementById("ans_comments").value || "",
        };
        try { localStorage.setItem('personaAnswers', JSON.stringify(a)); } catch {}
        return a;
    }

    document.getElementById("persona_seed").onclick = async () => {
        const ans = gatherAnswers();
        const status = document.getElementById("persona_status");
        try {
            status.textContent = "Seedingâ€¦";
            document.getElementById("persona_seed").setAttribute('disabled','');
            document.getElementById("persona_submit").setAttribute('disabled','');
            const res = await fetchJSON("/api/persona/seed", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ answers: ans }),
            });
            toast("Seed created", "success");
            setActiveMode("custom");
            await populateHomeModes();
            document.getElementById("home_mode").value = "custom";
            await loadHome();
        } catch (e) {
            toast("Seed failed: " + e.message, "error");
        } finally {
            status.textContent = "";
            document.getElementById("persona_seed").removeAttribute('disabled');
            document.getElementById("persona_submit").removeAttribute('disabled');
        }
    };

    document.getElementById("persona_submit").onclick = async () => {
        const ans = gatherAnswers();
        const status = document.getElementById("persona_status");
        try {
            status.textContent = "Calling Geminiâ€¦";
            document.getElementById("persona_seed").setAttribute('disabled','');
            document.getElementById("persona_submit").setAttribute('disabled','');
            const res = await fetchJSON("/api/persona/propose", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    answers: ans,
                    goal_text: ans.comments || "",
                }),
            });
            toast("Persona proposed and set as custom", "success");
            setActiveMode("custom");
            const d = new Date();
            const hh = d.getHours().toString().padStart(2,'0');
            const mm = d.getMinutes().toString().padStart(2,'0');
            localStorage.setItem('LAST_REFINED_AT', `${hh}:${mm}`);
            await populateHomeModes();
            document.getElementById("home_mode").value = "custom";
            await loadHome();
            modal.classList.add("hidden");
        } catch (e) {
            toast("Propose failed: " + e.message, "error");
        } finally {
            status.textContent = "";
            document.getElementById("persona_seed").removeAttribute('disabled');
            document.getElementById("persona_submit").removeAttribute('disabled');
        }
    };

    // Preview rendering (no server override path; show summary only)
    (function(){
      const prevBtn = document.getElementById('persona_preview_btn');
      if (!prevBtn) return;
      prevBtn.onclick = () => {
        const a = gatherAnswers();
        const pv = document.getElementById('persona_preview');
        if (!pv) return;
        const lines = [];
        lines.push(`Aggressiveness: ${a.aggressiveness} Â· Objective: ${a.objective}`);
        lines.push(`Premium: $${a.premium_lo.toLocaleString()}â€“$${a.premium_hi.toLocaleString()} Â· Max LR: ${a.max_lr}`);
        lines.push(`TIV â‰¤ $${a.tiv_max.toLocaleString()} Â· New only: ${a.new_only ? 'yes' : 'no'} Â· Good construction: ${a.strict_construction ? 'yes' : 'no'}`);
        pv.textContent = `Preview â€” ${lines.join(' â€¢ ')} Â· Estimated count: not available in demo`;
      };
    })();

    // Restore answers from localStorage on modal open
    document.getElementById("btn_persona").addEventListener('click', () => {
        try {
          const raw = localStorage.getItem('personaAnswers');
          if (!raw) return;
          const a = JSON.parse(raw);
          if (a.aggressiveness) document.getElementById('ans_aggr').value = a.aggressiveness;
          if (a.objective) document.getElementById('ans_obj').value = a.objective;
          if (a.premium_lo) document.getElementById('ans_prem_lo').value = a.premium_lo;
          if (a.premium_hi) document.getElementById('ans_prem_hi').value = a.premium_hi;
          if (a.max_lr) document.getElementById('ans_lr').value = a.max_lr;
          if (a.tiv_max) document.getElementById('ans_tiv').value = a.tiv_max;
          document.getElementById('ans_new_only').checked = !!a.new_only;
          document.getElementById('ans_good_con').checked = !!a.strict_construction;
          if (Array.isArray(a.construction_pref)) document.getElementById('ans_con_list').value = a.construction_pref.join(', ');
          if (a.comments) document.getElementById('ans_comments').value = a.comments;
        } catch {}
    });

    // Initial load
    populateHomeModes()
        .then(() => loadHome())
        .catch(() => loadHome());

    let autoH;
    function startAuto() {
        clearInterval(autoH);
        autoH = setInterval(() => {
            if (!document.hidden) {
                loadHome().catch((err) =>
                    toast("Auto-refresh failed: " + err.message, "error")
                );
            }
        }, 45000);
    }
    function stopAuto() {
        clearInterval(autoH);
    }
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) stopAuto();
        else startAuto();
    });
    startAuto();
</script>
{% endblock %}
