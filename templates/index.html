{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
  <div class="card glass hover-up">
    <div class="card-title">Total Submissions</div>
    <div class="card-value">{{ total }}</div>
  </div>
  <div class="card glass hover-up">
    <div class="card-title">In-Appetite</div>
    <div class="card-value text-emerald-300">{{ in_ct }}</div>
  </div>
  <div class="card glass hover-up">
    <div class="card-title">Target</div>
    <div class="card-value text-indigo-300">{{ tgt_ct }}</div>
  </div>
  <div class="card glass hover-up">
    <div class="card-title">Out-of-Appetite</div>
    <div class="card-value text-rose-300">{{ out_ct }}</div>
  </div>
</div>

<div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Left: Recent workload with tabs -->
  <div class="lg:col-span-2 glass-panel">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Recent Workload</h2>
      <div class="flex items-center gap-2">
        <button id="btn_refresh_home" class="text-sm pill pill-sub hover-glow">Refresh</button>
        <a href="{{ url_for('submissions') }}" class="text-indigo-300 text-sm hover:underline">Open full table →</a>
      </div>
    </div>
    <!-- Tabs -->
    <div class="mt-3 flex items-center gap-2 text-xs">
      <button id="tab_assigned" class="pill pill-sub hover-glow">Assigned to me <span id="ct_assigned" class="ml-1 opacity-75">—</span></button>
      <button id="tab_related" class="pill pill-sub hover-glow">Related to me <span id="ct_related" class="ml-1 opacity-75">—</span></button>
      <button id="tab_referrals" class="pill pill-sub hover-glow">Referrals <span id="ct_referrals" class="ml-1 opacity-75">—</span></button>
    </div>
    <div id="worklist" class="mt-4 text-sm"></div>
  </div>

  <!-- Right: Goals and quick stats -->
  <div class="space-y-6">
    <div class="glass-panel">
      <h2 class="text-lg font-semibold">My Portfolio Goals</h2>
      <div class="mt-3 grid grid-cols-1 gap-4 text-sm">
        <div>
          <div class="font-semibold text-emerald-300">Overperforming Goals</div>
          <ul class="list-disc pl-5 mt-1 opacity-90">
            <li>Retain 90% of accounts with a loss ratio ≤ 50%</li>
            <li>No more than $150M of TIV in Zone 6</li>
          </ul>
        </div>
        <div>
          <div class="font-semibold text-rose-300">Underperforming Goals</div>
          <ul class="list-disc pl-5 mt-1 opacity-90">
            <li>Get more rate on accounts with loss ≥ 100k</li>
            <li>20% rate target on West Commercial</li>
            <li>30% rate increase on hazmat truckers with high LR</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="glass-panel">
      <h2 class="text-lg font-semibold">Quick Stats</h2>
      <div class="mt-4 space-y-2 text-sm">
        <div class="flex justify-between"><span>Avg Premium</span><span>${{ '%.0f'|format(avg_premium) }}</span></div>
        <div class="flex justify-between"><span>Focus Metric</span><span>Winnability-weighted</span></div>
        <div class="flex justify-between"><span>Alerts</span><span>—</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Accounts table -->
<div class="mt-6 glass-panel p-0 overflow-x-auto">
  <div class="flex items-center justify-between px-4 py-3">
    <h2 class="text-lg font-semibold">My Accounts</h2>
    <div class="text-xs opacity-70">Top prioritized accounts • <a href="{{ url_for('submissions') }}" class="link">view all</a></div>
  </div>
  <table class="table table-glass text-sm">
    <thead>
      <tr>
        <th class="th">Account Name</th>
        <th class="th">Type</th>
        <th class="th">Estimated Premium</th>
        <th class="th">Broker</th>
        <th class="th">Effective Date</th>
        <th class="th">Loss Ratio</th>
        <th class="th">Status</th>
        <th class="th">Appetite</th>
        <th class="th">Triage Score</th>
        <th class="th">Winnability</th>
        <th class="th">Rated Premium</th>
      </tr>
    </thead>
    <tbody id="acct_body"></tbody>
  </table>
  <div class="px-4 py-3 text-xs opacity-70">Showing top results by priority score</div>
</div>

<script>
let ALL = [];
let currentTab = "ASSIGNED"; // ASSIGNED | RELATED | REFERRALS

async function loadHome(){
  const el = document.getElementById("worklist");
  await withLoading(el, async ()=>{
    const j = await fetchJSON("/api/classified_mode?mode=balanced_growth")
    const rows = (j.data||[]).slice(0,8)
    el.innerHTML = rows.map(r=>`
    <a href="/detail/${r.id}?mode=balanced_growth" class="row">
      <div class="row-main">
        <div class="row-title">${r.account_name||"-"}</div>
        <div class="row-sub">${r.primary_risk_state||"-"} · ${r.line_of_business||"-"} · $${Math.round(r.total_premium||0).toLocaleString()}</div>
      </div>
      <div class="row-badges">
        ${badge(r.appetite_status)}
        <span class="chip">Score ${Number(r.priority_score||0).toFixed(2)}</span>
      </div>
    </a>
    `).join("")
  })
}
function badge(s){
  if(s==="TARGET") return `<span class="pill pill-indigo">Target</span>`
  if(s==="IN") return `<span class="pill pill-emerald">In</span>`
  return `<span class="pill pill-rose">Out</span>`
}
document.getElementById("btn_refresh_home").onclick=()=>{
  fetchJSON("/api/refresh",{method:"POST"})
    .then(()=>{ toast("Data refreshed","success"); loadHome() })
    .catch(err=>toast("Refresh failed: "+err.message, "error"))
}

// Tabs handlers
document.getElementById("tab_assigned").onclick=()=>{ currentTab="ASSIGNED"; renderWorklist(); };
document.getElementById("tab_related").onclick=()=>{ currentTab="RELATED"; renderWorklist(); };
document.getElementById("tab_referrals").onclick=()=>{ currentTab="REFERRALS"; renderWorklist(); };

function updateCounts(){
  const ct_assigned = ALL.filter(r=>r.appetite_status==="TARGET").length; // proxy
  const ct_related = ALL.filter(r=>r.appetite_status==="IN").length;
  const ct_referrals = ALL.filter(r=>r.appetite_status==="OUT").length;
  document.getElementById("ct_assigned").textContent = `(${ct_assigned})`;
  document.getElementById("ct_related").textContent = `(${ct_related})`;
  document.getElementById("ct_referrals").textContent = `(${ct_referrals})`;
}

function renderWorklist(){
  const el = document.getElementById("worklist");
  let rows = ALL;
  if(currentTab==="ASSIGNED") rows = ALL.filter(r=>r.appetite_status==="TARGET");
  else if(currentTab==="RELATED") rows = ALL.filter(r=>r.appetite_status==="IN");
  else if(currentTab==="REFERRALS") rows = ALL.filter(r=>r.appetite_status==="OUT");
  rows = rows.slice(0,8);
  el.innerHTML = rows.map(r=>`
    <a href="/detail/${r.id}" class="row">
      <div class="row-main">
        <div class="row-title">${r.account_name||"-"}</div>
        <div class="row-sub">${r.primary_risk_state||"-"} · ${r.line_of_business||"-"} · $${Math.round(r.total_premium||0).toLocaleString()}</div>
      </div>
      <div class="row-badges">
        ${badge(r.appetite_status)}
        <span class="chip">Score ${Number(r.priority_score||0).toFixed(2)}</span>
      </div>
    </a>`).join("");
}

function renderAccounts(){
  const tb = document.getElementById("acct_body");
  const top = [...ALL].sort((a,b)=>(b.priority_score||0)-(a.priority_score||0)).slice(0,12);
  tb.innerHTML = top.map(r=>{
    const win = (typeof r.winnability==="number") ? (r.winnability>1? r.winnability : r.winnability*100) : null;
    return `<tr class="tr">
      <td class="td"><a class="link" href="/detail/${r.id}">${r.account_name||"-"}</a></td>
      <td class="td">${r.renewal_or_new_business||"-"}</td>
      <td class="td">$${Math.round(r.total_premium||0).toLocaleString()}</td>
      <td class="td">${r.broker||"-"}</td>
      <td class="td">${r.effective_date? new Date(r.effective_date).toISOString().slice(0,10): "-"}</td>
      <td class="td">${(typeof r.loss_ratio==="number")? (r.loss_ratio*100).toFixed(0)+"%" : (r.loss_ratio||"-")}</td>
      <td class="td">${r.status||"Submitted"}</td>
      <td class="td">${badge(r.appetite_status)}</td>
      <td class="td">${Number(r.priority_score||0).toFixed(2)}</td>
      <td class="td">${win!=null? Math.round(win)+"%":"-"}</td>
      <td class="td">$${Math.round(r.rated_premium||r.total_premium||0).toLocaleString()}</td>
    </tr>`
  }).join("");
}

loadHome().catch(err=>toast("Failed to load dashboard: "+err.message, "error"))
</script>
{% endblock %}
