{% extends "base.html" %} {% block content %}
<!-- Enhanced Underwriter Dashboard -->
<div class="glass-panel mb-6 flex items-center justify-between">
  <div>
    <div id="hero_greet" class="text-2xl font-semibold tracking-tight">Welcome</div>
    <div id="hero_sub" class="text-xs opacity-70 mt-1">High-value opportunities ready for your review</div>
  </div>
  <div class="hidden md:flex items-center gap-3">
    <button id="btn_persona" class="quick-action primary">Build Persona</button>
    <button id="btn_refresh_home" class="quick-action">Refresh Data</button>
    <span class="chip">Vibe: <span id="hero_vibe" class="ml-1">â€”</span></span>
    <a href="#" id="open_vibes" class="pill pill-sub hover-glow">Tweak vibe</a>
  </div>
  <script>
    (function(){
      function greet(){
        const n = localStorage.getItem('USER_NAME') || '';
        const h = new Date().getHours();
        const g = h<12? 'Good morning' : h<18? 'Good afternoon' : 'Good evening';
        document.getElementById('hero_greet').textContent = n ? `${g}, ${n} ðŸ‘‹` : `${g} ðŸ‘‹`;
      }
      function vibe(){
        const v = (localStorage.getItem('VIBE') || 'aurora');
        const pretty = v.charAt(0).toUpperCase()+v.slice(1);
        document.getElementById('hero_vibe').textContent = pretty;
      }
      document.getElementById('open_vibes')?.addEventListener('click', (e)=>{
        e.preventDefault();
        document.getElementById('vibe_btn')?.click();
      });
      greet(); vibe();
      window.addEventListener('storage', (e)=>{ if(e.key==='USER_NAME'||e.key==='VIBE'){ greet(); vibe(); }});
    })();
  </script>
</div>

<!-- Enhanced Metrics Dashboard -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="metric-card">
        <div class="metric-value text-purple-300">{{ tgt_ct }}</div>
        <div class="metric-label">Target Opportunities</div>
        <div class="text-xs text-purple-200 mt-1">High priority</div>
    </div>
    <div class="metric-card">
        <div class="metric-value text-emerald-300">{{ in_ct }}</div>
        <div class="metric-label">In-Appetite</div>
        <div class="text-xs text-emerald-200 mt-1">Ready to review</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">{{ total }}</div>
        <div class="metric-label">Total Submissions</div>
        <div class="text-xs opacity-60 mt-1">This period</div>
    </div>
    <div class="metric-card">
        <div class="metric-value text-rose-300">{{ out_ct }}</div>
        <div class="metric-label">Out-of-Appetite</div>
        <div class="text-xs text-rose-200 mt-1">Review criteria</div>
    </div>
</div>

<div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left: Recent workload with tabs -->
    <div class="lg:col-span-2 glass-panel">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <h2 class="text-lg font-semibold">
                    Todayâ€™s Prioritized Worklist
                </h2>
                <div>
                    <label class="lbl">Mode</label>
                    <select id="home_mode" class="inp text-xs"></select>
                    <span id="mode_expl" class="ml-2 text-xs opacity-70"></span>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="glass-panel">
            <h3 class="text-sm font-semibold mb-3">Quick Actions</h3>
            <div class="space-y-2">
                <button class="w-full quick-action text-left" onclick="window.location.href='/submissions?status=TARGET'">
                    ðŸŽ¯ Review All Targets
                </button>
                <button class="w-full quick-action text-left" onclick="exportOpportunities()">
                    ðŸ“Š Export Current View
                </button>
                <button class="w-full quick-action text-left" onclick="showBulkActions()">
                    âš¡ Bulk Actions
                </button>
                <button class="w-full quick-action text-left" onclick="showAnalytics()">
                    ðŸ“ˆ Portfolio Analytics
                </button>
            </div>
        </div>
    </div>
</div>
        <div id="worklist" class="mt-4 text-sm"></div>
    </div>

    <!-- Right: Goals and quick stats -->
    <div class="space-y-6">
        <div class="glass-panel">
            <h2 class="text-lg font-semibold">My Portfolio Goals</h2>
            <div class="mt-3 grid grid-cols-1 gap-4 text-sm">
                <div>
                    <div class="font-semibold text-emerald-300">
                        Overperforming Goals
                    </div>
                    <ul class="list-disc pl-5 mt-1 opacity-90">
                        <li>Retain 90% of accounts with a loss ratio â‰¤ 50%</li>
                        <li>No more than $150M of TIV in Zone 6</li>
                    </ul>
                </div>
                <div>
                    <div class="font-semibold text-rose-300">
                        Underperforming Goals
                    </div>
                    <ul class="list-disc pl-5 mt-1 opacity-90">
                        <li>Get more rate on accounts with loss â‰¥ 100k</li>
                        <li>20% rate target on West Commercial</li>
                        <li>
                            30% rate increase on hazmat truckers with high LR
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="glass-panel">
            <h2 class="text-lg font-semibold">Quick Stats</h2>
            <div class="mt-4 space-y-2 text-sm">
                <div class="flex justify-between">
                    <span>Avg Premium</span
                    ><span>${{ '%.0f'|format(avg_premium) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>Focus Metric</span><span>Winnability-weighted</span>
                </div>
                <div class="flex justify-between">
                    <span>Alerts</span><span>â€”</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accounts table -->
<div class="mt-6 glass-panel p-0 overflow-x-auto">
    <div class="flex items-center justify-between px-4 py-3">
        <h2 class="text-lg font-semibold">My Accounts</h2>
        <div class="text-xs opacity-70">
            Top prioritized accounts â€¢
            <a href="{{ url_for('submissions') }}" class="link">view all</a>
        </div>
    </div>
    <table class="table table-glass text-sm">
        <thead>
            <tr>
                <th class="th">Account Name</th>
                <th class="th">Type</th>
                <th class="th">Estimated Premium</th>
                <th class="th">Broker</th>
                <th class="th">Effective Date</th>
                <th class="th">Loss Ratio</th>
                <th class="th">Status</th>
                <th class="th">Appetite</th>
                <th class="th">Triage Score</th>
                <th class="th">Winnability</th>
                <th class="th">Rated Premium</th>
            </tr>
        </thead>
        <tbody id="acct_body"></tbody>
    </table>
    <div class="px-4 py-3 text-xs opacity-70">
        Showing top results by priority score
    </div>
</div>

<!-- Persona Modal: removed (use global in base.html) -->

<script>
    let ALL = [];
    let currentFilter = "all";
    let currentData = [];

    function getActiveMode() {
        return localStorage.getItem("ACTIVE_MODE") || "balanced_growth";
    }
    function setActiveMode(m) {
        localStorage.setItem("ACTIVE_MODE", m);
    }

    let lastHash = "";
    async function loadHome() {
        const el = document.getElementById("worklist");
        await withLoading(el, async () => {
            const sel = document.getElementById("home_mode");
            const mode = sel?.value || getActiveMode();
            const j = await fetchJSON(
                `/api/classified_mode?mode=${encodeURIComponent(mode)}`
            );
            document.getElementById("mode_expl").textContent =
                j.mode_explanation || "";
            if ((j.count || 0) === 0) {
                const fb = "balanced_growth";
                toast("Mode empty â€” switched to Balanced", "error");
                setActiveMode(fb);
                if (sel) sel.value = fb;
                const jj = await fetchJSON(
                    `/api/classified_mode?mode=${encodeURIComponent(fb)}`
                );
                document.getElementById("mode_expl").textContent =
                    jj.mode_explanation || "";
                const h2 = JSON.stringify(jj.data);
                lastHash = h2;
                renderWorklistRows(jj.data || [], fb);
                return;
            }
            if ((j.count || 0) > 0) {
                localStorage.setItem("LAST_NON_EMPTY_MODE", mode);
            }
            const newHash = JSON.stringify(j.data || []);
            if (newHash !== lastHash) {
                lastHash = newHash;
                renderWorklistRows(j.data || [], mode);
                toast(`Updated ${j.count} results â€” ${mode}`, "success");
            }
        });
        const topState = Object.keys(stateCounts).reduce((a, b) => stateCounts[a] > stateCounts[b] ? a : b, 'â€”');
        
        const avgWinnability = data.length ? 
            data.reduce((sum, item) => sum + (item.winnability || 0), 0) / data.length : 0;
            
        const inAppetite = data.filter(item => item.appetite_status === 'IN' || item.appetite_status === 'TARGET').length;
        const conversionRate = data.length ? (inAppetite / data.length * 100) : 0;
        
        document.getElementById('avg-premium-targets').textContent = 
            avgPremiumTargets > 0 ? `$${Math.round(avgPremiumTargets).toLocaleString()}` : 'â€”';
        document.getElementById('top-state').textContent = topState;
        document.getElementById('avg-winnability').textContent = 
            avgWinnability > 0 ? `${(avgWinnability * (avgWinnability > 1 ? 1 : 100)).toFixed(0)}%` : 'â€”';
        document.getElementById('conversion-rate').textContent = `${conversionRate.toFixed(1)}%`;
    }

    // Quick action functions
    function exportOpportunities() {
        toast('Export functionality will be available soon', 'info');
    }

    function showBulkActions() {
        toast('Bulk actions panel will be available soon', 'info');
    }

    function showAnalytics() {
        window.location.href = '/insights';
    }
    
    // Enhanced data loading and initialization
    async function loadHome() {
        try {
            const mode = getActiveMode();
            const response = await fetchJSON(`/api/classified_mode?mode=${encodeURIComponent(mode)}`);
            
            // Store all data
            ALL = response.data || [];
            
            // Apply current filter
            applyFilter(currentFilter);
            
            updateModeChip();
            updateLastUpdated('worklist_last');
        } catch (error) {
            toast('Failed to load opportunities: ' + error.message, 'error');
        }
    }

    function updateModeChip(){
        const mode = getActiveMode();
        const chip = document.getElementById('mode_chip');
        if(chip) chip.innerHTML = `Mode: ${prettyMode(mode)}`;
    }
    
    function updateLastUpdated(elId){
        const el = document.getElementById(elId);
        if(!el) return;
        const d = new Date();
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        el.textContent = `Last updated ${hh}:${mm}`;
    }

    // Event handlers
    document.addEventListener('DOMContentLoaded', () => {
        // Filter button handlers
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                applyFilter(btn.dataset.filter);
            });
        });

        // Refresh handler
        document.getElementById('btn_refresh_home')?.addEventListener('click', () => {
            fetchJSON('/api/refresh', { method: 'POST' })
                .then(() => {
                    toast('Data refreshed', 'success');
                    loadHome();
                })
                .catch(err => toast('Refresh failed: ' + err.message, 'error'));
        });

        // Mode change handler
        document.getElementById('home_mode')?.addEventListener('change', (e) => {
            setActiveMode(e.target.value);
            loadHome();
        });

        // Load modes and initialize
        loadModes().then(() => {
            loadHome();
        });
    });

    // Load available modes
    async function loadModes() {
        try {
            const modes = await fetchJSON('/api/modes');
            const selects = ['home_mode'];
            
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                
                sel.innerHTML = modes.map(m => 
                    `<option value="${m.key}">${m.label}</option>`
                ).join('');
                
                sel.value = getActiveMode();
            });
        } catch (error) {
            console.error('Failed to load modes:', error);
        }
    }
    };

    async function populateHomeModes() {
        const wrap = document.getElementById('home_mode_wrap');
        try {
            const j = await fetchJSON("/api/modes");
            const modes = (j.modes || []).filter(Boolean);
            const sel = document.getElementById("home_mode");
            if (!sel) return;
            if (!modes.length) {
                wrap?.classList?.add('hidden');
                sel.innerHTML = '<option value="" disabled selected>No modes available</option>';
                return;
            }
            wrap?.classList?.remove('hidden');
            sel.innerHTML = modes
                .map((m) => `<option value="${m}">${m.replace(/_/g,' ')}</option>`)
                .join("");
            const active = getActiveMode();
            sel.value = modes.includes(active)
                ? active
                : (modes.includes("balanced_growth") ? "balanced_growth" : (modes[0] || ""));
            setActiveMode(sel.value);
            sel.onchange = () => {
                setActiveMode(sel.value);
                updateModeChip();
                try { window._worklistRefreshCtl?.triggerNow(); } catch {}
                loadHome().catch((err) => toast("Load failed: " + err.message, "error"));
            };
        } catch (e) {
            console.warn("Failed to load modes", e);
            wrap?.classList?.add('hidden');
        }
    }

    // Persona modal wiring
    const modal = document.getElementById("persona_modal");
    document.getElementById("btn_persona").onclick = () => {
        modal.classList.remove("hidden");
    };
    document.getElementById("persona_close").onclick = () => {
        modal.classList.add("hidden");
    };

    function gatherAnswers() {
        const con = (document.getElementById("ans_con_list").value || "")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
        const a = {
            aggressiveness: Number(
                document.getElementById("ans_aggr").value || 3
            ),
            objective: document.getElementById("ans_obj").value || "balance",
            premium_lo: Number(
                document.getElementById("ans_prem_lo").value || 100000
            ),
            premium_hi: Number(
                document.getElementById("ans_prem_hi").value || 1500000
            ),
            max_lr: Number(document.getElementById("ans_lr").value || 0.65),
            tiv_max: Number(
                document.getElementById("ans_tiv").value || 150000000
            ),
            new_only: !!document.getElementById("ans_new_only").checked,
            strict_construction:
                !!document.getElementById("ans_good_con").checked,
            construction_pref: con,
            comments: document.getElementById("ans_comments").value || "",
        };
        try { localStorage.setItem('personaAnswers', JSON.stringify(a)); } catch {}
        return a;
    }

    document.getElementById("persona_seed").onclick = async () => {
        const ans = gatherAnswers();
        const status = document.getElementById("persona_status");
        try {
            status.textContent = "Seedingâ€¦";
            document.getElementById("persona_seed").setAttribute('disabled','');
            document.getElementById("persona_submit").setAttribute('disabled','');
            const res = await fetchJSON("/api/persona/seed", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ answers: ans }),
            });
            toast("Seed created", "success");
            setActiveMode("custom");
            await populateHomeModes();
            document.getElementById("home_mode").value = "custom";
            await loadHome();
        } catch (e) {
            toast("Seed failed: " + e.message, "error");
        } finally {
            status.textContent = "";
            document.getElementById("persona_seed").removeAttribute('disabled');
            document.getElementById("persona_submit").removeAttribute('disabled');
        }
    };

    document.getElementById("persona_submit").onclick = async () => {
        const ans = gatherAnswers();
        const status = document.getElementById("persona_status");
        try {
            status.textContent = "Calling Geminiâ€¦";
            document.getElementById("persona_seed").setAttribute('disabled','');
            document.getElementById("persona_submit").setAttribute('disabled','');
            const res = await fetchJSON("/api/persona/propose", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    answers: ans,
                    goal_text: ans.comments || "",
                }),
            });
            toast("Persona proposed and set as custom", "success");
            setActiveMode("custom");
            const d = new Date();
            const hh = d.getHours().toString().padStart(2,'0');
            const mm = d.getMinutes().toString().padStart(2,'0');
            localStorage.setItem('LAST_REFINED_AT', `${hh}:${mm}`);
            await populateHomeModes();
            document.getElementById("home_mode").value = "custom";
            await loadHome();
            modal.classList.add("hidden");
        } catch (e) {
            toast("Propose failed: " + e.message, "error");
        } finally {
            status.textContent = "";
            document.getElementById("persona_seed").removeAttribute('disabled');
            document.getElementById("persona_submit").removeAttribute('disabled');
        }
    };

    // Preview rendering (no server override path; show summary only)
    (function(){
      const prevBtn = document.getElementById('persona_preview_btn');
      if (!prevBtn) return;
      prevBtn.onclick = () => {
        const a = gatherAnswers();
        const pv = document.getElementById('persona_preview');
        if (!pv) return;
        const lines = [];
        lines.push(`Aggressiveness: ${a.aggressiveness} Â· Objective: ${a.objective}`);
        lines.push(`Premium: $${a.premium_lo.toLocaleString()}â€“$${a.premium_hi.toLocaleString()} Â· Max LR: ${a.max_lr}`);
        lines.push(`TIV â‰¤ $${a.tiv_max.toLocaleString()} Â· New only: ${a.new_only ? 'yes' : 'no'} Â· Good construction: ${a.strict_construction ? 'yes' : 'no'}`);
        pv.textContent = `Preview â€” ${lines.join(' â€¢ ')} Â· Estimated count: not available in demo`;
      };
    })();

    // Restore answers from localStorage on modal open
    document.getElementById("btn_persona").addEventListener('click', () => {
        try {
          const raw = localStorage.getItem('personaAnswers');
          if (!raw) return;
          const a = JSON.parse(raw);
          if (a.aggressiveness) document.getElementById('ans_aggr').value = a.aggressiveness;
          if (a.objective) document.getElementById('ans_obj').value = a.objective;
          if (a.premium_lo) document.getElementById('ans_prem_lo').value = a.premium_lo;
          if (a.premium_hi) document.getElementById('ans_prem_hi').value = a.premium_hi;
          if (a.max_lr) document.getElementById('ans_lr').value = a.max_lr;
          if (a.tiv_max) document.getElementById('ans_tiv').value = a.tiv_max;
          document.getElementById('ans_new_only').checked = !!a.new_only;
          document.getElementById('ans_good_con').checked = !!a.strict_construction;
          if (Array.isArray(a.construction_pref)) document.getElementById('ans_con_list').value = a.construction_pref.join(', ');
          if (a.comments) document.getElementById('ans_comments').value = a.comments;
        } catch {}
    });

    // Initial load
    populateHomeModes()
        .then(() => loadHome())
        .catch(() => loadHome());

    let autoH;
    function startAuto() {
        clearInterval(autoH);
        autoH = setInterval(() => {
            if (!document.hidden) {
                loadHome().catch((err) =>
                    toast("Auto-refresh failed: " + err.message, "error")
                );
            }
        }, 45000);
    }
    function stopAuto() {
        clearInterval(autoH);
    }
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) stopAuto();
        else startAuto();
    });
    startAuto();
</script>
{% endblock %}
