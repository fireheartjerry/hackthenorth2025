{% extends "base.html" %} {% block content %}
<!-- Modern Submissions Dashboard -->
<div class="submissions-hero glass-panel p-8 mb-8">
    <div class="flex items-center justify-between mb-6">
        <div class="hero-content">
            <h1 class="text-2xl font-bold tracking-tight bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
                Submission Pipeline
            </h1>
            <p class="text-sm opacity-75 mt-2">
                Intelligent prioritization and advanced filtering for maximum efficiency
            </p>
        </div>
        <div class="pipeline-stats flex items-center gap-6">
            <div class="stat-bubble">
                <div class="stat-value" id="subs_count">‚Äî</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-bubble target">
                <div class="stat-value" id="target_count">‚Äî</div>
                <div class="stat-label">Targets</div>
            </div>
            <div class="stat-bubble">
                <div class="stat-value" id="completion_rate">‚Äî%</div>
                <div class="stat-label">Processed</div>
            </div>
        </div>
    </div>
    
    <!-- Real-time Pipeline Status -->
    <div class="pipeline-status mt-8">
        <div class="status-bar">
            <div class="status-segment target" style="width: 25%"></div>
            <div class="status-segment in" style="width: 45%"></div>
            <div class="status-segment out" style="width: 30%"></div>
        </div>
        <div class="status-legend mt-3">
            <span class="legend-item target">üéØ Target (25%)</span>
            <span class="legend-item in">‚úÖ In-Appetite (45%)</span>
            <span class="legend-item out">‚ùå Out-of-Appetite (30%)</span>
        </div>
    </div>
</div>
    
<!-- Smart Filtering System -->
<div class="smart-filters glass-panel p-8 mb-8">
    <!-- Filter Header -->
    <div class="filter-header mb-8">
        <div class="flex items-center justify-between">
            <div class="filter-title-section">
                <h3 class="text-xl font-bold flex items-center gap-4">
                    <span class="filter-icon text-2xl">üîç</span>
                    <div>
                        <div>Smart Filters</div>
                        <p class="text-sm opacity-75 font-normal mt-1">Intelligent filtering with saved presets and AI assistance</p>
                    </div>
                </h3>
            </div>
            <div class="filter-actions flex gap-4">
                <button id="save_filter_preset" class="control-btn glass-btn-small">
                    <i class="fa-solid fa-bookmark"></i>
                    <span>Save Preset</span>
                </button>
                <button id="clear_all_filters" class="control-btn glass-btn-small">
                    <i class="fa-solid fa-trash-can"></i>
                    <span>Clear All</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Filter Presets - Multiselect Layout -->
    <div class="filter-presets mb-10">
        <div class="preset-header mb-4">
            <div class="flex items-center justify-between">
                <div class="preset-info">
                    <h4 class="text-sm font-semibold text-gray-300">Smart Categories</h4>
                    <p class="text-xs text-gray-400 mt-1">Select multiple categories for AI-powered analysis</p>
                </div>
                <div class="preset-actions flex items-center gap-3">
                    <span class="selected-count text-xs text-indigo-400" id="selected_categories_count">0 selected</span>
                    <button id="clear_categories" class="text-xs text-gray-400 hover:text-gray-200 transition-colors">Clear All</button>
                    <button id="apply_ai_sorting" class="glass-btn-small ai-btn disabled" disabled>
                        <i class="fa-solid fa-sparkles"></i>
                        <span>Filter</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="preset-row-1 grid grid-cols-3 gap-6 mb-6">
            <div class="filter-preset-card enhanced multiselect" data-preset="targets">
                <div class="preset-checkbox">
                    <input type="checkbox" id="preset_targets" class="preset-check">
                    <label for="preset_targets" class="preset-check-label"></label>
                </div>
                <div class="preset-icon">üéØ</div>
                <div class="preset-content">
                    <div class="preset-title">Priority Targets</div>
                    <div class="preset-desc">High-value opportunities</div>
                </div>
                <div class="preset-count" id="preset_targets_count">‚Äî</div>
            </div>
            
            <div class="filter-preset-card enhanced multiselect" data-preset="in-appetite">
                <div class="preset-checkbox">
                    <input type="checkbox" id="preset_in_appetite" class="preset-check">
                    <label for="preset_in_appetite" class="preset-check-label"></label>
                </div>
                <div class="preset-icon">‚úÖ</div>
                <div class="preset-content">
                    <div class="preset-title">In-Appetite</div>
                    <div class="preset-desc">Ready for review</div>
                </div>
                <div class="preset-count" id="preset_in_count">‚Äî</div>
            </div>
            
            <div class="filter-preset-card enhanced multiselect" data-preset="high-value">
                <div class="preset-checkbox">
                    <input type="checkbox" id="preset_high_value" class="preset-check">
                    <label for="preset_high_value" class="preset-check-label"></label>
                </div>
                <div class="preset-icon">üíé</div>
                <div class="preset-content">
                    <div class="preset-title">High Value</div>
                    <div class="preset-desc">$100K+ premium</div>
                </div>
                <div class="preset-count" id="preset_high_count">‚Äî</div>
            </div>
        </div>
        
        <div class="preset-row-2 grid grid-cols-3 gap-6">
            <div class="filter-preset-card enhanced multiselect" data-preset="new-business">
                <div class="preset-checkbox">
                    <input type="checkbox" id="preset_new_business" class="preset-check">
                    <label for="preset_new_business" class="preset-check-label"></label>
                </div>
                <div class="preset-icon">üÜï</div>
                <div class="preset-content">
                    <div class="preset-title">New Business</div>
                    <div class="preset-desc">Fresh opportunities</div>
                </div>
                <div class="preset-count" id="preset_new_count">‚Äî</div>
            </div>
            
            <div class="filter-preset-card enhanced multiselect" data-preset="recent">
                <div class="preset-checkbox">
                    <input type="checkbox" id="preset_recent" class="preset-check">
                    <label for="preset_recent" class="preset-check-label"></label>
                </div>
                <div class="preset-icon">‚è∞</div>
                <div class="preset-content">
                    <div class="preset-title">Recent</div>
                    <div class="preset-desc">Last 7 days</div>
                </div>
                <div class="preset-count" id="preset_recent_count">‚Äî</div>
            </div>
            
            <div class="filter-preset-card enhanced multiselect" data-preset="geographic">
                <div class="preset-checkbox">
                    <input type="checkbox" id="preset_geographic" class="preset-check">
                    <label for="preset_geographic" class="preset-check-label"></label>
                </div>
                <div class="preset-icon">üó∫Ô∏è</div>
                <div class="preset-content">
                    <div class="preset-title">Geographic Focus</div>
                    <div class="preset-desc">Target states priority</div>
                </div>
                <div class="preset-count" id="preset_geographic_count">‚Äî</div>
            </div>
        </div>
    </div>

    <!-- Advanced Filters - Improved Layout -->
    <div class="advanced-filters mb-10">
        <div class="filters-toggle mb-6">
            <button id="toggle_advanced" class="toggle-btn glass-btn-small">
                <i class="fa-solid fa-sliders toggle-icon"></i>
                <span class="toggle-text">Advanced Filters</span>
                <i class="fa-solid fa-chevron-down toggle-arrow"></i>
            </button>
        </div>
        
        <div id="advanced_filter_panel" class="filter-panel hidden">
            <div class="filter-grid-enhanced">
                <!-- Top Row - Core Filters -->
                <div class="filter-row flex gap-8 mb-8">
                    <div class="filter-group flex-1">
                        <label class="filter-label">
                            <i class="fa-solid fa-map-location-dot text-indigo-400 mr-2"></i>
                            State/Region
                        </label>
                        <div class="filter-input-enhanced">
                            <input id="f_state" class="filter-input" placeholder="e.g., CA, FL, TX" />
                        </div>
                    </div>
                    
                    <div class="filter-group flex-1">
                        <label class="filter-label">
                            <i class="fa-solid fa-target text-emerald-400 mr-2"></i>
                            Appetite Status
                        </label>
                        <select id="f_status" class="filter-select">
                            <option value="">Any Status</option>
                            <option value="TARGET">üéØ Target</option>
                            <option value="IN">‚úÖ In-Appetite</option>
                            <option value="OUT">‚ùå Out-of-Appetite</option>
                        </select>
                    </div>
                    
                    <div class="filter-group flex-1">
                        <label class="filter-label">
                            <i class="fa-solid fa-chart-line text-purple-400 mr-2"></i>
                            Analysis Mode
                        </label>
                        <select id="f_mode" class="filter-select">
                            <option value="" disabled selected>Loading modes‚Ä¶</option>
                        </select>
                    </div>
                </div>
                
                <!-- Bottom Row - Range and Search -->
                <div class="filter-row flex gap-8">
                    <div class="filter-group flex-1">
                        <label class="filter-label">
                            <i class="fa-solid fa-dollar-sign text-emerald-400 mr-2"></i>
                            Premium Range
                        </label>
                        <div class="range-inputs flex items-center gap-4">
                            <input id="f_min" class="range-input flex-1" type="number" placeholder="Min (e.g., 50,000)" />
                            <span class="range-separator text-gray-400">to</span>
                            <input id="f_max" class="range-input flex-1" type="number" placeholder="Max (e.g., 175,000)" />
                        </div>
                    </div>
                    
                    <div class="filter-group flex-2">
                        <label class="filter-label">
                            <i class="fa-solid fa-magnifying-glass text-indigo-400 mr-2"></i>
                            Search Accounts
                        </label>
                        <div class="search-input-enhanced">
                            <input id="f_q" class="search-input" placeholder="Search by account name, broker, or keywords..." />
                            <button class="search-clear hidden" id="clear_search">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Action Bar - Reorganized -->
    <div class="filter-actions-bar">
        <!-- Primary Actions -->
        <div class="primary-actions flex items-center gap-4">
            <button id="btn_apply" class="glass-btn-small primary-action">
                <i class="fa-solid fa-filter"></i>
                <span>Apply Filters</span>
            </button>
            <button id="btn_clear" class="glass-btn-small secondary-action">
                <i class="fa-solid fa-eraser"></i>
                <span>Clear All</span>
            </button>
            <div class="action-separator"></div>
            <button id="btn_save_filter" class="glass-btn-small">
                <i class="fa-solid fa-bookmark"></i>
                <span>Save Filter</span>
            </button>
        </div>
        
        <!-- Utility Actions -->
        <div class="utility-actions flex items-center gap-3">
            <button id="btn_refresh" class="glass-btn-small utility-action" title="Refresh Data">
                <i class="fa-solid fa-arrows-rotate"></i>
            </button>
            <button id="btn_export" class="glass-btn-small utility-action" title="Export Results">
                <i class="fa-solid fa-download"></i>
            </button>
        </div>
    </div>
    
    <!-- AI Summary Widget -->
    <div id="ai_summary_widget" class="hidden mt-4 p-4 bg-gradient-to-r from-purple-500/10 to-indigo-500/10 rounded-lg border border-purple-400/30">
        <div class="flex items-start gap-3">
            <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-sm">ü§ñ</span>
                </div>
            </div>
            <div class="flex-grow">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-semibold text-purple-300">Gemini AI Activity</h4>
                    <button id="ai_summary_close" class="text-purple-400 hover:text-purple-200 opacity-70 hover:opacity-100 transition-opacity">
                        <span class="text-xs">‚úï</span>
                    </button>
                </div>
                <div id="ai_summary_content" class="text-xs text-slate-300 space-y-1">
                    <!-- AI activity will be populated here -->
                </div>
                <div class="flex items-center justify-between mt-3 pt-2 border-t border-purple-400/20">
                    <div class="text-xs text-purple-400/80">
                        <span id="ai_model_info">Powered by Gemini Flash 2.0</span>
                    </div>
                    <div class="text-xs text-purple-400/60" id="ai_last_used">
                        <!-- Last used timestamp -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Submissions Table -->
<div class="submissions-table-panel card p-0 mt-8">
    <div class="table-header glass-panel-dark p-8 border-b border-white/20">
        <div class="flex items-start justify-between gap-8">
            <div class="table-title-section flex-1">
                <h3 class="text-xl font-light text-white mb-2">üìä Submissions Analysis</h3>
                <p class="text-sm text-gray-300 font-light mb-5">Prioritized, in‚Äëappetite opportunities with clear rationale</p>
                <div class="table-stats flex flex-wrap items-center gap-3">
                    <span class="stat-chip">
                        <span class="dot any"></span>
                        Total
                        <b id="stat_total">‚Äî</b>
                    </span>
                    <span class="stat-chip target">
                        <span class="dot target"></span>
                        Target
                        <b id="stat_target">‚Äî</b>
                    </span>
                    <span class="stat-chip in">
                        <span class="dot in"></span>
                        In
                        <b id="stat_in">‚Äî</b>
                    </span>
                    <span class="stat-chip out">
                        <span class="dot out"></span>
                        Out
                        <b id="stat_out">‚Äî</b>
                    </span>
                </div>
            </div>
            
            <div class="table-controls flex flex-col items-end gap-4">
                <div class="view-options flex gap-3">
                    <button class="glass-btn-small active" data-view="table">
                        <i class="fa-solid fa-table text-sm"></i>
                        <span>Table</span>
                    </button>
                    <button class="glass-btn-small" data-view="cards">
                        <i class="fa-solid fa-th-large text-sm"></i>
                        <span>Cards</span>
                    </button>
                </div>
                
                <div class="table-actions flex gap-3">
                    <button class="glass-btn-small" id="bulk-actions-btn">
                        <i class="fa-solid fa-tasks text-sm"></i>
                        <span>Bulk Actions</span>
                    </button>
                    <button class="glass-btn-small" id="export-submissions-btn">
                        <i class="fa-solid fa-download text-sm"></i>
                        <span>Export</span>
                    </button>
                    <button class="glass-btn-small" id="columns-btn">
                        <i class="fa-solid fa-columns text-sm"></i>
                        <span>Columns</span>
                    </button>
                </div>

                <div class="page-size-selector mt-2">
                    <span class="page-size-label">Rows</span>
                    <div class="page-size-select-wrap">
                        <select id="page-size-top" class="page-size-select" aria-label="Rows per page (top)">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <i class="fa-solid fa-chevron-down select-caret" aria-hidden="true"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="table-loading" class="loading-skeleton hidden">
        <div class="table-skeleton">
            <div class="skeleton-row" style="width: 100%; height: 3rem;"></div>
            <div class="skeleton-row" style="width: 95%; height: 2.5rem;"></div>
            <div class="skeleton-row" style="width: 98%; height: 2.5rem;"></div>
            <div class="skeleton-row" style="width: 92%; height: 2.5rem;"></div>
            <div class="skeleton-row" style="width: 97%; height: 2.5rem;"></div>
        </div>
    </div>

    <!-- Table Container -->
    <div class="table-container overflow-x-auto">
        <!-- Enhanced Table -->
        <div class="overflow-x-auto">
            <table id="subs_table" class="enhanced-submissions-table w-full text-sm">
            <thead class="border-b border-white border-opacity-10">
                <tr>
                    <th class="checkbox-col py-5 px-4">
                        <input type="checkbox" id="select-all" class="table-checkbox">
                    </th>
                    <th class="th th-sort sortable text-left py-5 px-8" data-key="priority_score">
                        <div class="th-content">
                            <i class="fa-solid fa-star th-icon"></i>
                            Priority
                            <i class="fa-solid fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-5 px-6" data-key="appetite_status">
                        <div class="th-content">
                            <i class="fa-solid fa-traffic-light th-icon"></i>
                            Status
                            <i class="fa-solid fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-5 px-6" data-key="account_name">
                        <div class="th-content">
                            <i class="fa-solid fa-building th-icon"></i>
                            Account
                            <i class="fa-solid fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-5 px-6" data-key="primary_risk_state">
                        <div class="th-content">
                            <i class="fa-solid fa-map-marker-alt th-icon"></i>
                            State
                            <i class="fa-solid fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-5 px-6" data-key="total_premium">
                        <div class="th-content">
                            <i class="fa-solid fa-money-bill-wave th-icon"></i>
                            Premium
                            <i class="fa-solid fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-5 px-6" data-key="tiv">
                        <div class="th-content">
                            <i class="fa-solid fa-dollar-sign th-icon"></i>
                            TIV
                            <i class="fa-solid fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-5 px-6" data-key="winnability">
                        <div class="th-content">
                            <i class="fa-solid fa-percentage th-icon"></i>
                            Win%
                            <i class="fa-solid fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th actions-col text-left py-5 px-6">
                        <div class="th-content">
                            <i class="fa-solid fa-cog th-icon"></i>
                            Actions
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody id="tbody">
                <!-- Submissions will be loaded here -->
            </tbody>
        </table>

        <!-- Cards container (for Cards view) -->
        <div id="cards_container" class="hidden mt-4">
            <div id="cards_grid" class="subs-cards-grid"></div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="empty-state hidden text-center py-12">
            <div class="empty-icon text-4xl mb-3">
                <i class="fa-solid fa-search"></i>
            </div>
            <h3 class="text-lg font-semibold mb-2">No submissions found</h3>
            <p class="text-sm opacity-75 mb-4">Try adjusting your filters or search criteria</p>
            <button class="control-btn" onclick="clearAllFilters()">
                <i class="fa-solid fa-xmark"></i>
                Clear Filters
            </button>
        </div>
    </div>

    <!-- Enhanced Pagination -->
    <div class="table-footer bg-gradient-to-r from-gray-50/30 to-gray-100/30 p-6 border-t border-white/10">
        <div class="flex items-center justify-between">
            <div class="table-info">
                <div class="pagination-info">
                    Showing <span id="page-start" class="font-semibold text-indigo-400">1</span>-<span id="page-end" class="font-semibold text-indigo-400">25</span> 
                    of <span id="total-count" class="font-semibold text-indigo-400">0</span> submissions
                </div>
                <div class="selected-info hidden mt-2">
                    <span id="selected-count" class="font-semibold text-emerald-400">0</span> selected
                </div>
            </div>
            
            <div class="pagination-controls flex items-center gap-4">
                <div class="page-size-selector">
                    <span class="page-size-label">Rows</span>
                    <div class="page-size-select-wrap">
                        <select id="page-size" class="page-size-select" aria-label="Rows per page">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <i class="fa-solid fa-chevron-down select-caret" aria-hidden="true"></i>
                    </div>
                </div>
                
                <div class="pagination-buttons flex items-center gap-2">
                    <button id="first-page" class="pagination-btn" disabled>
                        <i class="fa-solid fa-angles-left"></i>
                    </button>
                    <button id="prev-page" class="pagination-btn" disabled>
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <span id="pagination-numbers" class="pagination-numbers mx-2"></span>
                    <button id="next-page" class="pagination-btn">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                    <button id="last-page" class="pagination-btn">
                        <i class="fa-solid fa-angles-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Ensure utility functions are available (fallback if app.js hasn't loaded yet)
    if (typeof window.fetchJSON === 'undefined') {
        window.fetchJSON = async function(url, opts={}){
            const res = await fetch(url, opts);
            if(!res.ok){
                let msg = `${res.status} ${res.statusText}`;
                try { const j = await res.json(); if(j && j.error) msg = j.error; } catch (e) {}
                throw new Error(msg);
            }
            return res.json();
        }
    }
    
    // Money short format for compact columns
    function fmtMoneyShort(v){
        const n = Number(v || 0);
        if (n >= 1e9) return '$' + (n/1e9).toLocaleString(undefined, {minimumFractionDigits:1, maximumFractionDigits:1}) + 'B';
        if (n >= 1e6) return '$' + (n/1e6).toLocaleString(undefined, {minimumFractionDigits:1, maximumFractionDigits:1}) + 'M';
        if (n >= 1e3) return '$' + Math.round(n/1e3).toLocaleString() + 'K';
        return '$' + Math.round(n).toLocaleString();
    }
    
    if (typeof window.withLoading === 'undefined') {
        window.withLoading = async function(el, fn){
            try{ el?.classList?.add("is-loading"); return await fn(); } finally { el?.classList?.remove("is-loading"); }
        }
    }
    
    if (typeof window.toast === 'undefined') {
        window.toast = function(msg, type = "info") {
            const host = document.getElementById("toasts") || (function(){
                const d = document.createElement("div");
                d.id = "toasts"; d.className = "toasts"; document.body.appendChild(d); return d;
            })();
            const el = document.createElement("div");
            el.className = `toast ${type}`;
            el.textContent = msg;
            host.appendChild(el);
            setTimeout(()=>{ el.classList.add("out"); setTimeout(()=>host.removeChild(el), 200); }, 2800);
        }
    }
    
    let SORT_BY = "priority_score";
    let SORT_DIR = "desc";
    let CURRENT_PAGE = 1;
    let PAGE_SIZE = 25;
    let TOTAL_ITEMS = 0;
    // View state helpers
    function getSubsView(){ try { return localStorage.getItem('SUBS_VIEW') || 'table'; } catch(e){ return 'table'; } }
    function setSubsView(v){ try { localStorage.setItem('SUBS_VIEW', v); } catch(e){} }
    
    // Ensure a consistent analysis mode is always applied
    function getActiveMode() {
        const sel = document.getElementById('f_mode');
        const fromSelect = sel && sel.value ? sel.value : null;
        const fromLS = localStorage.getItem('ACTIVE_MODE');
        return fromSelect || fromLS || 'balanced_growth';
    }
    function setActiveMode(val) {
        try { localStorage.setItem('ACTIVE_MODE', val); } catch (e) {}
        const sel = document.getElementById('f_mode');
        if (sel && sel.value !== val) sel.value = val;
    }
    let ALL_SUBMISSIONS = [];
    let currentPreset = "all";
    let LAST_PARAMS = {};

    // Enhanced table rendering with visual priorities and bulk selection
    function renderTable(rows){
        // Route to cards renderer when needed
        if (getSubsView() !== 'table') { return renderCards(rows); }
        console.log('renderTable called with', rows ? rows.length : 0, 'rows');
        const tbody = document.getElementById("tbody");
        const emptyState = document.getElementById("empty-state");
        const countSpan = document.getElementById("subs_count");
        
        if (!rows || rows.length === 0) {
            console.log('No rows to display, showing empty state');
            tbody.innerHTML = "";
            emptyState?.classList.remove("hidden");
            countSpan.textContent = "0";
            updateStats({ total: 0, target: 0, processed: 0 });
            updatePagination([]);
            return;
        }

        console.log('Processing', rows.length, 'rows for pagination');
        // Get paginated rows
        const paginatedRows = updatePagination(rows);
        console.log('Got', paginatedRows.length, 'paginated rows for display');

        emptyState?.classList.add("hidden");
        countSpan.textContent = rows.length.toLocaleString();
        
        // Calculate stats for hero and header chips (factual, from rows)
        const stats = {
            total: rows.length,
            target: rows.filter(r => r.appetite_status === 'TARGET').length,
            in: rows.filter(r => r.appetite_status === 'IN').length,
            out: rows.filter(r => r.appetite_status === 'OUT').length,
        };
        // Consider "processed" as items that are Target or In-Appetite (triaged for action)
        stats.processed = stats.target + stats.in;
        console.log('Calculated stats:', stats);
        updateStats(stats);
        updateHeaderChips(stats);
        
        tbody.innerHTML = paginatedRows.map((r) => {
            const appetiteClass = r.appetite_status === 'TARGET' ? 'target-row' : 
                                r.appetite_status === 'IN' ? 'in-row' : 'out-row';
            
            const priorityClass = r.priority_score >= 7 ? 'priority-high' : 
                                r.priority_score >= 4 ? 'priority-medium' : 'priority-low';
            
            const appetiteBadge = r.appetite_status === 'TARGET' ? 
                                '<span class="appetite-indicator appetite-target pill">üéØ TARGET</span>' :
                                r.appetite_status === 'IN' ? 
                                '<span class="appetite-indicator appetite-in pill">‚úÖ IN</span>' :
                                '<span class="appetite-indicator appetite-out pill">‚ùå OUT</span>';
            
            const winnabilityPercent = typeof r.winnability === 'number' ? 
                                      Number(r.winnability > 1 ? r.winnability : r.winnability * 100).toFixed(0) : '‚Äî';
            
            return `
                <tr class="table-row ${appetiteClass} ${r.target_opportunity ? 'target-opportunity-row' : ''}" data-id="${r.id}" onclick="navigateToDetail(${r.id}, event)">
                    <td class="td py-4 px-3 text-center">
                        <input type="checkbox" class="table-checkbox row-checkbox" data-id="${r.id}" onclick="event.stopPropagation()">
                    </td>
                    <td class="td py-4 px-6">
                        <div class="flex items-center gap-2">
                            <span class="priority-score ${priorityClass}">${Number(r.priority_score || 0).toFixed(1)}</span>
                        </div>
                    </td>
                    <td class="td py-4 px-4">
                        ${appetiteBadge}
                        ${r.target_opportunity ? '<span class="pill pill-indigo ml-2">TOP</span>' : ''}
                    </td>
                    <td class="td py-4 px-4 col-account" title="${(r.account_name || '').replace(/"/g,'&quot;')}">
                        <div class="font-semibold text-white name">${r.account_name || "‚Äî"}</div>
                        <div class="text-xs sub">${r.line_of_business || "‚Äî"}</div>
                    </td>
                    <td class="td py-4 px-4">
                        <span class="chip">${r.primary_risk_state || "‚Äî"}</span>
                    </td>
                    <td class="td py-4 px-4 text-right tabular-nums">
                        <div class="font-semibold text-emerald-300">${fmtMoneyShort(r.total_premium)}</div>
                    </td>
                    <td class="td py-4 px-4 text-right tabular-nums">
                        <div class="font-semibold">${fmtMoneyShort(r.tiv)}</div>
                    </td>
                    <td class="td py-4 px-4 text-right tabular-nums">
                        <div class="font-semibold text-purple-300">${winnabilityPercent}%</div>
                    </td>
                    <td class="td py-4 px-4">
                        <div class="flex items-center gap-2">
                            <button class="pill pill-sub text-xs" onclick="event.stopPropagation(); if(${r.id || 'null'}) explain(${r.id || 'null'})">üí° Explain</button>
                            <button class="pill pill-sub text-xs" onclick="event.stopPropagation(); if(${r.id || 'null'}) addToWatch(${r.id || 'null'})">üëÄ Watch</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join("");
        
        // Setup bulk selection handlers
        setupBulkSelection();
        updateLastUpdated();
    }

    // Cards rendering for submissions (used when view = 'cards')
    function renderCards(rows){
        const tableEl = document.getElementById('subs_table');
        const cardsWrap = document.getElementById('cards_container');
        const cardsGrid = document.getElementById('cards_grid');
        const emptyState = document.getElementById('empty-state');
        const countSpan = document.getElementById('subs_count');

        // Toggle visibility
        tableEl?.classList.add('hidden');
        cardsWrap?.classList.remove('hidden');

        if (!rows || rows.length === 0) {
            cardsGrid.innerHTML = '';
            emptyState?.classList.remove('hidden');
            if (countSpan) countSpan.textContent = '0';
            updateStats({ total: 0, target: 0, processed: 0 });
            updatePagination([]);
            return;
        }

        emptyState?.classList.add('hidden');
        if (countSpan) countSpan.textContent = rows.length.toLocaleString();

        // Stats
        const stats = {
            total: rows.length,
            target: rows.filter(r => r.appetite_status === 'TARGET').length,
            in: rows.filter(r => r.appetite_status === 'IN').length,
            out: rows.filter(r => r.appetite_status === 'OUT').length,
        };
        stats.processed = stats.target + stats.in;
        updateStats(stats);
        updateHeaderChips(stats);

        // Pagination slice
        const pageRows = updatePagination(rows);
        cardsGrid.innerHTML = pageRows.map(r => `
            <a class="subs-card opportunity-card ${r.appetite_status==='TARGET'?'target-opportunity': (r.appetite_status==='IN'?'in-opportunity':'out-opportunity')} ${r.target_opportunity ? 'target-opportunity-glow' : ''}" href="/detail/${r.id}">
                <div class=\"flex items-start justify-between mb-1\">
                    <div class=\"font-medium\">${r.account_name || '-'}</div>
                    ${r.appetite_status ? `<span class=\"pill ${r.appetite_status==='TARGET'?'pill-indigo': (r.appetite_status==='IN'?'pill-emerald':'pill-rose')}\">${r.appetite_status}</span>` : ''}
                </div>
                <div class=\"text-sm opacity-80 mb-2\">${r.primary_risk_state || '-'} ¬∑ ${r.line_of_business || '-'} ¬∑ $${Math.round(r.total_premium||0).toLocaleString()}</div>
                <div class=\"flex items-center justify-between text-xs opacity-90\">
                    <span>Score ${Number(r.priority_score||0).toFixed(1)}</span>
                    <span>Win ${Number((r.winnability>1?r.winnability:(r.winnability||0)*100)).toFixed(0)}%</span>
                </div>
                ${r.target_opportunity ? '<div class="top-banner">TOP TARGET</div>' : ''}
            </a>
        `).join('');
    }

    function updateHeaderChips(stats){
        const set = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.textContent = typeof val === 'number' ? val.toLocaleString() : String(val ?? '‚Äî');
        };
        set('stat_total', stats.total ?? '‚Äî');
        set('stat_target', stats.target ?? '‚Äî');
        set('stat_in', stats.in ?? '‚Äî');
        set('stat_out', stats.out ?? '‚Äî');
    }

    // Pagination functions
    function updatePagination(filteredRows) {
        console.log('updatePagination called with', filteredRows.length, 'items');
        TOTAL_ITEMS = filteredRows.length;
        const totalPages = Math.ceil(TOTAL_ITEMS / PAGE_SIZE);
        console.log('Total pages:', totalPages, 'Current page:', CURRENT_PAGE, 'Page size:', PAGE_SIZE);
        
        // Update pagination info
        const start = Math.min((CURRENT_PAGE - 1) * PAGE_SIZE + 1, TOTAL_ITEMS);
        const end = Math.min(CURRENT_PAGE * PAGE_SIZE, TOTAL_ITEMS);
        
        const pageStartEl = document.getElementById('page-start');
        const pageEndEl = document.getElementById('page-end');
        const totalCountEl = document.getElementById('total-count');
        
        if (pageStartEl) pageStartEl.textContent = TOTAL_ITEMS > 0 ? start.toLocaleString() : '0';
        if (pageEndEl) pageEndEl.textContent = end.toLocaleString();
        if (totalCountEl) totalCountEl.textContent = TOTAL_ITEMS.toLocaleString();
        
        console.log('Updated pagination display:', start, '-', end, 'of', TOTAL_ITEMS);
        
        // Update pagination buttons
        const firstBtn = document.getElementById('first-page');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const lastBtn = document.getElementById('last-page');
        
        if (firstBtn) firstBtn.disabled = CURRENT_PAGE <= 1;
        if (prevBtn) prevBtn.disabled = CURRENT_PAGE <= 1;
        if (nextBtn) nextBtn.disabled = CURRENT_PAGE >= totalPages;
        if (lastBtn) lastBtn.disabled = CURRENT_PAGE >= totalPages;
        
        // Update pagination numbers
        updatePaginationNumbers(totalPages);
        
        // Return paginated rows
        const startIndex = (CURRENT_PAGE - 1) * PAGE_SIZE;
        const endIndex = startIndex + PAGE_SIZE;
        const paginatedRows = filteredRows.slice(startIndex, endIndex);
        console.log('Returning', paginatedRows.length, 'paginated rows');
        return paginatedRows;
    }
    
    function updatePaginationNumbers(totalPages) {
        const paginationNumbers = document.getElementById('pagination-numbers');
        if (!paginationNumbers) return;
        
        let numbersHtml = '';
        const startPage = Math.max(1, CURRENT_PAGE - 2);
        const endPage = Math.min(totalPages, CURRENT_PAGE + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const isActive = i === CURRENT_PAGE;
            numbersHtml += `<button class="pagination-number ${isActive ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        }
        
        paginationNumbers.innerHTML = numbersHtml;
    }
    
    function goToPage(page) {
        console.log('goToPage called with page:', page);
        CURRENT_PAGE = page;
        renderTable(ALL_SUBMISSIONS);
    }
    
    function goToFirstPage() {
        console.log('goToFirstPage called');
        CURRENT_PAGE = 1;
        renderTable(ALL_SUBMISSIONS);
    }
    
    function goToLastPage() {
        console.log('goToLastPage called');
        const totalPages = Math.ceil(TOTAL_ITEMS / PAGE_SIZE);
        CURRENT_PAGE = totalPages > 0 ? totalPages : 1;
        renderTable(ALL_SUBMISSIONS);
    }
    
    function goToPrevPage() {
        console.log('goToPrevPage called, current page:', CURRENT_PAGE);
        if (CURRENT_PAGE > 1) {
            CURRENT_PAGE--;
            renderTable(ALL_SUBMISSIONS);
        }
    }
    
    function goToNextPage() {
        console.log('goToNextPage called, current page:', CURRENT_PAGE);
        const totalPages = Math.ceil(TOTAL_ITEMS / PAGE_SIZE);
        if (CURRENT_PAGE < totalPages) {
            CURRENT_PAGE++;
            renderTable(ALL_SUBMISSIONS);
        }
    }

    // Navigation handler with better UX
    function navigateToDetail(id, event) {
        // Don't navigate if clicking on interactive elements
        if (event.target.closest('input, button, .pill')) return;
        
        const mode = document.getElementById('f_mode')?.value || '';
        window.location.href = `/detail/${id}?mode=${encodeURIComponent(mode)}`;
    }

    // Update hero section stats
    function updateStats(stats) {
        const targetCountEl = document.getElementById('target_count');
        const completionRateEl = document.getElementById('completion_rate');
        
        if (targetCountEl) targetCountEl.textContent = stats.target ? stats.target.toLocaleString() : '‚Äî';
        if (completionRateEl) {
            const rate = stats.total ? Math.round((stats.processed / stats.total) * 100) : 0;
            completionRateEl.textContent = `${rate}%`;
        }
        
        // Update pipeline status bar
        updatePipelineStatus(stats);
    }

    // Update the visual pipeline status bar
    function updatePipelineStatus(stats) {
        if (!stats.total) return;
        const targetPercent = Math.round((stats.target / stats.total) * 100);
        const inPercent = Math.round((stats.in / stats.total) * 100);
        // Ensure the three segments sum to 100 by assigning remainder to OUT
        let outPercent = 100 - targetPercent - inPercent;
        if (outPercent < 0) outPercent = 0; // guard
        
        const tgtEl = document.querySelector('.status-segment.target');
        const inEl = document.querySelector('.status-segment.in');
        const outEl = document.querySelector('.status-segment.out');
        if (tgtEl) tgtEl.style.width = `${targetPercent}%`;
        if (inEl) inEl.style.width = `${inPercent}%`;
        if (outEl) outEl.style.width = `${outPercent}%`;
        
        const liTarget = document.querySelector('.legend-item.target');
        const liIn = document.querySelector('.legend-item.in');
        const liOut = document.querySelector('.legend-item.out');
        if (liTarget) liTarget.textContent = `üéØ Target (${targetPercent}%)`;
        if (liIn) liIn.textContent = `‚úÖ In-Appetite (${inPercent}%)`;
        if (liOut) liOut.textContent = `‚ùå Out-of-Appetite (${outPercent}%)`;
    }

    // Bulk selection functionality
    function setupBulkSelection() {
        const selectAllCheckbox = document.getElementById('select-all');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const selectedInfo = document.querySelector('.selected-info');
        const selectedCountEl = document.getElementById('selected-count');
        
        // Select all handler
        if (selectAllCheckbox) {
            selectAllCheckbox.onchange = function() {
                rowCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                    updateRowSelection(cb);
                });
                updateSelectionInfo();
            };
        }
        
        // Individual row handlers
        rowCheckboxes.forEach(cb => {
            cb.onchange = function() {
                updateRowSelection(this);
                updateSelectionInfo();
                
                // Update select-all state
                const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = checkedCount === rowCheckboxes.length;
                    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < rowCheckboxes.length;
                }
            };
        });
        
        function updateRowSelection(checkbox) {
            const row = checkbox.closest('tr');
            if (row) {
                row.classList.toggle('selected', checkbox.checked);
            }
        }
        
        function updateSelectionInfo() {
            const selectedCount = document.querySelectorAll('.row-checkbox:checked').length;
            if (selectedCountEl) selectedCountEl.textContent = selectedCount.toLocaleString();
            if (selectedInfo) {
                selectedInfo.classList.toggle('hidden', selectedCount === 0);
            }
        }
    }

    // Multiselect filter management
    let selectedCategories = new Set();
    
    function updateSelectedCategories() {
        const countEl = document.getElementById('selected_categories_count');
        const aiSortBtn = document.getElementById('apply_ai_sorting');
        const count = selectedCategories.size;
        
        if (countEl) {
            countEl.textContent = count === 0 ? '0 selected' : `${count} selected`;
            countEl.classList.toggle('has-selections', count > 0);
        }
        
        if (aiSortBtn) {
            aiSortBtn.disabled = count === 0;
            aiSortBtn.classList.toggle('disabled', count === 0);
        }
    }
    
    function toggleCategory(category) {
        const checkbox = document.getElementById(`preset_${category.replace('-', '_')}`);
        const card = document.querySelector(`[data-preset="${category}"]`);
        
        if (selectedCategories.has(category)) {
            selectedCategories.delete(category);
            if (checkbox) checkbox.checked = false;
            if (card) card.classList.remove('selected');
        } else {
            selectedCategories.add(category);
            if (checkbox) checkbox.checked = true;
            if (card) card.classList.add('selected');
        }
        
        updateSelectedCategories();
    }
    
    function clearAllCategories() {
        selectedCategories.clear();
        document.querySelectorAll('.preset-check').forEach(cb => cb.checked = false);
        document.querySelectorAll('.filter-preset-card.multiselect').forEach(card => {
            card.classList.remove('selected');
        });
        updateSelectedCategories();
    }
    
    async function applyAiSorting() {
        if (selectedCategories.size === 0) {
            toast('Please select at least one category for AI sorting', 'warning');
            return;
        }
        
        const aiSortBtn = document.getElementById('apply_ai_sorting');
        const categories = Array.from(selectedCategories);
        
        try {
            await withLoading(aiSortBtn, async () => {
                // Build AI sorting request
                const aiRequest = {
                    categories: categories,
                    current_filters: {
                        state: document.getElementById("f_state")?.value || "",
                        status: document.getElementById("f_status")?.value || "",
                        min_premium: document.getElementById("f_min")?.value || "",
                        max_premium: document.getElementById("f_max")?.value || "",
                        q: document.getElementById("f_q")?.value || "",
                        mode: getActiveMode()
                    },
                    sort_preferences: {
                        sort_by: SORT_BY,
                        sort_dir: SORT_DIR
                    }
                };
                
                const response = await fetchJSON("/api/ai-sort", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(aiRequest)
                });
                
                // Show AI activity
                const aiUsed = response.ai_used ? "‚úÖ Active" : "‚ö†Ô∏è Fallback";
                const activity = `
                    <div><strong>AI Sorting Applied:</strong> ${categories.join(', ')}</div>
                    <div><strong>AI Status:</strong> ${aiUsed}</div>
                    <div><strong>Strategy:</strong> ${response.ai_summary || 'Intelligent prioritization based on selected categories'}</div>
                    ${response.ai_note ? `<div><strong>Note:</strong> ${response.ai_note}</div>` : ''}
                `;
                
                if (window.showAiSummary) {
                    window.showAiSummary(activity);
                }
                
                // Apply the AI-sorted results
                if (response.data) {
                    ALL_SUBMISSIONS = response.data;
                    renderTable(ALL_SUBMISSIONS);
                    toast(`AI sorting applied to ${response.data.length} submissions`, 'success');
                } else {
                    toast('AI sorting completed but no data returned', 'warning');
                }
            });
        } catch (error) {
            console.error('AI sorting failed:', error);
            toast('AI sorting failed: ' + error.message, 'error');
        }
    }

    // Legacy preset function for backward compatibility
    function applyPreset(preset) {
        console.log('applyPreset called with preset:', preset);
        currentPreset = preset;
        
        // Clear existing form values
        document.getElementById("f_state").value = "";
        document.getElementById("f_status").value = "";
        document.getElementById("f_min").value = "";
        document.getElementById("f_max").value = "";
        document.getElementById("f_q").value = "";
        
        // Set form values based on preset
        switch(preset) {
            case 'targets':
                document.getElementById("f_status").value = 'TARGET';
                break;
            case 'in-appetite':
                document.getElementById("f_status").value = 'IN';
                break;
            case 'high-value':
                document.getElementById("f_min").value = '100000';
                break;
            case 'new-business':
                // For new business, we'll need to add this filter to client-side filtering
                break;
            case 'recent':
                // For recent, we'll need to add this filter to client-side filtering
                break;
            case 'all':
            default:
                // No additional filters - form is already cleared
                break;
        }
        
        // Always load fresh data from the backend for presets
        const params = { mode: getActiveMode(), sort_by: SORT_BY, sort_dir: SORT_DIR };

        // Add preset-specific server-side filters
        switch(preset) {
            case 'targets':
                params.status = 'TARGET';
                break;
            case 'in-appetite':
                params.status = 'IN';
                break;
            case 'high-value':
                params.min_premium = '100000';
                break;
            case 'new-business':
                params.renewal_or_new_business = 'NEW_BUSINESS';
                break;
            case 'recent':
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                params.created_after = sevenDaysAgo.toISOString().split('T')[0];
                break;
        }

        CURRENT_PAGE = 1;
        load(params);
    }

    async function load(params = {}) {
        console.log('load() called with params:', params);
        // Always include an explicit mode so sorting/filtering doesn't change the cohort
        if (!params.mode) params.mode = getActiveMode();
        LAST_PARAMS = params;
        const qs = new URLSearchParams(params).toString();
        console.log('Fetching data with query string:', qs);
        const tbody = document.getElementById("tbody");
        
        // Reset to first page when loading new data
        CURRENT_PAGE = 1;
        
        try {
            await withLoading(tbody, async () => {
                const response = await fetchJSON("/api/classified_mode?" + qs);
                console.log('Received response with', response.data?.length || 0, 'items');
                const modeExpl = document.getElementById("sub_mode_expl");
                if (modeExpl) {
                    modeExpl.textContent = response.mode_explanation || "";
                }
                ALL_SUBMISSIONS = response.data || [];
                console.log('Updated ALL_SUBMISSIONS to', ALL_SUBMISSIONS.length, 'items');
                renderTable(ALL_SUBMISSIONS);
            });
        } catch (error) {
            console.error('Failed to load submissions:', error);
            toast("Failed to load submissions: " + error.message, "error");
        }
    }

    function clearAllFilters() {
        const fields = ['f_state', 'f_status', 'f_min', 'f_max', 'f_q'];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        // Reset mode to a stable default
        // Keep current mode; only clear filters
        applyPreset('all');
    }

    // Create applyFilters function to work with pagination
    function applyFilters() {
        const params = {
            state: document.getElementById("f_state")?.value || "",
            status: document.getElementById("f_status")?.value || "",
            min_premium: document.getElementById("f_min")?.value || "",
            max_premium: document.getElementById("f_max")?.value || "",
            q: document.getElementById("f_q")?.value || "",
            mode: getActiveMode(),
            sort_by: SORT_BY,
            sort_dir: SORT_DIR,
        };
        load(params);
    }

    function updateLastUpdated() {
        const el = document.getElementById("subs_last");
        if(!el) return;
        const d = new Date();
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        el.textContent = `Updated ${hh}:${mm}`;
    }

    // Event handlers
    document.addEventListener('DOMContentLoaded', () => {
        // Multiselect category handlers
        document.querySelectorAll('.filter-preset-card.multiselect').forEach(card => {
            const preset = card.dataset.preset;
            const checkbox = card.querySelector('.preset-check');
            
            // Handle card click (excluding checkbox area)
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.preset-checkbox')) {
                    toggleCategory(preset);
                }
            });
            
            // Handle checkbox change
            if (checkbox) {
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    toggleCategory(preset);
                });
            }
        });
        
        // Clear categories button
        const clearCategoriesBtn = document.getElementById('clear_categories');
        if (clearCategoriesBtn) {
            clearCategoriesBtn.addEventListener('click', clearAllCategories);
        }
        
        // AI sorting button
        const aiSortBtn = document.getElementById('apply_ai_sorting');
        if (aiSortBtn) {
            aiSortBtn.addEventListener('click', applyAiSorting);
        }
        
        // Initialize multiselect state
        updateSelectedCategories();

        // Legacy preset filter handlers (for backward compatibility)
        document.querySelectorAll('.filter-preset').forEach(btn => {
            btn.addEventListener('click', () => {
                applyPreset(btn.dataset.preset);
            });
        });

        // Manual filter handlers
        const applyBtn = document.getElementById("btn_apply");
        if (applyBtn) {
            applyBtn.onclick = () => {
                console.log('Apply filters button clicked');
                CURRENT_PAGE = 1; // Reset to first page when applying filters
                applyFilters();
            };
        }

        const clearBtn = document.getElementById("btn_clear");
        if (clearBtn) {
            clearBtn.onclick = clearAllFilters;
        }

        const refreshBtn = document.getElementById("btn_refresh");
        if (refreshBtn) {
            refreshBtn.onclick = () => {
                fetchJSON("/api/refresh", { method: "POST" })
                    .then(() => {
                        toast("Data refreshed", "success");
                        applyPreset(currentPreset);
                    })
                    .catch((err) => toast("Refresh failed: " + err.message, "error"));
            };
        }

        const exportBtn = document.getElementById("btn_export");
        if (exportBtn) {
            exportBtn.onclick = () => {
                toast('Export functionality will be available soon', 'info');
            };
        }

        // Pagination event handlers (sync top and bottom page-size controls)
        const pageSizeBottom = document.getElementById("page-size");
        const pageSizeTop = document.getElementById("page-size-top");
        console.log('Pagination elements found - Bottom:', !!pageSizeBottom, 'Top:', !!pageSizeTop);
        
        function onPageSize(val){
            console.log('onPageSize called with value:', val);
            PAGE_SIZE = parseInt(val);
            CURRENT_PAGE = 1;
            console.log('Updated PAGE_SIZE to:', PAGE_SIZE, 'Reset CURRENT_PAGE to:', CURRENT_PAGE);
            if (pageSizeBottom && pageSizeBottom.value !== String(val)) pageSizeBottom.value = String(val);
            if (pageSizeTop && pageSizeTop.value !== String(val)) pageSizeTop.value = String(val);
            renderTable(ALL_SUBMISSIONS);
        }
        if (pageSizeBottom) pageSizeBottom.addEventListener('change', (e)=> onPageSize(e.target.value));
        if (pageSizeTop) pageSizeTop.addEventListener('change', (e)=> onPageSize(e.target.value));

        const firstPageBtn = document.getElementById("first-page");
        if (firstPageBtn) firstPageBtn.onclick = goToFirstPage;

        const prevPageBtn = document.getElementById("prev-page");
        if (prevPageBtn) prevPageBtn.onclick = goToPrevPage;

        const nextPageBtn = document.getElementById("next-page");
        if (nextPageBtn) nextPageBtn.onclick = goToNextPage;

        const lastPageBtn = document.getElementById("last-page");
        if (lastPageBtn) lastPageBtn.onclick = goToLastPage;

        // Sorting handlers
        document.querySelectorAll(".th-sort").forEach((th) => {
            th.onclick = () => {
                const key = th.dataset.key;
                if (SORT_BY === key) {
                    SORT_DIR = SORT_DIR === "asc" ? "desc" : "asc";
                } else {
                    SORT_BY = key;
                    SORT_DIR = "desc";
                }
                
                // Update arrow indicators
                document.querySelectorAll(".arrow").forEach(a => a.textContent = "");
                const arrow = th.querySelector(".arrow");
                if (arrow) arrow.textContent = SORT_DIR === "asc" ? "‚Üë" : "‚Üì";
                
                // Reapply current filters with new sort
                if (currentPreset !== 'all') {
                    applyPreset(currentPreset);
                } else {
                    const applyBtn = document.getElementById("btn_apply");
                    if (applyBtn) applyBtn.click();
                }
            };
        });

        // Load modes and initialize
        loadModes().then(() => {
            // Ensure a deterministic default
            setActiveMode(getActiveMode());
            applyPreset('all');
        }).catch(() => {
            setActiveMode(getActiveMode());
            applyPreset('all');
        });
    });

    // Load available modes
    async function loadModes() {
        try {
            const modes = await fetchJSON('/api/modes');
            const sel = document.getElementById('f_mode');
            if (sel && Array.isArray(modes)) {
                sel.innerHTML = modes.map(m => `<option value="${m.key}">${m.label}</option>`).join('');
                // Pick a stable default
                const preferred = localStorage.getItem('ACTIVE_MODE') || 'balanced_growth';
                const keys = modes.map(m => m.key);
                const val = keys.includes(preferred) ? preferred : (keys.includes('balanced_growth') ? 'balanced_growth' : (keys[0] || 'balanced_growth'));
                sel.value = val;
                setActiveMode(val);
                sel.addEventListener('change', () => setActiveMode(sel.value));
            }
        } catch (error) {
            console.error('Failed to load modes:', error);
        }
    }

    function explain(id) {
        if (!id) {
            toast("No submission ID available", "error");
            return;
        }
        const mode = document.getElementById('f_mode')?.value;
        const url = mode && mode !== '' 
            ? `/api/explain/${id}?mode=${encodeURIComponent(mode)}`
            : `/api/explain/${id}`;
        fetch(url, { method: "POST" })
            .then((r) => r.json())
            .then((j) => {
                if (j.ok) {
                    showExplanationModal(j.explanation, id);
                } else {
                    toast("Failed to get explanation", "error");
                }
            })
            .catch((err) => {
                toast("Error getting explanation: " + err.message, "error");
            });
    }

    function addToWatch(id) {
        if (!id) {
            toast("No submission ID available", "error");
            return;
        }
        // Add to watch list functionality
        toast(`Added submission ${id} to watch list`, 'success');
    }

    function showExplanationModal(explanation, id) {
        // Create a simple modal for explanations
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="glass-panel max-w-2xl mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Appetite Explanation - ID ${id}</h3>
                    <button class="quick-action" onclick="this.closest('.fixed').remove()">‚úï</button>
                </div>
                <div class="text-sm leading-relaxed">${explanation}</div>
                <div class="mt-4 flex justify-end">
                    <button class="quick-action primary" onclick="this.closest('.fixed').remove()">Got it</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function clearAllFilters() {
        document.getElementById('f_state').value = '';
        document.getElementById('f_status').value = '';
        document.getElementById('f_min').value = '';
        document.getElementById('f_max').value = '';
        document.getElementById('f_q').value = '';
        // Keep current mode; only clear filters
        applyPreset('all');
    }

    function updateLastUpdated() {
        const el = document.getElementById("subs_last");
        if(!el) return;
        const d = new Date();
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        el.textContent = `Updated ${hh}:${mm}`;
    }

    async function populateModes() {
        const wrap = document.getElementById('f_mode_wrap');
        try {
            const j = await fetchJSON("/api/modes");
            const modes = Array.isArray(j) ? j : [];
            const sel = document.getElementById("f_mode");
            if (!sel) return;
            if (!modes.length) {
                wrap?.classList?.add('hidden');
                sel.innerHTML = '<option value="" disabled selected>No modes available</option>';
                return;
            }
            wrap?.classList?.remove('hidden');
            sel.innerHTML = modes
                .map((m) => `<option value="${m.key}">${m.label || m.key}</option>`)
                .join("");
            // default to ACTIVE_MODE if available
            const active = localStorage.getItem('ACTIVE_MODE') || 'balanced_growth';
            const keys = modes.map(m => m.key);
            sel.value = keys.includes(active) ? active : (keys.includes('balanced_growth') ? 'balanced_growth' : (keys[0] || ''));
        } catch (e) {
            console.error("Failed to load modes", e);
            wrap?.classList?.add('hidden');
        }
    }

    // Sorting handlers
    function updateSortHeaders() {
        document.querySelectorAll("th.th-sort").forEach((th) => {
            const key = th.dataset.key;
            const arrow = th.querySelector(".arrow");
            th.classList.toggle("active", key === SORT_BY);
            if (arrow) {
                if (key === SORT_BY) {
                    arrow.textContent = SORT_DIR === "asc" ? "‚ñ≤" : "‚ñº";
                } else {
                    arrow.textContent = "";
                }
            }
        });
    }
    document.querySelectorAll("th.th-sort").forEach((th) => {
        th.style.cursor = "pointer";
        th.addEventListener("click", () => {
            const key = th.dataset.key;
            if (SORT_BY === key) {
                SORT_DIR = SORT_DIR === "asc" ? "desc" : "asc";
            } else {
                SORT_BY = key;
                // Default direction: numeric desc, text asc
                const numeric = [
                    "id",
                    "total_premium",
                    "tiv",
                    "winnability",
                    "priority_score",
                ];
                SORT_DIR = numeric.includes(key) ? "desc" : "asc";
            }
            updateSortHeaders();
            document.getElementById("btn_apply").click();
        });
    });

    // Auto-apply on filter changes (debounced for inputs)
    function apply() {
        document.getElementById("btn_apply").click();
    }
    let t;
    function debouncedApply() {
        clearTimeout(t);
        t = setTimeout(apply, 300);
    }
    ["f_state", "f_status", "f_mode"].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("change", apply);
    });
    ["f_min", "f_max", "f_q"].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", debouncedApply);
    });

    populateModes()
        .then(() => {
            updateSortHeaders();
            // Load initial data instead of just applying filters
            load({ mode: getActiveMode() }).catch((err) =>
                toast("Initial load failed: " + err.message, "error")
            );
        })
        .catch(() => {
            updateSortHeaders();
            load().catch((err) =>
                toast("Initial load failed: " + err.message, "error")
            );
        });

    let autoT;
    function startAuto() {
        clearInterval(autoT);
        autoT = setInterval(() => {
            if (!document.hidden) {
                load(LAST_PARAMS).catch((err) =>
                    toast("Auto-refresh failed: " + err.message, "error")
                );
            }
        }, 45000);
    }
    function stopAuto() {
        clearInterval(autoT);
    }
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) stopAuto();
        else startAuto();
    });
    startAuto();

    // Advanced filter toggle functionality
    function setupAdvancedFilters() {
        const toggleBtn = document.getElementById('toggle_advanced');
        const panel = document.getElementById('advanced_filter_panel');
        const arrow = toggleBtn?.querySelector('.toggle-arrow');
        
        if (toggleBtn && panel) {
            toggleBtn.onclick = () => {
                const isHidden = panel.classList.contains('hidden');
                panel.classList.toggle('hidden');
                toggleBtn.classList.toggle('active', !isHidden);
                
                if (arrow) {
                    arrow.textContent = isHidden ? '‚Üë' : '‚Üì';
                }
            };
        }
    }

    // Enhanced modal functionality for bulk actions and export
    function createBulkActionsModal() {
        const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.dataset.id);
        
        if (selectedIds.length === 0) {
            toast('Please select submissions first', 'warning');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="glass-panel max-w-md mx-4 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Bulk Actions</h3>
                    <button class="control-btn" onclick="this.closest('.fixed').remove()">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <p class="text-sm opacity-75 mb-6">${selectedIds.length} submissions selected</p>
                
                <div class="bulk-actions-grid grid grid-cols-2 gap-3">
                    <button class="bulk-action-btn" onclick="performBulkAction('watch', ${JSON.stringify(selectedIds)}); this.closest('.fixed').remove();">
                        <i class="fas fa-eye"></i>
                        Add to Watch List
                    </button>
                    <button class="bulk-action-btn" onclick="performBulkAction('priority', ${JSON.stringify(selectedIds)}); this.closest('.fixed').remove();">
                        <i class="fas fa-star"></i>
                        Mark Priority
                    </button>
                    <button class="bulk-action-btn" onclick="performBulkAction('export', ${JSON.stringify(selectedIds)}); this.closest('.fixed').remove();">
                        <i class="fa-solid fa-download"></i>
                        Export Selected
                    </button>
                    <button class="bulk-action-btn" onclick="performBulkAction('notes', ${JSON.stringify(selectedIds)}); this.closest('.fixed').remove();">
                        <i class="fa-solid fa-comment"></i>
                        Add Notes
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function createExportModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="glass-panel max-w-md mx-4 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Export Submissions</h3>
                    <button class="control-btn" onclick="this.closest('.fixed').remove()">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="export-option">
                        <label class="flex items-center gap-3 p-3 border border-white/10 rounded-lg cursor-pointer hover:bg-white/5">
                            <input type="radio" name="export_format" value="csv" checked class="accent-indigo-500">
                            <div>
                                <div class="font-semibold">CSV File</div>
                                <div class="text-sm opacity-75">Spreadsheet compatible format</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="export-option">
                        <label class="flex items-center gap-3 p-3 border border-white/10 rounded-lg cursor-pointer hover:bg-white/5">
                            <input type="radio" name="export_format" value="pdf" class="accent-indigo-500">
                            <div>
                                <div class="font-semibold">PDF Report</div>
                                <div class="text-sm opacity-75">Formatted business report</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="export-option">
                        <label class="flex items-center gap-3 p-3 border border-white/10 rounded-lg cursor-pointer hover:bg-white/5">
                            <input type="radio" name="export_format" value="json" class="accent-indigo-500">
                            <div>
                                <div class="font-semibold">JSON Data</div>
                                <div class="text-sm opacity-75">Raw data format</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button class="control-btn flex-1" onclick="this.closest('.fixed').remove()">Cancel</button>
                    <button class="control-btn flex-1 bg-indigo-600 hover:bg-indigo-700" onclick="performExport(); this.closest('.fixed').remove();">
                        <i class="fa-solid fa-download"></i>
                        Export
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function createColumnsModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="glass-panel max-w-md mx-4 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Manage Columns</h3>
                    <button class="control-btn" onclick="this.closest('.fixed').remove()">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                
                <div class="space-y-3">
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>Priority Score</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>Appetite Status</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>Account Name</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>State</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>Premium</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>TIV</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>Winnability</span>
                    </label>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button class="control-btn flex-1" onclick="this.closest('.fixed').remove()">Cancel</button>
                    <button class="control-btn flex-1 bg-indigo-600 hover:bg-indigo-700" onclick="applyColumns(); this.closest('.fixed').remove();">
                        Apply
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Bulk action handlers
    function performBulkAction(action, ids) {
        switch(action) {
            case 'watch':
                toast(`Added ${ids.length} submissions to watch list`, 'success');
                break;
            case 'priority':
                toast(`Marked ${ids.length} submissions as priority`, 'success');
                break;
            case 'export':
                toast(`Exported ${ids.length} submissions`, 'success');
                break;
            case 'notes':
                toast(`Added notes to ${ids.length} submissions`, 'success');
                break;
        }
        
        // Clear selections
        document.querySelectorAll('.row-checkbox:checked').forEach(cb => cb.checked = false);
        document.getElementById('select-all').checked = false;
        document.querySelector('.selected-info').classList.add('hidden');
    }

    function performExport() {
        const format = document.querySelector('input[name="export_format"]:checked')?.value || 'csv';
        toast(`Exporting data as ${format.toUpperCase()}...`, 'info');
        
        // Simulate export
        setTimeout(() => {
            toast(`Export completed successfully`, 'success');
        }, 2000);
    }

    function applyColumns() {
        toast('Column visibility updated', 'success');
    }

    // Initialize enhanced features on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        // Setup advanced filters
        setupAdvancedFilters();
        
        // Table control handlers
        document.getElementById('bulk-actions-btn')?.addEventListener('click', createBulkActionsModal);
        document.getElementById('export-submissions-btn')?.addEventListener('click', createExportModal);
        document.getElementById('columns-btn')?.addEventListener('click', createColumnsModal);
        
        // Save filter preset functionality
        document.getElementById('save_filter_preset')?.addEventListener('click', () => {
            const presetName = prompt('Enter a name for this filter preset:');
            if (presetName && presetName.trim()) {
                const filters = {
                    state: document.getElementById('f_state')?.value || '',
                    status: document.getElementById('f_status')?.value || '',
                    mode: document.getElementById('f_mode')?.value || '',
                    min_premium: document.getElementById('f_min')?.value || '',
                    max_premium: document.getElementById('f_max')?.value || '',
                    search: document.getElementById('f_q')?.value || ''
                };
                
                const savedPresets = JSON.parse(localStorage.getItem('filterPresets') || '{}');
                savedPresets[presetName.trim()] = filters;
                localStorage.setItem('filterPresets', JSON.stringify(savedPresets));
                
                toast(`Filter preset "${presetName}" saved successfully`, 'success');
                updateFilterPresets();
            }
        });
        
        // Clear all filters functionality
        document.getElementById('clear_all_filters')?.addEventListener('click', () => {
            if (confirm('Clear all current filters?')) {
                clearAllFilters();
                toast('All filters cleared', 'success');
            }
        });
        
        // View toggle handlers
        const tableEl = document.getElementById('subs_table');
        const cardsWrap = document.getElementById('cards_container');
        const initialView = getSubsView();
        document.querySelectorAll('[data-view]').forEach(b => b.classList.toggle('active', b.dataset.view===initialView));
        if (initialView === 'table') { tableEl?.classList.remove('hidden'); cardsWrap?.classList.add('hidden'); }
        else { tableEl?.classList.add('hidden'); cardsWrap?.classList.remove('hidden'); }
        document.querySelectorAll('[data-view]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const view = btn.dataset.view;
                setSubsView(view);
                if (view === 'table') {
                    tableEl?.classList.remove('hidden');
                    cardsWrap?.classList.add('hidden');
                } else {
                    tableEl?.classList.add('hidden');
                    cardsWrap?.classList.remove('hidden');
                }
                renderTable(ALL_SUBMISSIONS);
            });
        });
        
        // Search clear button
        const searchInput = document.getElementById('f_q');
        const clearBtn = document.getElementById('clear_search');
        
        if (searchInput && clearBtn) {
            searchInput.addEventListener('input', () => {
                clearBtn.classList.toggle('hidden', !searchInput.value);
            });
            
            clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearBtn.classList.add('hidden');
                // Trigger search update
                document.getElementById('btn_apply')?.click();
            });
        }
    });
    
    function updateFilterPresets() {
        // This would update the filter presets display
        console.log('Filter presets updated');
    }
</script>

<script type="module">
    import { startAutoRefresh } from "{{ url_for('static', filename='js/refresh.js') }}";
    function endpointBuilder(){
        const p = {
          state: document.getElementById('f_state').value || '',
          status: document.getElementById('f_status').value || '',
          min_premium: document.getElementById('f_min').value || '',
          max_premium: document.getElementById('f_max').value || '',
          q: document.getElementById('f_q').value || '',
          mode: (typeof getActiveMode === 'function') ? getActiveMode() : (document.getElementById('f_mode').value || (localStorage.getItem('ACTIVE_MODE') || 'balanced_growth')),
          sort_by: window.SORT_BY,
          sort_dir: window.SORT_DIR,
        };
        const qs = new URLSearchParams(p).toString();
        return `/api/classified_mode?${qs}`;
    }
    function hashSelector(row){
      return {
        id: row.id,
        account_name: row.account_name,
        primary_risk_state: row.primary_risk_state,
        line_of_business: row.line_of_business,
        total_premium: row.total_premium,
        tiv: row.tiv,
        winnability: row.winnability,
        appetite_status: row.appetite_status,
        priority_score: row.priority_score,
      };
    }
    const ctl = startAutoRefresh({
      targetId: 'tbody',
      endpointBuilder,
      hashSelector,
      onUpdate: (json, changed) => {
        const rows = json?.data || [];
        if (changed) { window.renderTable?.(rows); }
        const el = document.getElementById('subs_last');
        if (el) {
          const d = new Date();
          const hh = d.getHours().toString().padStart(2,'0');
          const mm = d.getMinutes().toString().padStart(2,'0');
          el.textContent = `Last updated ${hh}:${mm}`;
        }
      },
    });
    // Trigger immediate refresh on filter and sort changes
    ['f_state','f_status','f_mode','f_min','f_max','f_q'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('change', ()=> ctl?.triggerNow());
      el.addEventListener('input', ()=> ctl?.triggerNow());
    });
    document.querySelectorAll('th.th-sort').forEach(th => {
      th.addEventListener('click', ()=> ctl?.triggerNow());
    });
    window._subsRefreshCtl = ctl;
</script>
{% endblock %}
