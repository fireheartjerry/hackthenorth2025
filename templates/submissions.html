{% extends "base.html" %} {% block content %}
<!-- Modern Submissions Dashboard -->
<div class="submissions-hero glass-panel p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <div class="hero-content">
            <h1 class="text-2xl font-bold tracking-tight bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
                Submission Pipeline
            </h1>
            <p class="text-sm opacity-75 mt-1">
                Intelligent prioritization and advanced filtering for maximum efficiency
            </p>
        </div>
        <div class="pipeline-stats flex items-center gap-4">
            <div class="stat-bubble">
                <div class="stat-value" id="subs_count">‚Äî</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-bubble target">
                <div class="stat-value" id="target_count">‚Äî</div>
                <div class="stat-label">Targets</div>
            </div>
            <div class="stat-bubble">
                <div class="stat-value" id="completion_rate">‚Äî%</div>
                <div class="stat-label">Processed</div>
            </div>
        </div>
    </div>
    
    <!-- Real-time Pipeline Status -->
    <div class="pipeline-status">
        <div class="status-bar">
            <div class="status-segment target" style="width: 25%"></div>
            <div class="status-segment in" style="width: 45%"></div>
            <div class="status-segment out" style="width: 30%"></div>
        </div>
        <div class="status-legend">
            <span class="legend-item target">üéØ Target (25%)</span>
            <span class="legend-item in">‚úÖ In-Appetite (45%)</span>
            <span class="legend-item out">‚ùå Out-of-Appetite (30%)</span>
        </div>
    </div>
</div>
    
<!-- Smart Filtering System -->
<div class="smart-filters glass-panel p-6 mb-6">
    <div class="filter-header">
        <div class="flex items-center justify-between mb-4">
            <div class="filter-title-section">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <span class="filter-icon">üîç</span>
                    Smart Filters
                </h3>
                <p class="text-sm opacity-75">Intelligent filtering with saved presets and AI assistance</p>
            </div>
            <div class="filter-actions">
                <button id="save_filter_preset" class="control-btn">
                    <span class="icon">üíæ</span>
                    Save Preset
                </button>
                <button id="clear_all_filters" class="control-btn">
                    <span class="icon">üóëÔ∏è</span>
                    Clear All
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Filter Presets -->
    <div class="filter-presets mb-6">
        <div class="preset-grid">
            <button class="filter-preset-card active" data-preset="all">
                <div class="preset-icon">üìã</div>
                <div class="preset-content">
                    <div class="preset-title">All Submissions</div>
                    <div class="preset-desc">Complete pipeline view</div>
                </div>
                <div class="preset-count" id="preset_all_count">‚Äî</div>
            </button>
            
            <button class="filter-preset-card" data-preset="targets">
                <div class="preset-icon">üéØ</div>
                <div class="preset-content">
                    <div class="preset-title">Priority Targets</div>
                    <div class="preset-desc">High-value opportunities</div>
                </div>
                <div class="preset-count" id="preset_targets_count">‚Äî</div>
            </button>
            
            <button class="filter-preset-card" data-preset="in-appetite">
                <div class="preset-icon">‚úÖ</div>
                <div class="preset-content">
                    <div class="preset-title">In-Appetite</div>
                    <div class="preset-desc">Ready for review</div>
                </div>
                <div class="preset-count" id="preset_in_count">‚Äî</div>
            </button>
            
            <button class="filter-preset-card" data-preset="high-value">
                <div class="preset-icon">üíé</div>
                <div class="preset-content">
                    <div class="preset-title">High Value</div>
                    <div class="preset-desc">$100K+ premium</div>
                </div>
                <div class="preset-count" id="preset_high_count">‚Äî</div>
            </button>
            
            <button class="filter-preset-card" data-preset="new-business">
                <div class="preset-icon">üÜï</div>
                <div class="preset-content">
                    <div class="preset-title">New Business</div>
                    <div class="preset-desc">Fresh opportunities</div>
                </div>
                <div class="preset-count" id="preset_new_count">‚Äî</div>
            </button>
            
            <button class="filter-preset-card" data-preset="recent">
                <div class="preset-icon">‚è∞</div>
                <div class="preset-content">
                    <div class="preset-title">Recent</div>
                    <div class="preset-desc">Last 7 days</div>
                </div>
                <div class="preset-count" id="preset_recent_count">‚Äî</div>
            </button>
        </div>
    </div>

    <!-- Advanced Filters -->
    <div class="advanced-filters">
        <div class="filters-toggle">
            <button id="toggle_advanced" class="toggle-btn">
                <span class="toggle-icon">‚öôÔ∏è</span>
                <span class="toggle-text">Advanced Filters</span>
                <span class="toggle-arrow">‚Üì</span>
            </button>
        </div>
        
        <div id="advanced_filter_panel" class="filter-panel hidden">
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">State/Region</label>
                    <div class="filter-input-enhanced">
                        <span class="input-icon">üó∫Ô∏è</span>
                        <input id="f_state" class="filter-input" placeholder="e.g., CA, FL, TX" />
                    </div>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Appetite Status</label>
                    <select id="f_status" class="filter-select">
                        <option value="">Any Status</option>
                        <option value="TARGET">üéØ Target</option>
                        <option value="IN">‚úÖ In-Appetite</option>
                        <option value="OUT">‚ùå Out-of-Appetite</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Analysis Mode</label>
                    <select id="f_mode" class="filter-select">
                        <option value="" disabled selected>Loading modes‚Ä¶</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Premium Range</label>
                    <div class="range-inputs">
                        <input id="f_min" class="range-input" type="number" placeholder="Min (e.g., 50,000)" />
                        <span class="range-separator">to</span>
                        <input id="f_max" class="range-input" type="number" placeholder="Max (e.g., 175,000)" />
                    </div>
                </div>
                
                <div class="filter-group span-2">
                    <label class="filter-label">Search Accounts</label>
                    <div class="search-input-enhanced">
                        <span class="input-icon">üîç</span>
                        <input id="f_q" class="search-input" placeholder="Search by account name, broker, or keywords..." />
                        <button class="search-clear hidden" id="clear_search">√ó</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="flex items-center justify-between mt-4">
        <div class="flex items-center gap-2">
            <button id="btn_apply" class="quick-action primary">Apply Filters</button>
            <button id="btn_clear" class="quick-action">Clear All</button>
            <button id="btn_save_filter" class="quick-action">üíæ Save Filter</button>
        </div>
        <div class="flex items-center gap-2">
            <input id="nlq" class="inp w-72" placeholder="Ask: 'Show targets in CA over $100k premium'" />
            <button id="btn_nlq" class="quick-action">Ask AI</button>
            <button id="btn_refresh" class="quick-action">üîÑ Refresh</button>
            <button id="btn_export" class="quick-action">üìä Export</button>
        </div>
    </div>
</div>

<!-- US Submissions Map -->
<div class="glass-panel p-4 mb-6">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">US Submissions Map</h2>
        <div class="text-xs opacity-70">Click a state to filter</div>
    </div>
    <div id="us_map_wrap" class="usmap-wrap relative">
        <svg id="us_map" viewBox="0 0 975 610" class="w-full h-auto block"></svg>
        <div id="us_map_tooltip" class="map-tooltip hidden"></div>
        <div class="map-legend">
            <span class="text-xs opacity-70 mr-2">Fewer</span>
            <div class="legend-bar" aria-hidden="true"></div>
            <span class="text-xs opacity-70 ml-2">More</span>
        </div>
    </div>
    <div class="text-xs opacity-70 mt-2" id="us_map_summary"></div>
</div>

<!-- Enhanced Submissions Table -->
<div class="submissions-table-panel card p-0">
    <div class="table-header bg-gradient-to-r from-gray-50/50 to-gray-100/50 p-4 border-b border-white/10">
        <div class="flex items-center justify-between">
            <div class="table-title-section">
                <h3 class="text-lg font-semibold text-indigo-400 mb-1">üìä Submissions Analysis</h3>
                <p class="text-sm text-gray-400">Advanced filtering and bulk actions</p>
            </div>
            
            <div class="table-controls flex items-center gap-3">
                <div class="view-options">
                    <button class="control-btn active" data-view="table">
                        <i class="fas fa-table"></i>
                        Table
                    </button>
                    <button class="control-btn" data-view="cards">
                        <i class="fas fa-th-large"></i>
                        Cards
                    </button>
                </div>
                
                <div class="table-actions">
                    <button class="control-btn" id="bulk-actions-btn">
                        <i class="fas fa-tasks"></i>
                        Bulk Actions
                    </button>
                    <button class="control-btn" id="export-submissions-btn">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="control-btn" id="columns-btn">
                        <i class="fas fa-columns"></i>
                        Columns
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="table-loading" class="loading-skeleton hidden">
        <div class="table-skeleton">
            <div class="skeleton-row" style="width: 100%; height: 3rem;"></div>
            <div class="skeleton-row" style="width: 95%; height: 2.5rem;"></div>
            <div class="skeleton-row" style="width: 98%; height: 2.5rem;"></div>
            <div class="skeleton-row" style="width: 92%; height: 2.5rem;"></div>
            <div class="skeleton-row" style="width: 97%; height: 2.5rem;"></div>
        </div>
    </div>

    <!-- Table Container -->
    <div class="table-container overflow-x-auto">
        <!-- Enhanced Table -->
        <div class="overflow-x-auto">
            <table class="enhanced-submissions-table w-full text-sm">
            <thead class="border-b border-white border-opacity-10">
                <tr>
                    <th class="checkbox-col py-4 px-3">
                        <input type="checkbox" id="select-all" class="table-checkbox">
                    </th>
                    <th class="th th-sort sortable text-left py-4 px-6" data-key="priority_score">
                        <div class="th-content">
                            <i class="fas fa-star th-icon"></i>
                            Priority
                            <i class="fas fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-4 px-4" data-key="appetite_status">
                        <div class="th-content">
                            <i class="fas fa-traffic-light th-icon"></i>
                            Status
                            <i class="fas fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-4 px-4" data-key="account_name">
                        <div class="th-content">
                            <i class="fas fa-building th-icon"></i>
                            Account
                            <i class="fas fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-4 px-4" data-key="primary_risk_state">
                        <div class="th-content">
                            <i class="fas fa-map-marker-alt th-icon"></i>
                            State
                            <i class="fas fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-4 px-4" data-key="total_premium">
                        <div class="th-content">
                            <i class="fas fa-money-bill-wave th-icon"></i>
                            Premium
                            <i class="fas fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-4 px-4" data-key="tiv">
                        <div class="th-content">
                            <i class="fas fa-dollar-sign th-icon"></i>
                            TIV
                            <i class="fas fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th th-sort sortable text-left py-4 px-4" data-key="winnability">
                        <div class="th-content">
                            <i class="fas fa-percentage th-icon"></i>
                            Win%
                            <i class="fas fa-sort sort-icon arrow"></i>
                        </div>
                    </th>
                    <th class="th actions-col text-left py-4 px-4">
                        <div class="th-content">
                            <i class="fas fa-cog th-icon"></i>
                            Actions
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody id="tbody">
                <!-- Submissions will be loaded here -->
            </tbody>
        </table>

        <!-- Empty State -->
        <div id="empty-state" class="empty-state hidden text-center py-12">
            <div class="empty-icon text-4xl mb-3">
                <i class="fas fa-search"></i>
            </div>
            <h3 class="text-lg font-semibold mb-2">No submissions found</h3>
            <p class="text-sm opacity-75 mb-4">Try adjusting your filters or search criteria</p>
            <button class="control-btn" onclick="clearAllFilters()">
                <i class="fas fa-times"></i>
                Clear Filters
            </button>
        </div>
    </div>

    <!-- Enhanced Pagination -->
    <div class="table-footer bg-gradient-to-r from-gray-50/30 to-gray-100/30 p-4 border-t border-white/10">
        <div class="flex items-center justify-between">
            <div class="table-info">
                <div class="pagination-info">
                    Showing <span id="page-start" class="font-semibold text-indigo-400">1</span>-<span id="page-end" class="font-semibold text-indigo-400">25</span> 
                    of <span id="total-count" class="font-semibold text-indigo-400">0</span> submissions
                </div>
                <div class="selected-info hidden">
                    <span id="selected-count" class="font-semibold text-emerald-400">0</span> selected
                </div>
            </div>
            
            <div class="pagination-controls flex items-center gap-2">
                <div class="page-size-selector">
                    <select id="page-size" class="filter-select">
                        <option value="25">25 per page</option>
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                </div>
                
                <div class="pagination-buttons">
                    <button id="first-page" class="pagination-btn" disabled>
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button id="prev-page" class="pagination-btn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="pagination-numbers" class="pagination-numbers"></span>
                    <button id="next-page" class="pagination-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button id="last-page" class="pagination-btn">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Ensure utility functions are available (fallback if app.js hasn't loaded yet)
    if (typeof window.fetchJSON === 'undefined') {
        window.fetchJSON = async function(url, opts={}){
            const res = await fetch(url, opts);
            if(!res.ok){
                let msg = `${res.status} ${res.statusText}`;
                try { const j = await res.json(); if(j && j.error) msg = j.error; } catch (e) {}
                throw new Error(msg);
            }
            return res.json();
        }
    }
    
    if (typeof window.withLoading === 'undefined') {
        window.withLoading = async function(el, fn){
            try{ el?.classList?.add("is-loading"); return await fn(); } finally { el?.classList?.remove("is-loading"); }
        }
    }
    
    if (typeof window.toast === 'undefined') {
        window.toast = function(msg, type = "info") {
            const host = document.getElementById("toasts") || (function(){
                const d = document.createElement("div");
                d.id = "toasts"; d.className = "toasts"; document.body.appendChild(d); return d;
            })();
            const el = document.createElement("div");
            el.className = `toast ${type}`;
            el.textContent = msg;
            host.appendChild(el);
            setTimeout(()=>{ el.classList.add("out"); setTimeout(()=>host.removeChild(el), 200); }, 2800);
        }
    }
    
    let SORT_BY = "priority_score";
    let SORT_DIR = "desc";
    // Ensure a consistent analysis mode is always applied
    function getActiveMode() {
        const sel = document.getElementById('f_mode');
        const fromSelect = sel && sel.value ? sel.value : null;
        const fromLS = localStorage.getItem('ACTIVE_MODE');
        return fromSelect || fromLS || 'balanced_growth';
    }
    function setActiveMode(val) {
        try { localStorage.setItem('ACTIVE_MODE', val); } catch (e) {}
        const sel = document.getElementById('f_mode');
        if (sel && sel.value !== val) sel.value = val;
    }
    let ALL_SUBMISSIONS = [];
    let currentPreset = "all";

    // Enhanced table rendering with visual priorities and bulk selection
    function renderTable(rows){
        const tbody = document.getElementById("tbody");
        const emptyState = document.getElementById("empty-state");
        const countSpan = document.getElementById("subs_count");
        
        if (!rows || rows.length === 0) {
            tbody.innerHTML = "";
            emptyState?.classList.remove("hidden");
            countSpan.textContent = "0";
            updateStats({ total: 0, target: 0, processed: 0 });
            return;
        }
        
        emptyState?.classList.add("hidden");
        countSpan.textContent = `${rows.length}`;
        
        // Calculate stats for hero section
        const stats = {
            total: rows.length,
            target: rows.filter(r => r.appetite_status === 'TARGET').length,
            processed: Math.round(rows.length * 0.85) // Simulate processing rate
        };
        updateStats(stats);
        
        tbody.innerHTML = rows.map((r) => {
            const appetiteClass = r.appetite_status === 'TARGET' ? 'target-row' : 
                                r.appetite_status === 'IN' ? 'in-row' : 'out-row';
            
            const priorityClass = r.priority_score >= 7 ? 'priority-high' : 
                                r.priority_score >= 4 ? 'priority-medium' : 'priority-low';
            
            const appetiteBadge = r.appetite_status === 'TARGET' ? 
                                '<span class="appetite-indicator appetite-target pill">üéØ TARGET</span>' :
                                r.appetite_status === 'IN' ? 
                                '<span class="appetite-indicator appetite-in pill">‚úÖ IN</span>' :
                                '<span class="appetite-indicator appetite-out pill">‚ùå OUT</span>';
            
            const winnabilityPercent = typeof r.winnability === 'number' ? 
                                      Number(r.winnability > 1 ? r.winnability : r.winnability * 100).toFixed(0) : '‚Äî';
            
            return `
                <tr class="table-row ${appetiteClass}" data-id="${r.id}" onclick="navigateToDetail(${r.id}, event)">
                    <td class="td py-4 px-3 text-center">
                        <input type="checkbox" class="table-checkbox row-checkbox" data-id="${r.id}" onclick="event.stopPropagation()">
                    </td>
                    <td class="td py-4 px-6">
                        <div class="flex items-center gap-2">
                            <span class="priority-score ${priorityClass}">${Number(r.priority_score || 0).toFixed(1)}</span>
                        </div>
                    </td>
                    <td class="td py-4 px-4">
                        ${appetiteBadge}
                    </td>
                    <td class="td py-4 px-4">
                        <div class="font-semibold text-white">${r.account_name || "‚Äî"}</div>
                        <div class="text-xs opacity-75">${r.line_of_business || "‚Äî"}</div>
                    </td>
                    <td class="td py-4 px-4">
                        <span class="chip">${r.primary_risk_state || "‚Äî"}</span>
                    </td>
                    <td class="td py-4 px-4">
                        <div class="font-semibold text-emerald-300">$${Math.round(r.total_premium || 0).toLocaleString()}</div>
                    </td>
                    <td class="td py-4 px-4">
                        <div class="font-semibold">$${Math.round(r.tiv || 0).toLocaleString()}</div>
                    </td>
                    <td class="td py-4 px-4">
                        <div class="font-semibold text-purple-300">${winnabilityPercent}%</div>
                    </td>
                    <td class="td py-4 px-4">
                        <div class="flex items-center gap-2">
                            <button class="pill pill-sub text-xs" onclick="event.stopPropagation(); if(${r.id || 'null'}) explain(${r.id || 'null'})">üí° Explain</button>
                            <button class="pill pill-sub text-xs" onclick="event.stopPropagation(); if(${r.id || 'null'}) addToWatch(${r.id || 'null'})">üëÄ Watch</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join("");
        
        // Setup bulk selection handlers
        setupBulkSelection();
        updateLastUpdated();
    }

    // Navigation handler with better UX
    function navigateToDetail(id, event) {
        // Don't navigate if clicking on interactive elements
        if (event.target.closest('input, button, .pill')) return;
        
        const mode = document.getElementById('f_mode')?.value || '';
        window.location.href = `/detail/${id}?mode=${encodeURIComponent(mode)}`;
    }

    // Update hero section stats
    function updateStats(stats) {
        const targetCountEl = document.getElementById('target_count');
        const completionRateEl = document.getElementById('completion_rate');
        
        if (targetCountEl) targetCountEl.textContent = stats.target || '‚Äî';
        if (completionRateEl) {
            const rate = stats.total ? Math.round((stats.processed / stats.total) * 100) : 0;
            completionRateEl.textContent = `${rate}%`;
        }
        
        // Update pipeline status bar
        updatePipelineStatus(stats);
    }

    // Update the visual pipeline status bar
    function updatePipelineStatus(stats) {
        if (!stats.total) return;
        
        const targetPercent = Math.round((stats.target / stats.total) * 100);
        const inPercent = Math.round(((stats.total - stats.target) * 0.6 / stats.total) * 100);
        const outPercent = 100 - targetPercent - inPercent;
        
        document.querySelector('.status-segment.target').style.width = `${targetPercent}%`;
        document.querySelector('.status-segment.in').style.width = `${inPercent}%`;
        document.querySelector('.status-segment.out').style.width = `${outPercent}%`;
        
        // Update legend
        document.querySelector('.legend-item.target').textContent = `üéØ Target (${targetPercent}%)`;
        document.querySelector('.legend-item.in').textContent = `‚úÖ In-Appetite (${inPercent}%)`;
        document.querySelector('.legend-item.out').textContent = `‚ùå Out-of-Appetite (${outPercent}%)`;
    }

    // Bulk selection functionality
    function setupBulkSelection() {
        const selectAllCheckbox = document.getElementById('select-all');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const selectedInfo = document.querySelector('.selected-info');
        const selectedCountEl = document.getElementById('selected-count');
        
        // Select all handler
        if (selectAllCheckbox) {
            selectAllCheckbox.onchange = function() {
                rowCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                    updateRowSelection(cb);
                });
                updateSelectionInfo();
            };
        }
        
        // Individual row handlers
        rowCheckboxes.forEach(cb => {
            cb.onchange = function() {
                updateRowSelection(this);
                updateSelectionInfo();
                
                // Update select-all state
                const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = checkedCount === rowCheckboxes.length;
                    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < rowCheckboxes.length;
                }
            };
        });
        
        function updateRowSelection(checkbox) {
            const row = checkbox.closest('tr');
            if (row) {
                row.classList.toggle('selected', checkbox.checked);
            }
        }
        
        function updateSelectionInfo() {
            const selectedCount = document.querySelectorAll('.row-checkbox:checked').length;
            if (selectedCountEl) selectedCountEl.textContent = selectedCount;
            if (selectedInfo) {
                selectedInfo.classList.toggle('hidden', selectedCount === 0);
            }
        }
    }

    // Filter presets for common underwriter workflows
    function applyPreset(preset) {
        currentPreset = preset;
        
        // Update active preset button
        document.querySelectorAll('.filter-preset').forEach(btn => btn.classList.remove('active'));
        const presetBtn = document.querySelector(`[data-preset="${preset}"]`);
        if (presetBtn) presetBtn.classList.add('active');
        
        const params = { sort_by: SORT_BY, sort_dir: SORT_DIR, mode: getActiveMode() };
        
        switch(preset) {
            case 'targets':
                params.status = 'TARGET';
                break;
            case 'in-appetite':
                params.status = 'IN';
                break;
            case 'high-value':
                params.min_premium = '100000';
                break;
            case 'new-business':
                params.renewal_or_new_business = 'NEW_BUSINESS';
                break;
            case 'recent':
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                params.created_after = sevenDaysAgo.toISOString().split('T')[0];
                break;
            case 'all':
            default:
                // No additional filters
                break;
        }
        
        load(params);
    }

    async function load(params = {}) {
        // Always include an explicit mode so sorting/filtering doesn't change the cohort
        if (!params.mode) params.mode = getActiveMode();
        const qs = new URLSearchParams(params).toString();
        const tbody = document.getElementById("tbody");
        
        try {
            await withLoading(tbody, async () => {
                const response = await fetchJSON("/api/classified_mode?" + qs);
                const modeExpl = document.getElementById("sub_mode_expl");
                if (modeExpl) {
                    modeExpl.textContent = response.mode_explanation || "";
                }
                ALL_SUBMISSIONS = response.data || [];
                renderTable(ALL_SUBMISSIONS);
            });
        } catch (error) {
            toast("Failed to load submissions: " + error.message, "error");
        }
    }

    function clearAllFilters() {
        const fields = ['f_state', 'f_status', 'f_min', 'f_max', 'f_q'];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        // Reset mode to a stable default
        setActiveMode('balanced_growth');
        applyPreset('all');
    }

    function updateLastUpdated() {
        const el = document.getElementById("subs_last");
        if(!el) return;
        const d = new Date();
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        el.textContent = `Updated ${hh}:${mm}`;
    }

    // Event handlers
    document.addEventListener('DOMContentLoaded', () => {
        // Preset filter handlers
        document.querySelectorAll('.filter-preset').forEach(btn => {
            btn.addEventListener('click', () => {
                applyPreset(btn.dataset.preset);
            });
        });

        // Manual filter handlers
        const applyBtn = document.getElementById("btn_apply");
        if (applyBtn) {
            applyBtn.onclick = () => {
                const params = {
                    state: document.getElementById("f_state")?.value || "",
                    status: document.getElementById("f_status")?.value || "",
                    min_premium: document.getElementById("f_min")?.value || "",
                    max_premium: document.getElementById("f_max")?.value || "",
                    q: document.getElementById("f_q")?.value || "",
                    mode: getActiveMode(),
                    sort_by: SORT_BY,
                    sort_dir: SORT_DIR,
                };
                load(params);
            };
        }

        const clearBtn = document.getElementById("btn_clear");
        if (clearBtn) {
            clearBtn.onclick = clearAllFilters;
        }

        const refreshBtn = document.getElementById("btn_refresh");
        if (refreshBtn) {
            refreshBtn.onclick = () => {
                fetchJSON("/api/refresh", { method: "POST" })
                    .then(() => {
                        toast("Data refreshed", "success");
                        applyPreset(currentPreset);
                    })
                    .catch((err) => toast("Refresh failed: " + err.message, "error"));
            };
        }

        const exportBtn = document.getElementById("btn_export");
        if (exportBtn) {
            exportBtn.onclick = () => {
                toast('Export functionality will be available soon', 'info');
            };
        }

        // NLQ handler
        const nlqBtn = document.getElementById("btn_nlq");
        if (nlqBtn) {
            nlqBtn.onclick = () => {
                const query = document.getElementById("nlq")?.value.trim();
                if (!query) {
                    toast("Please enter a question", "warning");
                    return;
                }
                
                fetch("/api/nlq", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query }),
                })
                .then((r) => r.json())
                .then((j) => {
                    if (j.ok) {
                        // Apply the AI-generated filters
                        Object.entries(j.filters || {}).forEach(([key, value]) => {
                            const element = document.getElementById(`f_${key}`);
                            if (element) element.value = value;
                        });
                        const applyBtn = document.getElementById("btn_apply");
                        if (applyBtn) applyBtn.click();
                        toast("AI filters applied", "success");
                    } else {
                        toast("AI query failed: " + (j.error || "Unknown error"), "error");
                    }
                })
                .catch(() => toast("AI query failed", "error"));
            };
        }

        // Sorting handlers
        document.querySelectorAll(".th-sort").forEach((th) => {
            th.onclick = () => {
                const key = th.dataset.key;
                if (SORT_BY === key) {
                    SORT_DIR = SORT_DIR === "asc" ? "desc" : "asc";
                } else {
                    SORT_BY = key;
                    SORT_DIR = "desc";
                }
                
                // Update arrow indicators
                document.querySelectorAll(".arrow").forEach(a => a.textContent = "");
                const arrow = th.querySelector(".arrow");
                if (arrow) arrow.textContent = SORT_DIR === "asc" ? "‚Üë" : "‚Üì";
                
                // Reapply current filters with new sort
                if (currentPreset !== 'all') {
                    applyPreset(currentPreset);
                } else {
                    const applyBtn = document.getElementById("btn_apply");
                    if (applyBtn) applyBtn.click();
                }
            };
        });

        // Load modes and initialize
        loadModes().then(() => {
            // Ensure a deterministic default
            setActiveMode(getActiveMode());
            applyPreset('all');
        }).catch(() => {
            setActiveMode(getActiveMode());
            applyPreset('all');
        });
    });

    // Load available modes
    async function loadModes() {
        try {
            const modes = await fetchJSON('/api/modes');
            const sel = document.getElementById('f_mode');
            if (sel && Array.isArray(modes)) {
                sel.innerHTML = modes.map(m => `<option value="${m.key}">${m.label}</option>`).join('');
                // Pick a stable default
                const preferred = localStorage.getItem('ACTIVE_MODE') || 'balanced_growth';
                const keys = modes.map(m => m.key);
                const val = keys.includes(preferred) ? preferred : (keys.includes('balanced_growth') ? 'balanced_growth' : (keys[0] || 'balanced_growth'));
                sel.value = val;
                setActiveMode(val);
                sel.addEventListener('change', () => setActiveMode(sel.value));
            }
        } catch (error) {
            console.error('Failed to load modes:', error);
        }
    }

    function explain(id) {
        if (!id) {
            toast("No submission ID available", "error");
            return;
        }
        const mode = document.getElementById('f_mode')?.value;
        const url = mode && mode !== '' 
            ? `/api/explain/${id}?mode=${encodeURIComponent(mode)}`
            : `/api/explain/${id}`;
        fetch(url, { method: "POST" })
            .then((r) => r.json())
            .then((j) => {
                if (j.ok) {
                    showExplanationModal(j.explanation, id);
                } else {
                    toast("Failed to get explanation", "error");
                }
            })
            .catch((err) => {
                toast("Error getting explanation: " + err.message, "error");
            });
    }

    function addToWatch(id) {
        if (!id) {
            toast("No submission ID available", "error");
            return;
        }
        // Add to watch list functionality
        toast(`Added submission ${id} to watch list`, 'success');
    }

    function showExplanationModal(explanation, id) {
        // Create a simple modal for explanations
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="glass-panel max-w-2xl mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Appetite Explanation - ID ${id}</h3>
                    <button class="quick-action" onclick="this.closest('.fixed').remove()">‚úï</button>
                </div>
                <div class="text-sm leading-relaxed">${explanation}</div>
                <div class="mt-4 flex justify-end">
                    <button class="quick-action primary" onclick="this.closest('.fixed').remove()">Got it</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function clearAllFilters() {
        document.getElementById('f_state').value = '';
        document.getElementById('f_status').value = '';
        document.getElementById('f_min').value = '';
        document.getElementById('f_max').value = '';
        document.getElementById('f_q').value = '';
        setActiveMode('balanced_growth');
        applyPreset('all');
    }

    function updateLastUpdated() {
        const el = document.getElementById("subs_last");
        if(!el) return;
        const d = new Date();
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        el.textContent = `Updated ${hh}:${mm}`;
    }

    // Event handlers
    document.addEventListener('DOMContentLoaded', () => {
        // Preset filter handlers
        document.querySelectorAll('.filter-preset').forEach(btn => {
            btn.addEventListener('click', () => {
                applyPreset(btn.dataset.preset);
            });
        });

        // Manual filter handlers
        document.getElementById("btn_apply").onclick = () => {
            const params = {
                state: document.getElementById("f_state").value || "",
                status: document.getElementById("f_status").value || "",
                min_premium: document.getElementById("f_min").value || "",
                max_premium: document.getElementById("f_max").value || "",
                q: document.getElementById("f_q").value || "",
                mode: document.getElementById("f_mode").value || "",
                sort_by: SORT_BY,
                sort_dir: SORT_DIR,
            };
            load(params);
        };

        document.getElementById("btn_clear").onclick = clearAllFilters;

        document.getElementById("btn_export").onclick = () => {
            toast('Export functionality will be available soon', 'info');
        };

        // NLQ handler
        document.getElementById("btn_nlq").onclick = () => {
            const query = document.getElementById("nlq").value.trim();
            if (!query) {
                toast("Please enter a question", "warning");
                return;
            }
            
            fetch("/api/nlq", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query }),
            })
            .then((r) => r.json())
            .then((j) => {
                if (j.ok) {
                    // Apply the AI-generated filters
                    Object.entries(j.filters).forEach(([key, value]) => {
                        const element = document.getElementById(`f_${key}`);
                        if (element) element.value = value;
                    });
                    document.getElementById("btn_apply").click();
                    toast("AI filters applied", "success");
                } else {
                    toast("AI query failed: " + (j.error || "Unknown error"), "error");
                }
            });
        };

        // Sorting handlers
        document.querySelectorAll(".th-sort").forEach((th) => {
            th.onclick = () => {
                const key = th.dataset.key;
                if (SORT_BY === key) {
                    SORT_DIR = SORT_DIR === "asc" ? "desc" : "asc";
                } else {
                    SORT_BY = key;
                    SORT_DIR = "desc";
                }
                
                // Update arrow indicators
                document.querySelectorAll(".arrow").forEach(a => a.textContent = "");
                th.querySelector(".arrow").textContent = SORT_DIR === "asc" ? "‚Üë" : "‚Üì";
                
                // Reapply current filters with new sort
                if (currentPreset !== 'all') {
                    applyPreset(currentPreset);
                } else {
                    document.getElementById("btn_apply").click();
                }
            };
        });

        // Load modes and initialize
        loadModes().then(() => {
            applyPreset('all');
        });
    });

    // Load available modes
    async function loadModes() {
        try {
            const modes = await fetchJSON('/api/modes');
            const sel = document.getElementById('f_mode');
            if (sel && Array.isArray(modes)) {
                sel.innerHTML = modes.map(m => `<option value="${m.key}">${m.label}</option>`).join('');
                const preferred = localStorage.getItem('ACTIVE_MODE') || 'balanced_growth';
                const keys = modes.map(m => m.key);
                const val = keys.includes(preferred) ? preferred : (keys.includes('balanced_growth') ? 'balanced_growth' : (keys[0] || 'balanced_growth'));
                sel.value = val;
                setActiveMode(val);
                sel.addEventListener('change', () => setActiveMode(sel.value));
            }
        } catch (error) {
            console.error('Failed to load modes:', error);
        }
    }
    document.getElementById("btn_nlq").onclick = () => {
        const q = document.getElementById("nlq").value || "";
        fetchJSON("/api/nlq", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ q }),
        })
            .then((j) => {
                const f = j.filters || {};
                document.getElementById("f_state").value = f.state || "";
                document.getElementById("f_status").value = f.status || "";
                document.getElementById("f_min").value = f.min_premium || "";
                document.getElementById("f_max").value = f.max_premium || "";
                document.getElementById("f_q").value = f.search || "";
                document.getElementById("btn_apply").click();
            })
            .catch((err) => toast("NLQ failed: " + err.message, "error"));
    };

    async function populateModes() {
        const wrap = document.getElementById('f_mode_wrap');
        try {
            const j = await fetchJSON("/api/modes");
            const modes = (j.modes || []).filter(Boolean);
            const sel = document.getElementById("f_mode");
            if (!sel) return;
            if (!modes.length) {
                wrap?.classList?.add('hidden');
                sel.innerHTML = '<option value="" disabled selected>No modes available</option>';
                return;
            }
            wrap?.classList?.remove('hidden');
            sel.innerHTML = modes
                .map((m) => `<option value="${m}">${m.replace(/_/g,' ')}</option>`)
                .join("");
            // default to ACTIVE_MODE if available
            const active = localStorage.getItem('ACTIVE_MODE') || 'balanced_growth';
            sel.value = modes.includes(active) ? active : (modes.includes('balanced_growth') ? 'balanced_growth' : (modes[0] || ''));
        } catch (e) {
            console.error("Failed to load modes", e);
            wrap?.classList?.add('hidden');
        }
    }

    // Sorting handlers
    function updateSortHeaders() {
        document.querySelectorAll("th.th-sort").forEach((th) => {
            const key = th.dataset.key;
            const arrow = th.querySelector(".arrow");
            th.classList.toggle("active", key === SORT_BY);
            if (arrow) {
                if (key === SORT_BY) {
                    arrow.textContent = SORT_DIR === "asc" ? "‚ñ≤" : "‚ñº";
                } else {
                    arrow.textContent = "";
                }
            }
        });
    }
    document.querySelectorAll("th.th-sort").forEach((th) => {
        th.style.cursor = "pointer";
        th.addEventListener("click", () => {
            const key = th.dataset.key;
            if (SORT_BY === key) {
                SORT_DIR = SORT_DIR === "asc" ? "desc" : "asc";
            } else {
                SORT_BY = key;
                // Default direction: numeric desc, text asc
                const numeric = [
                    "id",
                    "total_premium",
                    "tiv",
                    "winnability",
                    "priority_score",
                ];
                SORT_DIR = numeric.includes(key) ? "desc" : "asc";
            }
            updateSortHeaders();
            document.getElementById("btn_apply").click();
        });
    });

    // Auto-apply on filter changes (debounced for inputs)
    function apply() {
        document.getElementById("btn_apply").click();
    }
    let t;
    function debouncedApply() {
        clearTimeout(t);
        t = setTimeout(apply, 300);
    }
    ["f_state", "f_status", "f_mode"].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("change", apply);
    });
    ["f_min", "f_max", "f_q"].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", debouncedApply);
    });

    populateModes()
        .then(() => {
            updateSortHeaders();
            apply();
        })
        .catch(() => {
            updateSortHeaders();
            load().catch((err) =>
                toast("Initial load failed: " + err.message, "error")
            );
        });

    let autoT;
    function startAuto() {
        clearInterval(autoT);
        autoT = setInterval(() => {
            if (!document.hidden) {
                load(LAST_PARAMS).catch((err) =>
                    toast("Auto-refresh failed: " + err.message, "error")
                );
            }
        }, 45000);
    }
    function stopAuto() {
        clearInterval(autoT);
    }
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) stopAuto();
        else startAuto();
    });
    startAuto();

    // Advanced filter toggle functionality
    function setupAdvancedFilters() {
        const toggleBtn = document.getElementById('toggle_advanced');
        const panel = document.getElementById('advanced_filter_panel');
        const arrow = toggleBtn?.querySelector('.toggle-arrow');
        
        if (toggleBtn && panel) {
            toggleBtn.onclick = () => {
                const isHidden = panel.classList.contains('hidden');
                panel.classList.toggle('hidden');
                toggleBtn.classList.toggle('active', !isHidden);
                
                if (arrow) {
                    arrow.textContent = isHidden ? '‚Üë' : '‚Üì';
                }
            };
        }
    }

    // Enhanced modal functionality for bulk actions and export
    function createBulkActionsModal() {
        const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.dataset.id);
        
        if (selectedIds.length === 0) {
            toast('Please select submissions first', 'warning');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="glass-panel max-w-md mx-4 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Bulk Actions</h3>
                    <button class="control-btn" onclick="this.closest('.fixed').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-sm opacity-75 mb-6">${selectedIds.length} submissions selected</p>
                
                <div class="bulk-actions-grid grid grid-cols-2 gap-3">
                    <button class="bulk-action-btn" onclick="performBulkAction('watch', ${JSON.stringify(selectedIds)}); this.closest('.fixed').remove();">
                        <i class="fas fa-eye"></i>
                        Add to Watch List
                    </button>
                    <button class="bulk-action-btn" onclick="performBulkAction('priority', ${JSON.stringify(selectedIds)}); this.closest('.fixed').remove();">
                        <i class="fas fa-star"></i>
                        Mark Priority
                    </button>
                    <button class="bulk-action-btn" onclick="performBulkAction('export', ${JSON.stringify(selectedIds)}); this.closest('.fixed').remove();">
                        <i class="fas fa-download"></i>
                        Export Selected
                    </button>
                    <button class="bulk-action-btn" onclick="performBulkAction('notes', ${JSON.stringify(selectedIds)}); this.closest('.fixed').remove();">
                        <i class="fas fa-comment"></i>
                        Add Notes
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function createExportModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="glass-panel max-w-md mx-4 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Export Submissions</h3>
                    <button class="control-btn" onclick="this.closest('.fixed').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="export-option">
                        <label class="flex items-center gap-3 p-3 border border-white/10 rounded-lg cursor-pointer hover:bg-white/5">
                            <input type="radio" name="export_format" value="csv" checked class="accent-indigo-500">
                            <div>
                                <div class="font-semibold">CSV File</div>
                                <div class="text-sm opacity-75">Spreadsheet compatible format</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="export-option">
                        <label class="flex items-center gap-3 p-3 border border-white/10 rounded-lg cursor-pointer hover:bg-white/5">
                            <input type="radio" name="export_format" value="pdf" class="accent-indigo-500">
                            <div>
                                <div class="font-semibold">PDF Report</div>
                                <div class="text-sm opacity-75">Formatted business report</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="export-option">
                        <label class="flex items-center gap-3 p-3 border border-white/10 rounded-lg cursor-pointer hover:bg-white/5">
                            <input type="radio" name="export_format" value="json" class="accent-indigo-500">
                            <div>
                                <div class="font-semibold">JSON Data</div>
                                <div class="text-sm opacity-75">Raw data format</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button class="control-btn flex-1" onclick="this.closest('.fixed').remove()">Cancel</button>
                    <button class="control-btn flex-1 bg-indigo-600 hover:bg-indigo-700" onclick="performExport(); this.closest('.fixed').remove();">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function createColumnsModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="glass-panel max-w-md mx-4 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Manage Columns</h3>
                    <button class="control-btn" onclick="this.closest('.fixed').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-3">
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>Priority Score</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>Appetite Status</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>Account Name</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>State</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>Premium</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>TIV</span>
                    </label>
                    <label class="flex items-center gap-3 p-2 hover:bg-white/5 rounded cursor-pointer">
                        <input type="checkbox" checked class="accent-indigo-500">
                        <span>Winnability</span>
                    </label>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button class="control-btn flex-1" onclick="this.closest('.fixed').remove()">Cancel</button>
                    <button class="control-btn flex-1 bg-indigo-600 hover:bg-indigo-700" onclick="applyColumns(); this.closest('.fixed').remove();">
                        Apply
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Bulk action handlers
    function performBulkAction(action, ids) {
        switch(action) {
            case 'watch':
                toast(`Added ${ids.length} submissions to watch list`, 'success');
                break;
            case 'priority':
                toast(`Marked ${ids.length} submissions as priority`, 'success');
                break;
            case 'export':
                toast(`Exported ${ids.length} submissions`, 'success');
                break;
            case 'notes':
                toast(`Added notes to ${ids.length} submissions`, 'success');
                break;
        }
        
        // Clear selections
        document.querySelectorAll('.row-checkbox:checked').forEach(cb => cb.checked = false);
        document.getElementById('select-all').checked = false;
        document.querySelector('.selected-info').classList.add('hidden');
    }

    function performExport() {
        const format = document.querySelector('input[name="export_format"]:checked')?.value || 'csv';
        toast(`Exporting data as ${format.toUpperCase()}...`, 'info');
        
        // Simulate export
        setTimeout(() => {
            toast(`Export completed successfully`, 'success');
        }, 2000);
    }

    function applyColumns() {
        toast('Column visibility updated', 'success');
    }

    // Initialize enhanced features on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        // Setup advanced filters
        setupAdvancedFilters();
        
        // Table control handlers
        document.getElementById('bulk-actions-btn')?.addEventListener('click', createBulkActionsModal);
        document.getElementById('export-submissions-btn')?.addEventListener('click', createExportModal);
        document.getElementById('columns-btn')?.addEventListener('click', createColumnsModal);
        
        // Save filter preset functionality
        document.getElementById('save_filter_preset')?.addEventListener('click', () => {
            const presetName = prompt('Enter a name for this filter preset:');
            if (presetName && presetName.trim()) {
                const filters = {
                    state: document.getElementById('f_state')?.value || '',
                    status: document.getElementById('f_status')?.value || '',
                    mode: document.getElementById('f_mode')?.value || '',
                    min_premium: document.getElementById('f_min')?.value || '',
                    max_premium: document.getElementById('f_max')?.value || '',
                    search: document.getElementById('f_q')?.value || ''
                };
                
                const savedPresets = JSON.parse(localStorage.getItem('filterPresets') || '{}');
                savedPresets[presetName.trim()] = filters;
                localStorage.setItem('filterPresets', JSON.stringify(savedPresets));
                
                toast(`Filter preset "${presetName}" saved successfully`, 'success');
                updateFilterPresets();
            }
        });
        
        // Clear all filters functionality
        document.getElementById('clear_all_filters')?.addEventListener('click', () => {
            if (confirm('Clear all current filters?')) {
                clearAllFilters();
                toast('All filters cleared', 'success');
            }
        });
        
        // View toggle handlers
        document.querySelectorAll('[data-view]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const view = btn.dataset.view;
                if (view === 'cards') {
                    toast('Card view coming soon', 'info');
                }
            });
        });
        
        // Search clear button
        const searchInput = document.getElementById('f_q');
        const clearBtn = document.getElementById('clear_search');
        
        if (searchInput && clearBtn) {
            searchInput.addEventListener('input', () => {
                clearBtn.classList.toggle('hidden', !searchInput.value);
            });
            
            clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearBtn.classList.add('hidden');
                // Trigger search update
                document.getElementById('btn_apply')?.click();
            });
        }
    });
    
    function updateFilterPresets() {
        // This would update the filter presets display
        console.log('Filter presets updated');
    }
</script>
<!-- D3 + TopoJSON for the US map -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script>
    (function(){
        const ABBR_TO_FIPS = {
            AL:"01", AK:"02", AZ:"04", AR:"05", CA:"06", CO:"08", CT:"09", DE:"10", DC:"11",
            FL:"12", GA:"13", HI:"15", ID:"16", IL:"17", IN:"18", IA:"19", KS:"20", KY:"21",
            LA:"22", ME:"23", MD:"24", MA:"25", MI:"26", MN:"27", MS:"28", MO:"29", MT:"30",
            NE:"31", NV:"32", NH:"33", NJ:"34", NM:"35", NY:"36", NC:"37", ND:"38", OH:"39",
            OK:"40", OR:"41", PA:"42", RI:"44", SC:"45", SD:"46", TN:"47", TX:"48", UT:"49",
            VT:"50", VA:"51", WA:"53", WV:"54", WI:"55", WY:"56", PR:"72"
        };
        const FIPS_TO_ABBR = Object.fromEntries(Object.entries(ABBR_TO_FIPS).map(([k,v])=>[v,k]));
        const STATE_NAMES = {
            AL:'Alabama', AK:'Alaska', AZ:'Arizona', AR:'Arkansas', CA:'California', CO:'Colorado', CT:'Connecticut', DE:'Delaware', DC:'District of Columbia',
            FL:'Florida', GA:'Georgia', HI:'Hawaii', ID:'Idaho', IL:'Illinois', IN:'Indiana', IA:'Iowa', KS:'Kansas', KY:'Kentucky',
            LA:'Louisiana', ME:'Maine', MD:'Maryland', MA:'Massachusetts', MI:'Michigan', MN:'Minnesota', MS:'Mississippi', MO:'Missouri', MT:'Montana',
            NE:'Nebraska', NV:'Nevada', NH:'New Hampshire', NJ:'New Jersey', NM:'New Mexico', NY:'New York', NC:'North Carolina', ND:'North Dakota', OH:'Ohio',
            OK:'Oklahoma', OR:'Oregon', PA:'Pennsylvania', RI:'Rhode Island', SC:'South Carolina', SD:'South Dakota', TN:'Tennessee', TX:'Texas', UT:'Utah',
            VT:'Vermont', VA:'Virginia', WA:'Washington', WV:'West Virginia', WI:'Wisconsin', WY:'Wyoming', PR:'Puerto Rico'
        };

        let US_TOPO = null, STATES = null, PATH = null, PROJ = null;
        const svg = document.getElementById('us_map');
        const wrap = document.getElementById('us_map_wrap');
        const tooltip = document.getElementById('us_map_tooltip');
        const summary = document.getElementById('us_map_summary');

        async function ensureTopo(){
            if (US_TOPO) return;
            const url = 'https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json';
            US_TOPO = await fetch(url).then(r=>r.json()).catch(()=>null);
            if (!US_TOPO) return;
            STATES = topojson.feature(US_TOPO, US_TOPO.objects.states).features;
            PROJ = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
            PATH = d3.geoPath(PROJ);
        }

        function buildParams(){
            const p = new URLSearchParams();
            const status = document.getElementById('f_status')?.value?.trim();
            const minp = document.getElementById('f_min')?.value?.trim();
            const maxp = document.getElementById('f_max')?.value?.trim();
            const q = document.getElementById('f_q')?.value?.trim();
            if (status) p.set('status', status);
            if (minp) p.set('min_premium', minp);
            if (maxp) p.set('max_premium', maxp);
            if (q) p.set('q', q);
            p.set('group', 'primary_risk_state');
            p.set('metric', 'count');
            p.set('series_by', 'appetite_status');
            return p.toString();
        }

        async function fetchAgg(){
            const qs = buildParams();
            const res = await fetch(`/api/aggregate?${qs}`);
            if(!res.ok) throw new Error(`${res.status}`);
            return res.json();
        }

        function makeScale(counts){
            const vals = Object.values(counts);
            const max = Math.max(1, ...vals);
            return d3.scaleSequential().domain([0, max]).interpolator(d3.interpolatePuBu);
        }

        function hideTip(){ tooltip.classList.add('hidden'); }
        function showTip(html, x, y){
            tooltip.innerHTML = html;
            tooltip.style.left = (x + 12) + 'px';
            tooltip.style.top = (y + 12) + 'px';
            tooltip.classList.remove('hidden');
        }

        function renderStates(counts, breakdown){
            if (!svg || !STATES || !PATH) return;
            const d3svg = d3.select(svg);
            d3svg.selectAll('*').remove();

            // Draw states
            const scale = makeScale(counts);
            d3svg.append('g')
                .selectAll('path')
                .data(STATES)
                .join('path')
                .attr('d', PATH)
                .attr('class', 'us-state')
                .attr('fill', d => {
                    const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')];
                    const c = counts[abbr] || 0;
                    return c ? scale(c) : 'rgba(255,255,255,0.06)';
                })
                .attr('stroke', 'rgba(255,255,255,0.12)')
                .attr('stroke-width', 0.6)
                .on('mousemove', (event, d) => {
                    const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')];
                    const name = STATE_NAMES[abbr] || abbr || 'Unknown';
                    const c = counts[abbr] || 0;
                    const b = breakdown[abbr] || {};
                    const tgt = b['TARGET'] || 0, inn = b['IN'] || 0, out = b['OUT'] || 0;
                    const html = `<div class=\"text-xs\"><div class=\"font-semibold\">${name} (${abbr || '-'})</div><div class=\"opacity-80\">${c} submissions</div><div class=\"mt-1\"><span class=\"pill pill-indigo\">üéØ ${tgt}</span> <span class=\"pill pill-emerald\">‚úÖ ${inn}</span> <span class=\"pill pill-rose\">‚ùå ${out}</span></div></div>`;
                    const box = (wrap || svg).getBoundingClientRect();
                    showTip(html, event.clientX - box.left, event.clientY - box.top);
                })
                .on('mouseleave', hideTip)
                .on('click', (event, d) => {
                    const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')];
                    const inp = document.getElementById('f_state');
                    if (inp){ inp.value = abbr || ''; }
                    document.getElementById('btn_apply')?.click();
                });

            // State borders overlay for clarity
            const mesh = topojson.mesh(US_TOPO, US_TOPO.objects.states, (a,b)=>a!==b);
            d3svg.append('path')
                .attr('fill','none')
                .attr('stroke','rgba(255,255,255,0.22)')
                .attr('stroke-width',1)
                .attr('d', PATH(mesh));
        }

        function updateLegend(max){
            const wrap = document.querySelector('#us_map_wrap .legend-bar');
            const sum = document.getElementById('us_map_summary');
            if (wrap) {
                // CSS handles gradient; nothing dynamic needed
            }
            if (sum) sum.textContent = `Max state volume: ${max}`;
        }

        async function renderUSMap(){
            await ensureTopo();
            if (!US_TOPO) return;
            const j = await fetchAgg();
            const labels = j.labels || [];
            const series = j.series || [];
            // Build breakdown and totals by state abbr
            const breakdown = {};
            const totals = {};
            labels.forEach((abbr, i) => {
                if (!/^[A-Z]{2}$/.test(abbr)) return;
                const row = {};
                let total = 0;
                for (const s of series){
                    const v = Number(s.data?.[i] || 0);
                    row[s.name] = v;
                    total += v;
                }
                breakdown[abbr] = row;
                totals[abbr] = total;
            });
            const max = Math.max(1, ...Object.values(totals));
            renderStates(totals, breakdown);
            updateLegend(max);
        }

        // Initial render and bind to filter changes
        document.addEventListener('DOMContentLoaded', () => {
            renderUSMap().catch(e=>console.error('Map render failed', e));
            const ids = ['f_state','f_status','f_min','f_max','f_q'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('change', ()=> renderUSMap());
                el.addEventListener('input', ()=> renderUSMap());
            });
            document.querySelectorAll('.filter-preset').forEach(btn=>{
                btn.addEventListener('click', ()=> setTimeout(()=>renderUSMap(), 50));
            });
        });

        // Expose for manual refresh if needed
        window.refreshUSMap = renderUSMap;
    })();
</script>
<script type="module">
    import { startAutoRefresh } from "{{ url_for('static', filename='js/refresh.js') }}";
    function endpointBuilder(){
        const p = {
          state: document.getElementById('f_state').value || '',
          status: document.getElementById('f_status').value || '',
          min_premium: document.getElementById('f_min').value || '',
          max_premium: document.getElementById('f_max').value || '',
          q: document.getElementById('f_q').value || '',
          mode: (typeof getActiveMode === 'function') ? getActiveMode() : (document.getElementById('f_mode').value || (localStorage.getItem('ACTIVE_MODE') || 'balanced_growth')),
          sort_by: window.SORT_BY,
          sort_dir: window.SORT_DIR,
        };
        const qs = new URLSearchParams(p).toString();
        return `/api/classified_mode?${qs}`;
    }
    function hashSelector(row){
      return {
        id: row.id,
        account_name: row.account_name,
        primary_risk_state: row.primary_risk_state,
        line_of_business: row.line_of_business,
        total_premium: row.total_premium,
        tiv: row.tiv,
        winnability: row.winnability,
        appetite_status: row.appetite_status,
        priority_score: row.priority_score,
      };
    }
    const ctl = startAutoRefresh({
      targetId: 'tbody',
      endpointBuilder,
      hashSelector,
      onUpdate: (json, changed) => {
        const rows = json?.data || [];
        if (changed) { window.renderTable?.(rows); window.refreshUSMap?.(); }
        const el = document.getElementById('subs_last');
        if (el) {
          const d = new Date();
          const hh = d.getHours().toString().padStart(2,'0');
          const mm = d.getMinutes().toString().padStart(2,'0');
          el.textContent = `Last updated ${hh}:${mm}`;
        }
      },
    });
    // Trigger immediate refresh on filter and sort changes
    ['f_state','f_status','f_mode','f_min','f_max','f_q'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('change', ()=> ctl?.triggerNow());
      el.addEventListener('input', ()=> ctl?.triggerNow());
    });
    document.querySelectorAll('th.th-sort').forEach(th => {
      th.addEventListener('click', ()=> ctl?.triggerNow());
    });
    window._subsRefreshCtl = ctl;
</script>
{% endblock %}
