{% extends "base.html" %} {% block content %}
<!-- Enhanced Underwriter Filters -->
<div class="glass-panel p-4 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Submission Pipeline</h2>
        <div class="flex items-center gap-2">
            <span id="subs_count" class="pill pill-sub">‚Äî submissions</span>
            <span id="subs_last" class="text-xs opacity-70"></span>
        </div>
    </div>
    
    <!-- Quick Filter Presets -->
    <div class="mb-4">
        <div class="flex flex-wrap gap-2 mb-3">
            <button class="quick-action filter-preset active" data-preset="all">üìã All Submissions</button>
            <button class="quick-action filter-preset" data-preset="targets">üéØ Targets Only</button>
            <button class="quick-action filter-preset" data-preset="in-appetite">‚úÖ In-Appetite</button>
            <button class="quick-action filter-preset" data-preset="high-value">üíé High Value ($100k+)</button>
            <button class="quick-action filter-preset" data-preset="new-business">üÜï New Business</button>
            <button class="quick-action filter-preset" data-preset="recent">‚è∞ Recent (7 days)</button>
        </div>
    </div>
    <div>
        <label class="lbl">Mode</label>
        <select id="f_mode" class="inp"></select>
        <span id="sub_mode_expl" class="ml-2 text-xs opacity-70"></span>
    </div>
    
    <div class="flex items-center justify-between mt-4">
        <div class="flex items-center gap-2">
            <button id="btn_apply" class="quick-action primary">Apply Filters</button>
            <button id="btn_clear" class="quick-action">Clear All</button>
            <button id="btn_save_filter" class="quick-action">üíæ Save Filter</button>
        </div>
        <div class="flex items-center gap-2">
            <input id="nlq" class="inp w-72" placeholder="Ask: 'Show targets in CA over $100k premium'" />
            <button id="btn_nlq" class="quick-action">Ask AI</button>
            <button id="btn_refresh" class="quick-action">üîÑ Refresh</button>
            <button id="btn_export" class="quick-action">üìä Export</button>
        </div>
    </div>
</div>

<!-- Enhanced Table -->
<div class="enhanced-table">
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="border-b border-white border-opacity-10">
                <tr>
                    <th class="th th-sort text-left py-4 px-6" data-key="priority_score">
                        Priority <span class="arrow"></span>
                    </th>
                    <th class="th th-sort text-left py-4 px-4" data-key="appetite_status">
                        Status <span class="arrow"></span>
                    </th>
                    <th class="th th-sort text-left py-4 px-4" data-key="account_name">
                        Account <span class="arrow"></span>
                    </th>
                    <th class="th th-sort text-left py-4 px-4" data-key="primary_risk_state">
                        State <span class="arrow"></span>
                    </th>
                    <th class="th th-sort text-left py-4 px-4" data-key="total_premium">
                        Premium <span class="arrow"></span>
                    </th>
                    <th class="th th-sort text-left py-4 px-4" data-key="tiv">
                        TIV <span class="arrow"></span>
                    </th>
                    <th class="th th-sort text-left py-4 px-4" data-key="winnability">
                        Win% <span class="arrow"></span>
                    </th>
                    <th class="th text-left py-4 px-4">Actions</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
    
    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-12">
        <div class="text-4xl mb-3">üìã</div>
        <h3 class="text-lg font-semibold mb-2">No submissions match your filters</h3>
        <p class="text-sm opacity-75 mb-4">Try adjusting your criteria or use one of the preset filters above</p>
        <button class="quick-action primary" onclick="clearAllFilters()">Clear All Filters</button>
    </div>
</div>

<script>
    let SORT_BY = "priority_score";
    let SORT_DIR = "desc";
    let ALL_SUBMISSIONS = [];
    let currentPreset = "all";

    let LAST_PARAMS = {};
    let lastHash = "";
    async function load(params = {}) {
        LAST_PARAMS = params;
        const qs = new URLSearchParams(params).toString();
        const tb = document.getElementById("tbody");
        await withLoading(tb, async () => {
            const j = await fetchJSON("/api/classified_mode?" + qs);
            document.getElementById("sub_mode_expl").textContent =
                j.mode_explanation || "";
            const newHash = JSON.stringify(j.data || []);
            if (newHash === lastHash) return;
            lastHash = newHash;
            tb.innerHTML = (j.data || [])
                .map(
                    (r) => `
      <tr class="tr">
        <td class="td">${r.id}</td>
        <td class="td"><a class="link" href="/detail/${
            r.id
        }?mode=${encodeURIComponent(
                        document.getElementById("f_mode").value || ""
                    )}">${r.account_name || "-"}</a></td>
        <td class="td">${r.primary_risk_state || "-"}</td>
        <td class="td">${r.line_of_business || "-"}</td>
        <td class="td">$${Math.round(
            r.total_premium || 0
        ).toLocaleString()}</td>
        <td class="td">$${Math.round(r.tiv || 0).toLocaleString()}</td>
        <td class="td">${
            typeof r.winnability === "number"
                ? Number(
                      r.winnability > 1 ? r.winnability : r.winnability * 100
                  ).toFixed(0) + "%"
                : "-"
        }</td>
        <td class="td">${badge(r.appetite_status)}</td>
        <td class="td">${Number(r.priority_score || 0).toFixed(2)}</td>
        <td class="td"><button class="pill pill-sub" onclick="explain(${
            r.id
        })">Explain</button></td>
      </tr>
    `
                )
                .join("");
            toast(`Updated ${j.count} results`, "info");
        });
    }
    function badge(s) {
        if (s === "TARGET")
            return `<span class="pill pill-indigo">Target</span>`;
        if (s === "IN") return `<span class="pill pill-emerald">In</span>`;
        return `<span class="pill pill-rose">Out</span>`;
    }
    function explain(id) {
        const mode = document.getElementById("f_mode").value || "";
        const url = mode
            ? `/api/explain/${id}?mode=${encodeURIComponent(mode)}`
            : `/api/explain/${id}`;
        fetch(url, { method: "POST" })
            .then((r) => r.json())
            .then((j) => {
                if (j.ok) {
                    showExplanationModal(j.explanation, id);
                } else {
                    toast("Failed to get explanation", "error");
                }
            });
    }

    function addToWatch(id) {
        // Add to watch list functionality
        toast(`Added submission ${id} to watch list`, 'success');
    }

    function showExplanationModal(explanation, id) {
        // Create a simple modal for explanations
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="glass-panel max-w-2xl mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Appetite Explanation - ID ${id}</h3>
                    <button class="quick-action" onclick="this.closest('.fixed').remove()">‚úï</button>
                </div>
                <div class="text-sm leading-relaxed">${explanation}</div>
                <div class="mt-4 flex justify-end">
                    <button class="quick-action primary" onclick="this.closest('.fixed').remove()">Got it</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function clearAllFilters() {
        document.getElementById('f_state').value = '';
        document.getElementById('f_status').value = '';
        document.getElementById('f_min').value = '';
        document.getElementById('f_max').value = '';
        document.getElementById('f_q').value = '';
        applyPreset('all');
    }

    function updateLastUpdated() {
        const el = document.getElementById("subs_last");
        if(!el) return;
        const d = new Date();
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        el.textContent = `Updated ${hh}:${mm}`;
    }

    // Event handlers
    document.addEventListener('DOMContentLoaded', () => {
        // Preset filter handlers
        document.querySelectorAll('.filter-preset').forEach(btn => {
            btn.addEventListener('click', () => {
                applyPreset(btn.dataset.preset);
            });
        });

        // Manual filter handlers
        document.getElementById("btn_apply").onclick = () => {
            const params = {
                state: document.getElementById("f_state").value || "",
                status: document.getElementById("f_status").value || "",
                min_premium: document.getElementById("f_min").value || "",
                max_premium: document.getElementById("f_max").value || "",
                q: document.getElementById("f_q").value || "",
                mode: document.getElementById("f_mode").value || "",
                sort_by: SORT_BY,
                sort_dir: SORT_DIR,
            };
            load(params);
        };

        document.getElementById("btn_clear").onclick = clearAllFilters;

        document.getElementById("btn_refresh").onclick = () => {
            fetchJSON("/api/refresh", { method: "POST" })
                .then(() => {
                    toast("Data refreshed", "success");
                    applyPreset(currentPreset);
                })
                .catch((err) => toast("Refresh failed: " + err.message, "error"));
        };

        document.getElementById("btn_export").onclick = () => {
            toast('Export functionality will be available soon', 'info');
        };

        // NLQ handler
        document.getElementById("btn_nlq").onclick = () => {
            const query = document.getElementById("nlq").value.trim();
            if (!query) {
                toast("Please enter a question", "warning");
                return;
            }
            
            fetch("/api/nlq", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query }),
            })
            .then((r) => r.json())
            .then((j) => {
                if (j.ok) {
                    // Apply the AI-generated filters
                    Object.entries(j.filters).forEach(([key, value]) => {
                        const element = document.getElementById(`f_${key}`);
                        if (element) element.value = value;
                    });
                    document.getElementById("btn_apply").click();
                    toast("AI filters applied", "success");
                } else {
                    toast("AI query failed: " + (j.error || "Unknown error"), "error");
                }
            });
        };

        // Sorting handlers
        document.querySelectorAll(".th-sort").forEach((th) => {
            th.onclick = () => {
                const key = th.dataset.key;
                if (SORT_BY === key) {
                    SORT_DIR = SORT_DIR === "asc" ? "desc" : "asc";
                } else {
                    SORT_BY = key;
                    SORT_DIR = "desc";
                }
                
                // Update arrow indicators
                document.querySelectorAll(".arrow").forEach(a => a.textContent = "");
                th.querySelector(".arrow").textContent = SORT_DIR === "asc" ? "‚Üë" : "‚Üì";
                
                // Reapply current filters with new sort
                if (currentPreset !== 'all') {
                    applyPreset(currentPreset);
                } else {
                    document.getElementById("btn_apply").click();
                }
            };
        });

        // Load modes and initialize
        loadModes().then(() => {
            applyPreset('all');
        });
    });

    // Load available modes
    async function loadModes() {
        try {
            const modes = await fetchJSON('/api/modes');
            const sel = document.getElementById('f_mode');
            
            if (sel) {
                sel.innerHTML = modes.map(m => 
                    `<option value="${m.key}">${m.label}</option>`
                ).join('');
            }
        } catch (error) {
            console.error('Failed to load modes:', error);
        }
    })
        );
    };
    document.getElementById("btn_nlq").onclick = () => {
        const q = document.getElementById("nlq").value || "";
        fetchJSON("/api/nlq", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ q }),
        })
            .then((j) => {
                const f = j.filters || {};
                document.getElementById("f_state").value = f.state || "";
                document.getElementById("f_status").value = f.status || "";
                document.getElementById("f_min").value = f.min_premium || "";
                document.getElementById("f_max").value = f.max_premium || "";
                document.getElementById("f_q").value = f.search || "";
                document.getElementById("btn_apply").click();
            })
            .catch((err) => toast("NLQ failed: " + err.message, "error"));
    };
    document.getElementById("btn_refresh").onclick = () => {
        fetchJSON("/api/refresh", { method: "POST" })
            .then(() => {
                toast("Data refreshed", "success");
                document.getElementById("btn_apply").click();
            })
            .catch((err) => toast("Refresh failed: " + err.message, "error"));
    };

    async function populateModes() {
        const wrap = document.getElementById('f_mode_wrap');
        try {
            const j = await fetchJSON("/api/modes");
            const modes = (j.modes || []).filter(Boolean);
            const sel = document.getElementById("f_mode");
            if (!sel) return;
            if (!modes.length) {
                wrap?.classList?.add('hidden');
                sel.innerHTML = '<option value="" disabled selected>No modes available</option>';
                return;
            }
            wrap?.classList?.remove('hidden');
            sel.innerHTML = modes
                .map((m) => `<option value="${m}">${m.replace(/_/g,' ')}</option>`)
                .join("");
            // default to ACTIVE_MODE if available
            const active = localStorage.getItem('ACTIVE_MODE') || 'balanced_growth';
            sel.value = modes.includes(active) ? active : (modes.includes('balanced_growth') ? 'balanced_growth' : (modes[0] || ''));
        } catch (e) {
            console.error("Failed to load modes", e);
            wrap?.classList?.add('hidden');
        }
    }

    // Sorting handlers
    function updateSortHeaders() {
        document.querySelectorAll("th.th-sort").forEach((th) => {
            const key = th.dataset.key;
            const arrow = th.querySelector(".arrow");
            th.classList.toggle("active", key === SORT_BY);
            if (arrow) {
                if (key === SORT_BY) {
                    arrow.textContent = SORT_DIR === "asc" ? "‚ñ≤" : "‚ñº";
                } else {
                    arrow.textContent = "";
                }
            }
        });
    }
    document.querySelectorAll("th.th-sort").forEach((th) => {
        th.style.cursor = "pointer";
        th.addEventListener("click", () => {
            const key = th.dataset.key;
            if (SORT_BY === key) {
                SORT_DIR = SORT_DIR === "asc" ? "desc" : "asc";
            } else {
                SORT_BY = key;
                // Default direction: numeric desc, text asc
                const numeric = [
                    "id",
                    "total_premium",
                    "tiv",
                    "winnability",
                    "priority_score",
                ];
                SORT_DIR = numeric.includes(key) ? "desc" : "asc";
            }
            updateSortHeaders();
            document.getElementById("btn_apply").click();
        });
    });

    // Auto-apply on filter changes (debounced for inputs)
    function apply() {
        document.getElementById("btn_apply").click();
    }
    let t;
    function debouncedApply() {
        clearTimeout(t);
        t = setTimeout(apply, 300);
    }
    ["f_state", "f_status", "f_mode"].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("change", apply);
    });
    ["f_min", "f_max", "f_q"].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", debouncedApply);
    });

    populateModes()
        .then(() => {
            updateSortHeaders();
            apply();
        })
        .catch(() => {
            updateSortHeaders();
            load().catch((err) =>
                toast("Initial load failed: " + err.message, "error")
            );
        });

    let autoT;
    function startAuto() {
        clearInterval(autoT);
        autoT = setInterval(() => {
            if (!document.hidden) {
                load(LAST_PARAMS).catch((err) =>
                    toast("Auto-refresh failed: " + err.message, "error")
                );
            }
        }, 45000);
    }
    function stopAuto() {
        clearInterval(autoT);
    }
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) stopAuto();
        else startAuto();
    });
    startAuto();
</script>
<script type="module">
    import { startAutoRefresh } from "{{ url_for('static', filename='js/refresh.js') }}";
    function endpointBuilder(){
        const p = {
          state: document.getElementById('f_state').value || '',
          status: document.getElementById('f_status').value || '',
          min_premium: document.getElementById('f_min').value || '',
          max_premium: document.getElementById('f_max').value || '',
          q: document.getElementById('f_q').value || '',
          mode: document.getElementById('f_mode').value || (localStorage.getItem('ACTIVE_MODE') || 'balanced_growth'),
          sort_by: window.SORT_BY,
          sort_dir: window.SORT_DIR,
        };
        const qs = new URLSearchParams(p).toString();
        return `/api/classified_mode?${qs}`;
    }
    function hashSelector(row){
      return {
        id: row.id,
        account_name: row.account_name,
        primary_risk_state: row.primary_risk_state,
        line_of_business: row.line_of_business,
        total_premium: row.total_premium,
        tiv: row.tiv,
        winnability: row.winnability,
        appetite_status: row.appetite_status,
        priority_score: row.priority_score,
      };
    }
    const ctl = startAutoRefresh({
      targetId: 'tbody',
      endpointBuilder,
      hashSelector,
      onUpdate: (json, changed) => {
        const rows = json?.data || [];
        if (changed) { window.renderTable?.(rows); }
        const el = document.getElementById('subs_last');
        if (el) {
          const d = new Date();
          const hh = d.getHours().toString().padStart(2,'0');
          const mm = d.getMinutes().toString().padStart(2,'0');
          el.textContent = `Last updated ${hh}:${mm}`;
        }
      },
    });
    // Trigger immediate refresh on filter and sort changes
    ['f_state','f_status','f_mode','f_min','f_max','f_q'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('change', ()=> ctl?.triggerNow());
      el.addEventListener('input', ()=> ctl?.triggerNow());
    });
    document.querySelectorAll('th.th-sort').forEach(th => {
      th.addEventListener('click', ()=> ctl?.triggerNow());
    });
    window._subsRefreshCtl = ctl;
</script>
{% endblock %}
