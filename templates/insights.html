{% extends "base.html" %} {% block content %}
<div class="flex items-center justify-between mb-4">
    <div>
        <h1 class="text-xl font-semibold">Portfolio Insights</h1>
        <div class="text-sm opacity-75">
            Configurable dashboards to interrogate your portfolio â€” fullscreen,
            edit, share, and download.
        </div>
    </div>
    <div class="flex items-center gap-2 text-xs">
        <span class="chip">Role: {{ role }}</span>
        <a href="?role=uw" class="pill pill-sub">UW</a>
        <a href="?role=leader" class="pill pill-sub">Leader</a>
        <a href="?role=admin" class="pill pill-sub">Admin</a>
    </div>
</div>

<div class="glass-panel p-2">
    <div class="flex gap-2 text-sm">
        {% for t in tabs[:1] %} {% set is_disabled = (t.protected and role not in
        ['leader','admin']) %}
        <button
            class="pill pill-indigo tabbtn"
            data-tab="{{ t.id }}"
            {%
            if
            is_disabled
            %}disabled
            title="Restricted to leaders/admins"
            {%
            endif
            %}
        >
            {{ t.title }}
        </button>
        {% endfor %}
    </div>
</div>

<div id="tab_content" class="mt-4 space-y-6"></div>

<!-- Fullscreen overlay -->
<div id="fs_overlay" class="overlay hidden">
    <div class="overlay-inner">
        <div class="flex items-center justify-between mb-2">
            <div class="text-sm opacity-80">Fullscreen</div>
            <button class="pill pill-sub" onclick="closeFullscreen()">
                Close
            </button>
        </div>
        <div id="fs_host" class="h-[70vh]"></div>
    </div>
</div>

<!-- Data modal -->
<div id="data_modal" class="overlay hidden">
    <div class="overlay-inner max-w-5xl">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
                <div class="text-sm opacity-80">Underlying Data</div>
                <button id="dl_raw_csv" class="pill pill-sub">
                    Download CSV
                </button>
            </div>
            <button class="pill pill-sub" onclick="closeDataModal()">
                Close
            </button>
        </div>
        <div id="data_table" class="overflow-auto max-h-[70vh]"></div>
    </div>
</div>

<!-- Visualization libs -->
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script>
    // --- Utilities ---
    function copyToClipboard(txt) {
        navigator.clipboard
            ?.writeText(txt)
            .then(() => toast("Link copied", "success"))
            .catch(() => {
                const ta = document.createElement("textarea");
                ta.value = txt;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand("copy");
                document.body.removeChild(ta);
                toast("Link copied", "success");
            });
    }
    function downloadBlob(filename, content, mime = "text/plain") {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([content], { type: mime }));
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
    }
    function csvFromAgg(agg) {
        const { labels, series } = agg;
        if (!labels || !series || !series.length) return "";
        const header = ["Label", ...series.map((s) => s.name)].join(",");
        const rows = labels.map((lab, i) =>
            [lab, ...series.map((s) => s.data[i] ?? "")].join(",")
        );
        return [header, ...rows].join("\n");
    }

    // Fullscreen
    function openFullscreen(node) {
        const host = document.getElementById("fs_host");
        host.innerHTML = "";
        host.appendChild(node);
        document.getElementById("fs_overlay").classList.remove("hidden");
    }
    function closeFullscreen() {
        const host = document.getElementById("fs_host");
        const chartCard = document.querySelector(
            '.chart-card[data-active="true"] .chart-canvas-host'
        );
        if (chartCard) {
            chartCard.appendChild(host.firstElementChild);
            const div = chartCard.querySelector('.plotly-host');
            if (div) Plotly.Plots.resize(div);
        }
        document.getElementById("fs_overlay").classList.add("hidden");
    }

    // Data modal
    function openDataModal(html) {
        const el = document.getElementById("data_table");
        el.innerHTML = html || "";
        document.getElementById("data_modal").classList.remove("hidden");
    }
    function closeDataModal() {
        document.getElementById("data_modal").classList.add("hidden");
    }

    // API
    async function aggLoad(params) {
        const qs = new URLSearchParams(params).toString();
        return fetchJSON("/api/aggregate?" + qs);
    }
    async function underlying(params) {
        const qs = new URLSearchParams(params).toString();
        return fetchJSON("/api/underlying?" + qs);
    }

    // Chart component
    function createChartCard(id, title, cfg) {
        const card = document.createElement("div");
        card.className = "glass-panel chart-card";
        card.dataset.chartId = id;
        card.innerHTML = `
    <div class="flex items-center justify-between">
      <div class="text-lg font-semibold">${title}</div>
      <div class="flex items-center gap-2 text-xs">
        <button class="pill pill-sub act-full">Fullscreen</button>
        <button class="pill pill-sub act-edit">Edit</button>
        <button class="pill pill-sub act-data">Data</button>
        <button class="pill pill-sub act-share">Share</button>
        <button class="pill pill-sub act-dl-img">PNG</button>
        <button class="pill pill-sub act-dl-csv">CSV</button>
      </div>
    </div>
    <div class="mt-2 grid grid-cols-1 lg:grid-cols-5 gap-3 text-sm opts hidden">
      <div>
        <label class="lbl">Group</label>
        <select class="inp opt-group">
          <option value="primary_risk_state">Primary Risk State</option>
          <option value="appetite_status">Appetite Status</option>
          <option value="line_of_business">Line of Business</option>
          <option value="renewal_or_new_business">Submission Type</option>
          <option value="construction_type">Construction Type</option>
        </select>
      </div>
      <div>
        <label class="lbl">Metric</label>
        <select class="inp opt-metric">
          <option value="count">Count</option>
          <option value="sum:total_premium">Sum Premium</option>
          <option value="sum:tiv">Sum TIV</option>
          <option value="avg:total_premium">Avg Premium</option>
        </select>
      </div>
      <div>
        <label class="lbl">Series By</label>
        <select class="inp opt-series">
          <option value="">(None)</option>
          <option value="appetite_status">Appetite Status</option>
          <option value="renewal_or_new_business">Submission Type</option>
        </select>
      </div>
      <div>
        <label class="lbl">Chart Type</label>
        <select class="inp opt-type">
          <option value="bar">Bar</option>
          <option value="line">Line</option>
          <option value="pie">Pie</option>
        </select>
      </div>
      <div class="flex items-end"><button class="btn btn-subtle act-apply">Apply</button></div>
    </div>
    <div class="mt-3 chart-canvas-host"><div class="plotly-host"></div></div>
  `;

        const plotDiv = card.querySelector(".plotly-host");
        const opts = {
            group: cfg.group || "primary_risk_state",
            metric: cfg.metric || "count",
            series_by: cfg.series_by || "",
            type: cfg.type || "bar",
            filters: cfg.filters || {},
        };

        // init selects
        card.querySelector(".opt-group").value = opts.group;
        card.querySelector(".opt-metric").value = opts.metric;
        card.querySelector(".opt-series").value = opts.series_by;
        card.querySelector(".opt-type").value = opts.type;


        let lastAgg;

        async function render() {
            const params = { group: opts.group, metric: opts.metric };
            if (opts.series_by) params.series_by = opts.series_by;
            Object.assign(params, opts.filters || {});
            const agg = await aggLoad(params);
            lastAgg = agg;
            const colors = ["#818cf8", "#22c55e", "#f43f5e", "#f59e0b", "#06b6d4", "#e879f9", "#a3e635"];
            const traces = agg.series.map((s, i) => {
                const base = { name: s.name, marker: { color: colors[i % colors.length] } };
                if (opts.type === "pie") {
                    return { ...base, type: "pie", labels: agg.labels, values: s.data };
                }
                return { ...base, type: opts.type, x: agg.labels, y: s.data };
            });
            const layout = {
                paper_bgcolor: "transparent",
                plot_bgcolor: "transparent",
                font: { color: "#e2e8f0" },
                margin: { t: 30, r: 10, b: 40, l: 40 },
            };
            if (opts.type !== "pie") {
                layout.xaxis = { gridcolor: "rgba(255,255,255,.08)" };
                layout.yaxis = { gridcolor: "rgba(255,255,255,.08)" };
                if (opts.type === "bar" && agg.series.length > 1) layout.barmode = "stack";
            }
            await Plotly.react(plotDiv, traces, layout, { displayModeBar: false, responsive: true });
            plotDiv.removeAllListeners?.("plotly_click");
            plotDiv.on("plotly_click", async (ev) => {
                if (!ev.points?.length) return;
                const p = ev.points[0];
                const i = p.pointIndex;
                const j = p.curveNumber;
                const label = agg.labels[i];
                const seriesName = agg.series[j]?.name;
                const params = {
                    group: opts.group,
                    label,
                    series_by: opts.series_by || "",
                    series_val: opts.series_by ? seriesName : "",
                };
                const raw = await underlying(params);
                const rows = raw.data || [];
                const header = Object.keys(rows[0] || {});
                const head =
                    "<thead><tr>" +
                    header.map((h) => `<th class=\"th\">${h}</th>`).join("") +
                    "</tr></thead>";
                const body =
                    "<tbody>" +
                    rows
                        .map(
                            (r) =>
                                '<tr class=\"tr\">' +
                                header
                                    .map((h) => `<td class=\"td\">${r[h] ?? ""}</td>`)
                                    .join("") +
                                "</tr>"
                        )
                        .join("") +
                    "</tbody>";
                window.__lastRawRows = rows;
                openDataModal(
                    `<div class=\\"overflow-x-auto glass-panel p-0\\"><table class=\\"w-full text-xs table-glass\\">${head}${body}</table></div>`
                );
            });
        }

        function toggleEdit() {
            card.querySelector(".opts").classList.toggle("hidden");
        }

        // Actions
        card.querySelector(".act-full").onclick = () => {
            document.querySelectorAll(".chart-card").forEach((c) => (c.dataset.active = "false"));
            card.dataset.active = "true";
            const node = card.querySelector(".chart-canvas-host");
            openFullscreen(node);
            const div = document.getElementById("fs_host").querySelector(".plotly-host");
            if (div) Plotly.Plots.resize(div);
        };
        card.querySelector(".act-edit").onclick = toggleEdit;
        card.querySelector(".act-apply").onclick = () => {
            opts.group = card.querySelector(".opt-group").value;
            opts.metric = card.querySelector(".opt-metric").value;
            opts.series_by = card.querySelector(".opt-series").value;
            opts.type = card.querySelector(".opt-type").value;
            render().catch((e) => toast("Failed to render: " + e.message, "error"));
        };
        card.querySelector(".act-data").onclick = () => {
            if (!lastAgg) {
                toast("Load chart first", "error");
                return;
            }
            const csv = csvFromAgg(lastAgg);
            const html = `<div class=\"glass-panel p-0 overflow-auto\"><pre class=\"p-4\">${csv.replaceAll("<","&lt;")}</pre></div>`;
            openDataModal(html);
        };
        card.querySelector(".act-share").onclick = () => {
            const state = encodeURIComponent(btoa(JSON.stringify(opts)));
            const url = location.origin + location.pathname + `?cfg_${id}=` + state;
            const mail = `mailto:?subject=Portfolio%20Insights&body=${encodeURIComponent(url)}`;
            copyToClipboard(url);
            window.open(mail, "_blank");
        };
        card.querySelector(".act-dl-img").onclick = async () => {
            try {
                const url = await Plotly.toImage(plotDiv, { format: "png" });
                downloadBlob(`${id}.png`, await (await fetch(url)).blob(), "image/png");
            } catch (e) {
                toast("Download failed", "error");
            }
        };
        card.querySelector(".act-dl-csv").onclick = () => {
            if (!lastAgg) {
                toast("No data", "error");
                return;
            }
            downloadBlob(`${id}.csv`, csvFromAgg(lastAgg), "text/csv");
        };

        // Initial render
        render().catch((e) =>
            toast("Failed to load chart: " + e.message, "error")
        );
        return card;
    }

    // Triage Chart with hardcoded data
    function createTriageChart() {
        const card = document.createElement("div");
        card.className = "glass-panel chart-card";
        card.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="text-lg font-semibold">Triage Dashboard</div>
                <div class="flex items-center gap-2 text-xs">
                    <button class="pill pill-sub act-full">Fullscreen</button>
                    <button class="pill pill-sub act-share">Share</button>
                    <button class="pill pill-sub act-dl-img">PNG</button>
                </div>
            </div>
            <div class="mt-3 chart-canvas-host">
                <div class="plotly-host" style="height: 500px;"></div>
            </div>
        `;

        const plotDiv = card.querySelector(".plotly-host");
        
        // Hardcoded sample data
        const sampleData = [
            {account_name: "Acme Corp", winnability: 85, tiv: 45000000, total_premium: 125000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "CA", construction_type: "Fire Resistive", loss_value: 25000},
            {account_name: "Beta Industries", winnability: 72, tiv: 32000000, total_premium: 98000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "TX", construction_type: "Masonry Non-Combustible", loss_value: 15000},
            {account_name: "Gamma Manufacturing", winnability: 45, tiv: 78000000, total_premium: 185000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "FL", construction_type: "Non-Combustible/Steel", loss_value: 55000},
            {account_name: "Delta Logistics", winnability: 91, tiv: 28000000, total_premium: 87000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "OH", construction_type: "Fire Resistive", loss_value: 8000},
            {account_name: "Epsilon Tech", winnability: 38, tiv: 125000000, total_premium: 275000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "NY", construction_type: "Joisted Masonry", loss_value: 95000},
            {account_name: "Zeta Retail", winnability: 67, tiv: 15000000, total_premium: 65000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "GA", construction_type: "Masonry Non-Combustible", loss_value: 12000},
            {account_name: "Eta Energy", winnability: 55, tiv: 89000000, total_premium: 210000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "PA", construction_type: "Fire Resistive", loss_value: 42000},
            {account_name: "Theta Holdings", winnability: 78, tiv: 67000000, total_premium: 155000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "CO", construction_type: "Non-Combustible/Steel", loss_value: 18000},
            {account_name: "Iota Systems", winnability: 42, tiv: 95000000, total_premium: 225000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "MD", construction_type: "Joisted Masonry", loss_value: 78000},
            {account_name: "Kappa Services", winnability: 88, tiv: 22000000, total_premium: 75000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "VA", construction_type: "Fire Resistive", loss_value: 5000},
            {account_name: "Lambda Corp", winnability: 31, tiv: 156000000, total_premium: 320000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "IL", construction_type: "Wood Frame", loss_value: 125000},
            {account_name: "Mu Enterprises", winnability: 73, tiv: 38000000, total_premium: 112000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "SC", construction_type: "Masonry Non-Combustible", loss_value: 22000},
            {account_name: "Nu Industries", winnability: 59, tiv: 71000000, total_premium: 168000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "NC", construction_type: "Fire Resistive", loss_value: 35000},
            {account_name: "Xi Manufacturing", winnability: 82, tiv: 43000000, total_premium: 118000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "UT", construction_type: "Non-Combustible/Steel", loss_value: 14000},
            {account_name: "Omicron Group", winnability: 48, tiv: 102000000, total_premium: 245000, line_of_business: "COMMERCIAL PROPERTY", primary_risk_state: "WA", construction_type: "Joisted Masonry", loss_value: 88000}
        ];

        // Calculate median TIV for horizontal guide
        const sortedTiv = sampleData.map(d => d.tiv).sort((a, b) => a - b);
        const medianTiv = sortedTiv[Math.floor(sortedTiv.length / 2)];

        // Color mapping for line of business
        const colorMap = {
            "COMMERCIAL PROPERTY": "#818cf8"
        };

        // Create scatter trace
        const trace = {
            x: sampleData.map(d => d.winnability),
            y: sampleData.map(d => d.tiv),
            mode: 'markers',
            type: 'scatter',
            marker: {
                size: sampleData.map(d => Math.sqrt(d.total_premium) / 15), // Scale bubble size
                color: sampleData.map(d => colorMap[d.line_of_business] || "#06b6d4"),
                opacity: 0.7,
                line: {
                    color: 'rgba(255,255,255,0.2)',
                    width: 1
                }
            },
            text: sampleData.map(d => {
                const lossRatio = ((d.loss_value / d.total_premium) * 100).toFixed(1);
                return `<b>${d.account_name}</b><br>` +
                       `State: ${d.primary_risk_state}<br>` +
                       `Construction: ${d.construction_type}<br>` +
                       `Premium: $${d.total_premium.toLocaleString()}<br>` +
                       `Loss Value: $${d.loss_value.toLocaleString()}<br>` +
                       `Loss Ratio: ${lossRatio}%`;
            }),
            hovertemplate: '%{text}<extra></extra>',
            name: 'Submissions'
        };

        const layout = {
            paper_bgcolor: "transparent",
            plot_bgcolor: "transparent",
            font: { color: "#e2e8f0" },
            margin: { t: 40, r: 40, b: 170, l: 80 },
            xaxis: {
                title: 'Winnability (%)',
                gridcolor: "rgba(255,255,255,.08)",
                range: [0, 100]
            },
            yaxis: {
                title: 'Total Insured Value ($)',
                gridcolor: "rgba(255,255,255,.08)",
                type: 'linear'
            },
            shapes: [
                // Vertical guide at winnability = 60
                {
                    type: 'line',
                    x0: 60,
                    x1: 60,
                    y0: 0,
                    y1: 1,
                    yref: 'paper',
                    line: {
                        color: '#f59e0b',
                        width: 2,
                        dash: 'dash'
                    }
                },
                // Horizontal guide at median TIV
                {
                    type: 'line',
                    x0: 0,
                    x1: 1,
                    xref: 'paper',
                    y0: medianTiv,
                    y1: medianTiv,
                    line: {
                        color: '#f59e0b',
                        width: 2,
                        dash: 'dash'
                    }
                }
            ],
            annotations: [
                {
                    x: 62,
                    y: 0.95,
                    yref: 'paper',
                    text: 'Winnability = 60%',
                    showarrow: false,
                    font: { color: '#f59e0b', size: 10 }
                },
                {
                    x: 0.02,
                    xref: 'paper',
                    y: medianTiv,
                    text: `Median TIV: $${(medianTiv/1000000).toFixed(1)}M`,
                    showarrow: false,
                    font: { color: '#f59e0b', size: 10 }
                }
            ]
        };

        async function render() {
            await Plotly.react(plotDiv, [trace], layout, { displayModeBar: false, responsive: true });
        }

        // Actions
        card.querySelector(".act-full").onclick = () => {
            document.querySelectorAll(".chart-card").forEach((c) => (c.dataset.active = "false"));
            card.dataset.active = "true";
            const node = card.querySelector(".chart-canvas-host");
            openFullscreen(node);
            setTimeout(() => {
                const div = document.getElementById("fs_host").querySelector(".plotly-host");
                if (div) Plotly.Plots.resize(div);
            }, 100);
        };
        
        card.querySelector(".act-share").onclick = () => {
            copyToClipboard(location.href);
            toast("Link copied", "success");
        };
        
        card.querySelector(".act-dl-img").onclick = async () => {
            try {
                const url = await Plotly.toImage(plotDiv, { format: "png" });
                downloadBlob("triage_chart.png", await (await fetch(url)).blob(), "image/png");
            } catch (e) {
                toast("Download failed", "error");
            }
        };

        // Initial render
        render().catch((e) => toast("Failed to load triage chart: " + e.message, "error"));
        return card;
    }

    // Intake & Aging Chart with hardcoded data
    function createIntakeAgingChart() {
        const card = document.createElement("div");
        card.className = "glass-panel chart-card mt-6";
        card.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="text-lg font-semibold">Intake & Aging</div>
                <div class="flex items-center gap-2 text-xs">
                    <button class="pill pill-sub act-full">Fullscreen</button>
                    <button class="pill pill-sub act-share">Share</button>
                    <button class="pill pill-sub act-dl-img">PNG</button>
                </div>
            </div>
            <div class="mt-3 chart-canvas-host">
                <div class="plotly-host" style="height: 400px;"></div>
            </div>
        `;

        const plotDiv = card.querySelector(".plotly-host");
        
        // Hardcoded weekly data with different winnability buckets
        const weeklyData = [
            // Week of Jan 1, 2024
            {week: "2024-01-01", winnability_0_40: 3, winnability_40_60: 8, winnability_60_80: 12, winnability_80_100: 5},
            // Week of Jan 8, 2024
            {week: "2024-01-08", winnability_0_40: 5, winnability_40_60: 6, winnability_60_80: 15, winnability_80_100: 8},
            // Week of Jan 15, 2024
            {week: "2024-01-15", winnability_0_40: 2, winnability_40_60: 9, winnability_60_80: 11, winnability_80_100: 6},
            // Week of Jan 22, 2024
            {week: "2024-01-22", winnability_0_40: 7, winnability_40_60: 12, winnability_60_80: 18, winnability_80_100: 9},
            // Week of Jan 29, 2024
            {week: "2024-01-29", winnability_0_40: 4, winnability_40_60: 10, winnability_60_80: 14, winnability_80_100: 11},
            // Week of Feb 5, 2024
            {week: "2024-02-05", winnability_0_40: 6, winnability_40_60: 7, winnability_60_80: 16, winnability_80_100: 7},
            // Week of Feb 12, 2024
            {week: "2024-02-12", winnability_0_40: 3, winnability_40_60: 11, winnability_60_80: 13, winnability_80_100: 10},
            // Week of Feb 19, 2024
            {week: "2024-02-19", winnability_0_40: 8, winnability_40_60: 9, winnability_60_80: 17, winnability_80_100: 12},
            // Week of Feb 26, 2024
            {week: "2024-02-26", winnability_0_40: 5, winnability_40_60: 13, winnability_60_80: 15, winnability_80_100: 8},
            // Week of Mar 4, 2024
            {week: "2024-03-04", winnability_0_40: 4, winnability_40_60: 8, winnability_60_80: 19, winnability_80_100: 14},
        ];

        // Create traces for each winnability bucket
        const traces = [
            {
                name: '0-40%',
                x: weeklyData.map(d => d.week),
                y: weeklyData.map(d => d.winnability_0_40),
                type: 'bar',
                marker: { color: '#ef4444' }, // Red for low winnability
                hovertemplate: 'Week: %{x}<br>Count: %{y}<br>Winnability: 0-40%<extra></extra>'
            },
            {
                name: '40-60%',
                x: weeklyData.map(d => d.week),
                y: weeklyData.map(d => d.winnability_40_60),
                type: 'bar',
                marker: { color: '#f59e0b' }, // Orange for medium-low winnability
                hovertemplate: 'Week: %{x}<br>Count: %{y}<br>Winnability: 40-60%<extra></extra>'
            },
            {
                name: '60-80%',
                x: weeklyData.map(d => d.week),
                y: weeklyData.map(d => d.winnability_60_80),
                type: 'bar',
                marker: { color: '#22c55e' }, // Green for medium-high winnability
                hovertemplate: 'Week: %{x}<br>Count: %{y}<br>Winnability: 60-80%<extra></extra>'
            },
            {
                name: '80-100%',
                x: weeklyData.map(d => d.week),
                y: weeklyData.map(d => d.winnability_80_100),
                type: 'bar',
                marker: { color: '#3b82f6' }, // Blue for high winnability
                hovertemplate: 'Week: %{x}<br>Count: %{y}<br>Winnability: 80-100%<extra></extra>'
            }
        ];

        const layout = {
            paper_bgcolor: "transparent",
            plot_bgcolor: "transparent",
            font: { color: "#e2e8f0" },
            margin: { t: 40, r: 40, b: 180, l: 60 },
            xaxis: {
                title: 'Week',
                gridcolor: "rgba(255,255,255,.08)",
                type: 'date'
            },
            yaxis: {
                title: 'Count of Accounts',
                gridcolor: "rgba(255,255,255,.08)"
            },
            barmode: 'stack',
            legend: {
                orientation: 'h',
                y: -0.2,
                x: 0.5,
                xanchor: 'center',
                font: { color: "#e2e8f0" }
            }
        };

        async function render() {
            await Plotly.react(plotDiv, traces, layout, { displayModeBar: false, responsive: true });
        }

        // Actions
        card.querySelector(".act-full").onclick = () => {
            document.querySelectorAll(".chart-card").forEach((c) => (c.dataset.active = "false"));
            card.dataset.active = "true";
            const node = card.querySelector(".chart-canvas-host");
            openFullscreen(node);
            setTimeout(() => {
                const div = document.getElementById("fs_host").querySelector(".plotly-host");
                if (div) Plotly.Plots.resize(div);
            }, 100);
        };
        
        card.querySelector(".act-share").onclick = () => {
            copyToClipboard(location.href);
            toast("Link copied", "success");
        };
        
        card.querySelector(".act-dl-img").onclick = async () => {
            try {
                const url = await Plotly.toImage(plotDiv, { format: "png" });
                downloadBlob("intake_aging_chart.png", await (await fetch(url)).blob(), "image/png");
            } catch (e) {
                toast("Download failed", "error");
            }
        };

        // Initial render
        render().catch((e) => toast("Failed to load intake & aging chart: " + e.message, "error"));
        return card;
    }

    function loadTabs() {
        const host = document.getElementById("tab_content");

        function section(tab) {
            host.innerHTML = "";
            if (tab === "overview") {
                host.appendChild(
                    createTriageChart()
                );
                host.appendChild(
                    createIntakeAgingChart()
                );
            }
        }

        const firstBtn = document.querySelector(".tabbtn:not([disabled])");
        (document.querySelectorAll(".tabbtn") || []).forEach((btn) => {
            btn.onclick = () => {
                if (btn.disabled) return;
                document
                    .querySelectorAll(".tabbtn")
                    .forEach((b) => b.classList.remove("pill-indigo"));
                btn.classList.add("pill-indigo");
                section(btn.dataset.tab);
            };
        });
        firstBtn?.click();
    }

    function paramCfg(key) {
        const url = new URL(location.href);
        const v = url.searchParams.get(key);
        if (!v) return null;
        try {
            return JSON.parse(atob(decodeURIComponent(v)));
        } catch {
            return null;
        }
    }

    window.addEventListener("DOMContentLoaded", loadTabs);

    // Download underlying raw table as CSV when available
    document.addEventListener("click", (e) => {
        if (e.target && e.target.id === "dl_raw_csv") {
            const rows = window.__lastRawRows || [];
            if (!rows.length) {
                toast("No data", "error");
                return;
            }
            const cols = Object.keys(rows[0]);
            const csv = [cols.join(",")]
                .concat(
                    rows.map((r) =>
                        cols.map((c) => JSON.stringify(r[c] ?? "")).join(",")
                    )
                )
                .join("\n");
            downloadBlob("underlying.csv", csv, "text/csv");
        }
    });
</script>


{% endblock %}
