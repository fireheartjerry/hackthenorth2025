<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>RiskOps Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="{{ url_for('static', filename='css/main.css') }}"
            rel="stylesheet"
        />
    </head>
    <body class="bg-slate-950 text-slate-100">
        <!-- Ambient background scene -->
        <div class="ambient-bg" aria-hidden="true"></div>

        <header class="navbar glass flex-shrink-0">
            <div
                class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between"
            >
                <div class="flex items-center gap-3">
                    <div class="logo">R</div>
                    <div class="text-xl font-bold tracking-tight">RiskOps</div>
                </div>
                <nav class="flex items-center gap-6 text-sm">
                    <a href="{{ url_for('home') }}" class="nav-link"
                        >Overview</a
                    >
                    <a href="{{ url_for('submissions') }}" class="nav-link"
                        >Submissions</a
                    >
                    <a href="{{ url_for('insights') }}" class="nav-link"
                        >Portfolio Insights</a
                    >
                    <!-- Global Mode Dropdown (advanced) -->
                    <div class="relative" id="global_mode_host">
                        <button id="global_mode_btn" class="chip hover-glow" aria-haspopup="true" aria-expanded="false">
                            <span class="opacity-80 mr-1">Mode:</span>
                            <span id="global_mode_label">‚Äî</span>
                            <span class="ml-1 opacity-70">‚ñæ</span>
                        </button>
                        <div id="global_mode_menu" class="absolute right-0 mt-2 w-[320px] glass dropdown-menu hidden shadow-xl" role="menu" aria-label="Select mode">
                            <div class="p-2 text-xs opacity-80">Choose underwriting mode</div>
                            <div id="global_mode_list" class="p-2 pt-0 space-y-2"></div>
                            <div class="p-2 border-t border-white/10 flex items-center justify-between gap-2">
                                <div class="text-xs opacity-80">Refine with Persona</div>
                                <button id="btn_persona_global" class="pill pill-sub hover-glow text-xs">Build Persona</button>
                            </div>
                        </div>
                    </div>

                    <!-- Vibe selector -->
                    <div class="relative" id="vibe_host">
                        <button id="vibe_btn" class="chip hover-glow" aria-haspopup="true" aria-expanded="false">
                            <span class="opacity-80 mr-1">Vibe:</span>
                            <span id="vibe_label">Aurora</span>
                            <span class="ml-1 opacity-70">‚ñæ</span>
                        </button>
                        <div id="vibe_menu" class="absolute right-0 mt-2 w-[280px] glass hidden shadow-xl" role="menu" aria-label="Select vibe">
                            <div class="p-2 text-xs opacity-80">Choose your vibe</div>
                            <div id="vibe_list" class="p-2 pt-0 grid grid-cols-5 gap-2"></div>
                            <div class="p-2 border-t border-white/10">
                                <label class="lbl">Saturation</label>
                                <input id="vibe_sat" type="range" min="100" max="180" value="120" class="w-full"/>
                            </div>
                        </div>
                    </div>

                    <!-- User name chip -->
                    <div class="relative" id="user_host">
                        <button id="user_btn" class="user-chip hover-glow" aria-haspopup="true" aria-expanded="false">
                            <span id="user_avatar" class="user-avatar">U</span>
                            <span id="user_greet" class="opacity-90">Hello</span>
                            <span class="ml-1 opacity-70">‚ñæ</span>
                        </button>
                        <div id="user_menu" class="absolute right-0 mt-2 w-[280px] glass hidden shadow-xl" role="menu" aria-label="User settings">
                            <div class="p-2">
                                <label class="lbl">Display name</label>
                                <input id="user_name" class="inp w-full" placeholder="Your name"/>
                                <button id="user_save" class="btn btn-subtle mt-3 w-full">Save</button>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </header>
        <main class="flex-grow mx-auto max-w-7xl px-4 py-8 overflow-y-auto">
            {% block content %}{% endblock %}
        </main>
        <div id="toasts" class="toasts"></div>
        <!-- Global Persona Modal (available on all pages) -->
        <div id="persona_modal" class="overlay hidden">
            <div class="overlay-inner max-w-2xl flex flex-col max-h-[calc(100vh-2rem)]">
                <div class="flex items-center justify-between mb-4 flex-shrink-0">
                    <div>
                        <h3 class="text-xl font-semibold">Build Your Risk Appetite</h3>
                        <p class="text-sm opacity-70 mt-1">Let's create a personalized underwriting strategy</p>
                    </div>
                    <button id="persona_close" class="pill pill-sub">‚úï</button>
                </div>

                <!-- Progress Indicator -->
                <div class="mb-6 flex-shrink-0">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium">Progress</span>
                        <span id="progress_text" class="text-xs opacity-70">Step 1 of 8</span>
                    </div>
                    <div class="w-full bg-white/10 rounded-full h-2">
                        <div id="progress_bar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full transition-all duration-500 ease-out" style="width: 12.5%"></div>
                    </div>
                </div>

                <!-- Step Container -->
                <div id="persona_steps" class="flex-grow overflow-y-auto mb-6 min-h-0">
                    
                    <!-- Step 1: Risk Posture -->
                    <div class="persona-step active" data-step="1">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-2xl">
                                üéØ
                            </div>
                            <h4 class="text-lg font-semibold mb-2">What's your risk appetite?</h4>
                            <p class="text-sm opacity-70">How conservative or aggressive should we be with underwriting decisions?</p>
                        </div>
                        <div class="space-y-4">
                            <div class="text-center">
                                <div class="flex justify-between text-xs opacity-60 mb-2">
                                    <span>Conservative</span>
                                    <span>Balanced</span>
                                    <span>Aggressive</span>
                                </div>
                                <input id="ans_aggr" type="range" min="1" max="5" value="3" class="w-full h-3 bg-white/10 rounded-lg appearance-none slider"/>
                                <div id="aggr_display" class="mt-3 text-center">
                                    <span class="text-lg font-semibold text-indigo-400">Balanced Approach</span>
                                    <p class="text-xs opacity-70 mt-1">Moderate risk tolerance with steady returns</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Primary Objective -->
                    <div class="persona-step" data-step="2">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-green-500 to-teal-600 rounded-full flex items-center justify-center text-2xl">
                                üìä
                            </div>
                            <h4 class="text-lg font-semibold mb-2">What's your primary goal?</h4>
                            <p class="text-sm opacity-70">Choose your main focus for this underwriting strategy</p>
                        </div>
                        <div class="grid gap-3">
                            <label class="objective-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                <input type="radio" name="objective" value="balance" checked class="sr-only"/>
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">‚öñÔ∏è</span>
                                    <div>
                                        <div class="font-semibold">Balanced Growth</div>
                                        <div class="text-xs opacity-70">Steady mix of premium and win rate</div>
                                    </div>
                                </div>
                            </label>
                            <label class="objective-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                <input type="radio" name="objective" value="expected_premium" class="sr-only"/>
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üí∞</span>
                                    <div>
                                        <div class="font-semibold">Premium Focus</div>
                                        <div class="text-xs opacity-70">Maximize expected premium income</div>
                                    </div>
                                </div>
                            </label>
                            <label class="objective-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                <input type="radio" name="objective" value="win_rate" class="sr-only"/>
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üèÜ</span>
                                    <div>
                                        <div class="font-semibold">Win Rate</div>
                                        <div class="text-xs opacity-70">Focus on closing more deals</div>
                                    </div>
                                </div>
                            </label>
                            <label class="objective-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                <input type="radio" name="objective" value="freshness" class="sr-only"/>
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üîÑ</span>
                                    <div>
                                        <div class="font-semibold">New Opportunities</div>
                                        <div class="text-xs opacity-70">Prioritize fresh submissions</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Step 3: Premium Range -->
                    <div class="persona-step" data-step="3">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-full flex items-center justify-center text-2xl">
                                üíµ
                            </div>
                            <h4 class="text-lg font-semibold mb-2">What premium range interests you?</h4>
                            <p class="text-sm opacity-70">Choose your sweet spot for deal size</p>
                        </div>
                        <div class="space-y-4">
                            <!-- Premium Range Presets -->
                            <div class="grid grid-cols-1 gap-3">
                                <label class="premium-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                    <input type="radio" name="premium_range" value="small" class="sr-only"/>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-green-500/20 rounded-full flex items-center justify-center">
                                                <span class="text-green-400 font-bold text-sm">S</span>
                                            </div>
                                            <div>
                                                <div class="font-semibold">Small Deals</div>
                                                <div class="text-xs opacity-70">$50K - $150K</div>
                                            </div>
                                        </div>
                                        <div class="text-right text-xs opacity-60">
                                            <div>Volume play</div>
                                            <div class="text-green-400">Fast turnaround</div>
                                        </div>
                                    </div>
                                </label>
                                <label class="premium-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                    <input type="radio" name="premium_range" value="medium" checked class="sr-only"/>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center">
                                                <span class="text-blue-400 font-bold text-sm">M</span>
                                            </div>
                                            <div>
                                                <div class="font-semibold">Mid-Market</div>
                                                <div class="text-xs opacity-70">$100K - $500K</div>
                                            </div>
                                        </div>
                                        <div class="text-right text-xs opacity-60">
                                            <div>Balanced approach</div>
                                            <div class="text-blue-400">Sweet spot</div>
                                        </div>
                                    </div>
                                </label>
                                <label class="premium-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                    <input type="radio" name="premium_range" value="large" class="sr-only"/>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-purple-500/20 rounded-full flex items-center justify-center">
                                                <span class="text-purple-400 font-bold text-sm">L</span>
                                            </div>
                                            <div>
                                                <div class="font-semibold">Enterprise</div>
                                                <div class="text-xs opacity-70">$500K - $2M</div>
                                            </div>
                                        </div>
                                        <div class="text-right text-xs opacity-60">
                                            <div>Premium focus</div>
                                            <div class="text-purple-400">High value</div>
                                        </div>
                                    </div>
                                </label>
                                <label class="premium-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                    <input type="radio" name="premium_range" value="custom" class="sr-only"/>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-orange-500/20 rounded-full flex items-center justify-center">
                                                <span class="text-orange-400 font-bold text-sm">?</span>
                                            </div>
                                            <div>
                                                <div class="font-semibold">Custom Range</div>
                                                <div class="text-xs opacity-70">Set your own limits</div>
                                            </div>
                                        </div>
                                        <div class="text-right text-xs opacity-60">
                                            <div>Flexible</div>
                                            <div class="text-orange-400">Tailored</div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- Custom Range Inputs (shown when custom is selected) -->
                            <div id="custom_premium_inputs" class="hidden mt-4 p-4 bg-white/5 rounded-lg">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="lbl mb-2 text-xs">Minimum</label>
                                        <input id="ans_prem_lo" type="number" class="inp w-full" placeholder="100,000" value="100000"/>
                                    </div>
                                    <div>
                                        <label class="lbl mb-2 text-xs">Maximum</label>
                                        <input id="ans_prem_hi" type="number" class="inp w-full" placeholder="1,500,000" value="1500000"/>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Smart Insights -->
                            <div id="premium_insight" class="mt-4 p-3 bg-indigo-500/10 rounded-lg border border-indigo-400/20">
                                <div class="flex items-start gap-2">
                                    <span class="text-indigo-400 text-sm">üí°</span>
                                    <div class="text-xs">
                                        <div class="font-medium text-indigo-400">Mid-market insight</div>
                                        <div class="opacity-80 mt-1">This range typically sees 65% win rates and offers good risk-return balance for commercial property.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Loss Tolerance -->
                    <div class="persona-step" data-step="4">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-red-500 to-pink-600 rounded-full flex items-center justify-center text-2xl">
                                ÔøΩ
                            </div>
                            <h4 class="text-lg font-semibold mb-2">How much risk can you handle?</h4>
                            <p class="text-sm opacity-70">Set your loss ratio comfort zone</p>
                        </div>
                        <div class="space-y-6">
                            <!-- Visual Risk Meter -->
                            <div class="relative">
                                <div class="flex justify-between text-xs opacity-60 mb-3">
                                    <span>üõ°Ô∏è Very Safe</span>
                                    <span>‚öñÔ∏è Balanced</span>
                                    <span>üéØ Aggressive</span>
                                </div>
                                <div class="relative">
                                    <div class="w-full h-4 bg-gradient-to-r from-green-500/30 via-yellow-500/30 to-red-500/30 rounded-full"></div>
                                    <input id="ans_lr" type="range" min="0.4" max="1.0" step="0.05" value="0.65" class="absolute inset-0 w-full h-4 bg-transparent appearance-none slider-overlay"/>
                                </div>
                                <div id="lr_display" class="mt-4 text-center">
                                    <span class="text-2xl font-bold text-yellow-400">65%</span>
                                    <p class="text-sm opacity-70 mt-1 font-medium">Balanced risk tolerance</p>
                                </div>
                            </div>
                            
                            <!-- Risk Context Cards -->
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div class="p-3 bg-green-500/10 rounded-lg border border-green-400/20 text-center">
                                    <div class="text-green-400 font-bold">40-50%</div>
                                    <div class="opacity-80">Conservative</div>
                                </div>
                                <div class="p-3 bg-yellow-500/10 rounded-lg border border-yellow-400/20 text-center">
                                    <div class="text-yellow-400 font-bold">55-70%</div>
                                    <div class="opacity-80">Industry Avg</div>
                                </div>
                                <div class="p-3 bg-red-500/10 rounded-lg border border-red-400/20 text-center">
                                    <div class="text-red-400 font-bold">75%+</div>
                                    <div class="opacity-80">High Risk</div>
                                </div>
                            </div>
                            
                            <!-- Dynamic Insight -->
                            <div id="lr_insight" class="p-3 bg-yellow-500/10 rounded-lg border border-yellow-400/20">
                                <div class="flex items-start gap-2">
                                    <span class="text-yellow-400 text-sm">‚öñÔ∏è</span>
                                    <div class="text-xs">
                                        <div class="font-medium text-yellow-400">Balanced approach</div>
                                        <div class="opacity-80 mt-1">This loss ratio target aligns well with industry standards while maintaining healthy profitability.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: TIV Ceiling -->
                    <div class="persona-step" data-step="5">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-full flex items-center justify-center text-2xl">
                                üè¢
                            </div>
                            <h4 class="text-lg font-semibold mb-2">What property sizes will you consider?</h4>
                            <p class="text-sm opacity-70">Choose your comfort level for property values</p>
                        </div>
                        <div class="space-y-4">
                            <!-- Visual Property Size Options -->
                            <div class="grid grid-cols-1 gap-3">
                                <label class="tiv-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                    <input type="radio" name="tiv_size" value="small_business" class="sr-only"/>
                                    <div class="flex items-center gap-4">
                                        <div class="flex-shrink-0">
                                            <div class="w-12 h-8 bg-gradient-to-t from-green-500 to-green-300 rounded" style="background: linear-gradient(to top, #10b981 20%, #34d399 100%)"></div>
                                        </div>
                                        <div class="flex-grow">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="font-semibold">Small Business Properties</div>
                                                    <div class="text-xs opacity-70">Strip malls, small warehouses</div>
                                                </div>
                                                <div class="text-right text-xs opacity-60">
                                                    <div class="font-medium">Up to $25M</div>
                                                    <div class="text-green-400">Lower risk</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                                
                                <label class="tiv-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                    <input type="radio" name="tiv_size" value="mid_market" class="sr-only"/>
                                    <div class="flex items-center gap-4">
                                        <div class="flex-shrink-0">
                                            <div class="w-12 h-12 bg-gradient-to-t from-blue-500 to-blue-300 rounded" style="background: linear-gradient(to top, #3b82f6 20%, #60a5fa 100%)"></div>
                                        </div>
                                        <div class="flex-grow">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="font-semibold">Mid-Market Properties</div>
                                                    <div class="text-xs opacity-70">Office buildings, shopping centers</div>
                                                </div>
                                                <div class="text-right text-xs opacity-60">
                                                    <div class="font-medium">$25M - $100M</div>
                                                    <div class="text-blue-400">Balanced</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </label>

                                <label class="tiv-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                    <input type="radio" name="tiv_size" value="large_commercial" checked class="sr-only"/>
                                    <div class="flex items-center gap-4">
                                        <div class="flex-shrink-0">
                                            <div class="w-12 h-16 bg-gradient-to-t from-purple-500 to-purple-300 rounded" style="background: linear-gradient(to top, #8b5cf6 20%, #a78bfa 100%)"></div>
                                        </div>
                                        <div class="flex-grow">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="font-semibold">Large Commercial</div>
                                                    <div class="text-xs opacity-70">Corporate campuses, major facilities</div>
                                                </div>
                                                <div class="text-right text-xs opacity-60">
                                                    <div class="font-medium">$100M - $250M</div>
                                                    <div class="text-purple-400">Higher value</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </label>

                                <label class="tiv-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all">
                                    <input type="radio" name="tiv_size" value="jumbo" class="sr-only"/>
                                    <div class="flex items-center gap-4">
                                        <div class="flex-shrink-0">
                                            <div class="w-12 h-20 bg-gradient-to-t from-orange-500 to-orange-300 rounded" style="background: linear-gradient(to top, #f97316 20%, #fb923c 100%); box-shadow: 0 4px 12px rgba(249,115,22,0.3)"></div>
                                        </div>
                                        <div class="flex-grow">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="font-semibold">Trophy Assets</div>
                                                    <div class="text-xs opacity-70">Skyscrapers, mega developments</div>
                                                </div>
                                                <div class="text-right text-xs opacity-60">
                                                    <div class="font-medium">$250M+</div>
                                                    <div class="text-orange-400">Premium risk</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- Hidden input for actual TIV value -->
                            <input id="ans_tiv" type="hidden" value="150000000"/>
                            
                            <!-- Smart Context -->
                            <div id="tiv_insight" class="mt-4 p-3 bg-purple-500/10 rounded-lg border border-purple-400/20">
                                <div class="flex items-start gap-2">
                                    <span class="text-purple-400 text-sm">üéØ</span>
                                    <div class="text-xs">
                                        <div class="font-medium text-purple-400">Large commercial sweet spot</div>
                                        <div class="opacity-80 mt-1">Properties in this range offer substantial premiums while remaining manageable from a risk perspective.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 6: Business Preferences -->
                    <div class="persona-step" data-step="6">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center text-2xl">
                                üéØ
                            </div>
                            <h4 class="text-lg font-semibold mb-2">Business preferences</h4>
                            <p class="text-sm opacity-70">Fine-tune your underwriting focus</p>
                        </div>
                        <div class="space-y-6">
                            <label class="preference-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all flex items-center gap-4">
                                <input id="ans_new_only" type="checkbox" checked class="w-5 h-5"/>
                                <div>
                                    <div class="font-semibold">New Business Only</div>
                                    <div class="text-xs opacity-70">Focus on fresh opportunities, skip renewals</div>
                                </div>
                            </label>
                            <label class="preference-card border border-white/20 rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition-all flex items-center gap-4">
                                <input id="ans_good_con" type="checkbox" class="w-5 h-5"/>
                                <div>
                                    <div class="font-semibold">Prefer Quality Construction</div>
                                    <div class="text-xs opacity-70">Prioritize fire-resistant and non-combustible buildings</div>
                                </div>
                            </label>
                            <div>
                                <label class="lbl mb-2">Construction Preferences (optional)</label>
                                <input id="ans_con_list" class="inp w-full" placeholder="e.g. Fire Resistive, Masonry Non-Combustible"/>
                                <div class="text-xs opacity-50 mt-1">Comma-separated list of preferred construction types</div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 7: Final Comments -->
                    <div class="persona-step" data-step="7">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center text-2xl">
                                üí≠
                            </div>
                            <h4 class="text-lg font-semibold mb-2">Any special instructions?</h4>
                            <p class="text-sm opacity-70">Add specific guidance for your underwriting strategy</p>
                        </div>
                        <div class="space-y-4">
                            <textarea id="ans_comments" class="inp w-full h-32 resize-none" placeholder="e.g. Focus on West Coast opportunities but watch for earthquake exposure. Prioritize buildings with modern fire safety systems..."></textarea>
                            <div class="text-xs opacity-50">Optional: Provide any additional context or specific requirements</div>
                        </div>
                    </div>

                    <!-- Step 8: Summary & Preview -->
                    <div class="persona-step" data-step="8">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-2xl">
                                üéØ
                            </div>
                            <h4 class="text-lg font-semibold mb-2">Your Risk Appetite Profile</h4>
                            <p class="text-sm opacity-70">Review your preferences before we build your custom strategy</p>
                        </div>
                        <div class="space-y-4">
                            <!-- Profile Summary Cards -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 bg-white/5 rounded-lg border border-white/10">
                                    <div class="text-xs opacity-60 mb-1">Risk Approach</div>
                                    <div id="summary_risk" class="font-semibold text-indigo-400">Balanced Approach</div>
                                </div>
                                <div class="p-4 bg-white/5 rounded-lg border border-white/10">
                                    <div class="text-xs opacity-60 mb-1">Primary Goal</div>
                                    <div id="summary_goal" class="font-semibold text-green-400">Balanced Growth</div>
                                </div>
                                <div class="p-4 bg-white/5 rounded-lg border border-white/10">
                                    <div class="text-xs opacity-60 mb-1">Premium Focus</div>
                                    <div id="summary_premium" class="font-semibold text-yellow-400">Mid-Market</div>
                                </div>
                                <div class="p-4 bg-white/5 rounded-lg border border-white/10">
                                    <div class="text-xs opacity-60 mb-1">Property Size</div>
                                    <div id="summary_property" class="font-semibold text-blue-400">Large Commercial</div>
                                </div>
                            </div>
                            
                            <!-- Expected Impact -->
                            <div class="p-4 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 rounded-lg border border-indigo-400/20">
                                <div class="text-center mb-3">
                                    <div class="text-sm font-medium text-indigo-400">Expected Portfolio Impact</div>
                                </div>
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <div class="text-lg font-bold text-green-400">~72%</div>
                                        <div class="text-xs opacity-70">Est. Win Rate</div>
                                    </div>
                                    <div>
                                        <div class="text-lg font-bold text-blue-400">~$385K</div>
                                        <div class="text-xs opacity-70">Avg. Premium</div>
                                    </div>
                                    <div>
                                        <div class="text-lg font-bold text-purple-400">~1.3x</div>
                                        <div class="text-xs opacity-70">Risk Multiple</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Enhancement Preview -->
                            <div class="p-4 bg-gradient-to-r from-pink-500/10 to-orange-500/10 rounded-lg border border-pink-400/20">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-lg">ü§ñ</span>
                                    <div class="text-sm font-medium text-pink-400">AI Enhancement Available</div>
                                </div>
                                <div class="text-xs opacity-80">Our AI can analyze market data and suggest additional optimizations based on your preferences.</div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Navigation -->
                <div class="flex items-center justify-between flex-shrink-0">
                    <button id="btn_prev" class="btn btn-subtle" disabled>‚Üê Previous</button>
                    <div class="flex gap-2">
                        <button id="persona_seed" class="btn-subtle btn hidden">Seed Only</button>
                        <button id="btn_next" class="btn">Next ‚Üí</button>
                        <button id="persona_submit" class="btn hidden">üöÄ Build with AI</button>
                    </div>
                </div>
                
                <div id="persona_status" class="text-xs opacity-60 mt-2 text-center flex-shrink-0"></div>
            </div>
        </div>

        <script src="{{ url_for('static', filename='js/app.js') }}"></script>
        <script>
            // Global mode helpers
            function getActiveMode(){ return localStorage.getItem('ACTIVE_MODE') || 'balanced_growth'; }
            function setActiveMode(m){ localStorage.setItem('ACTIVE_MODE', m); }
            function prettyMode(name){ const s = String(name||''); return s.replace(/_/g,' ').replace(/\b\w/g, c=>c.toUpperCase()); }

            // Build advanced dropdown
            const MODE_DESCRIPTIONS = {
                unicorn_hunting: 'Ultra-selective, high-value, new business',
                balanced_growth: 'Portfolio-friendly balance of value and risk',
                loose_fits: 'Broad discovery; keep doors open',
                turnaround_bets: 'Smaller tickets; speed and tolerance',
                custom: 'Refined from Persona builder',
            };

            async function populateGlobalModes(){
                try{
                    const j = await fetchJSON('/api/modes');
                    const modes = (j?.modes || []).filter(Boolean);
                    const list = document.getElementById('global_mode_list');
                    if(!list) return;
                    const active = getActiveMode();
                    if (!modes.length) {
                        list.innerHTML = '<div class="p-2 text-xs opacity-70">No modes available ‚Äî use Persona to create one</div>';
                        document.getElementById('global_mode_label').textContent = prettyMode(active);
                        return;
                    }
                    list.innerHTML = modes.map(m => {
                        const desc = MODE_DESCRIPTIONS[m] || 'Preset';
                        return `
                        <button class="w-full text-left block p-2 rounded-lg border border-white/10 hover:border-indigo-400/50 hover:bg-white/5"
                                data-mode="${m}" role="menuitem">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold">${prettyMode(m)}</div>
                                    <div class="text-xs opacity-80">${desc}</div>
                                </div>
                                ${m===active?'<span class="chip">Active</span>':''}
                            </div>
                        </button>`;
                    }).join('');
                    document.getElementById('global_mode_label').textContent = prettyMode(active);
                    list.querySelectorAll('[data-mode]').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const sel = btn.getAttribute('data-mode');
                            setActiveMode(sel);
                            document.getElementById('global_mode_label').textContent = prettyMode(sel);
                            closeGlobalMenu();
                            // Sync page-local selects if present
                            try { const hm = document.getElementById('home_mode'); if (hm) { hm.value = sel; hm.dispatchEvent(new Event('change')); } } catch{}
                            try { const fm = document.getElementById('f_mode'); if (fm) { fm.value = sel; document.getElementById('btn_apply')?.click(); } } catch{}
                        });
                    });
                } catch(e){ console.warn('Failed to load modes', e); }
            }

            function addMenuBackdrop(){
                if (document.getElementById('global_mode_backdrop')) return;
                const d = document.createElement('div');
                d.id = 'global_mode_backdrop';
                d.className = 'menu-backdrop';
                d.addEventListener('click', closeGlobalMenu);
                document.body.appendChild(d);
            }
            function removeMenuBackdrop(){
                const d = document.getElementById('global_mode_backdrop');
                if (d && d.parentNode) d.parentNode.removeChild(d);
            }
            function toggleGlobalMenu(){
                const m = document.getElementById('global_mode_menu');
                const isHidden = m.classList.contains('hidden');
                if (isHidden) {
                    m.classList.remove('hidden');
                    requestAnimationFrame(()=> m.classList.add('open'));
                } else {
                    m.classList.remove('open');
                    setTimeout(()=> m.classList.add('hidden'), 130);
                    removeMenuBackdrop();
                }
                document.getElementById('global_mode_btn').setAttribute('aria-expanded', String(isHidden));
            }
            function closeGlobalMenu(){
                const m = document.getElementById('global_mode_menu');
                if (!m) return;
                m.classList.remove('open');
                setTimeout(()=> m.classList.add('hidden'), 130);
                document.getElementById('global_mode_btn').setAttribute('aria-expanded', 'false');
                removeMenuBackdrop();
            }

            // Wire header controls
            (function initGlobalModeUI(){
                const btn = document.getElementById('global_mode_btn');
                const menu = document.getElementById('global_mode_menu');
                if(btn){
                    btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleGlobalMenu(); });
                }
                document.addEventListener('click', (e)=>{
                    if (!menu?.classList?.contains('hidden')) {
                        const host = document.getElementById('global_mode_host');
                        if (host && !host.contains(e.target)) closeGlobalMenu();
                    }
                });
                window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeGlobalMenu(); });
                window.addEventListener('scroll', ()=> closeGlobalMenu(), { passive: true });
                window.addEventListener('storage', (e)=>{
                    if (e.key === 'ACTIVE_MODE') {
                        document.getElementById('global_mode_label').textContent = prettyMode(getActiveMode());
                        populateGlobalModes();
                    }
                });
                // Persona open/close from header (use onclick to avoid double-bind)
                const _openPersona = () => { document.getElementById('persona_modal')?.classList?.remove('hidden'); initPersonaFlow(); closeGlobalMenu(); };
                const _closePersona = () => { document.getElementById('persona_modal')?.classList?.add('hidden'); };
                const _btnPersona = document.getElementById('btn_persona_global'); if (_btnPersona) _btnPersona.onclick = _openPersona;
                const _btnPersonaClose = document.getElementById('persona_close'); if (_btnPersonaClose) _btnPersonaClose.onclick = _closePersona;

                // Persona Step Management
                let currentStep = 1;
                const totalSteps = 8;

                function initPersonaFlow() {
                    currentStep = 1;
                    updateProgressBar();
                    showStep(1);
                    updateNavigation();
                    bindSliderUpdates();
                    bindFormUpdates();
                }

                function showStep(step) {
                    // Hide all steps
                    document.querySelectorAll('.persona-step').forEach(s => s.classList.remove('active'));
                    // Show current step
                    const currentStepEl = document.querySelector(`[data-step="${step}"]`);
                    if (currentStepEl) {
                        currentStepEl.classList.add('active');
                        // Add entrance animation
                        currentStepEl.style.opacity = '0';
                        currentStepEl.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            currentStepEl.style.transition = 'all 0.3s ease-out';
                            currentStepEl.style.opacity = '1';
                            currentStepEl.style.transform = 'translateY(0)';
                        }, 50);
                    }
                }

                function updateProgressBar() {
                    const progress = (currentStep / totalSteps) * 100;
                    document.getElementById('progress_bar').style.width = `${progress}%`;
                    document.getElementById('progress_text').textContent = `Step ${currentStep} of ${totalSteps}`;
                }

                function updateNavigation() {
                    const prevBtn = document.getElementById('btn_prev');
                    const nextBtn = document.getElementById('btn_next');
                    const seedBtn = document.getElementById('persona_seed');
                    const submitBtn = document.getElementById('persona_submit');

                    prevBtn.disabled = currentStep === 1;
                    
                    if (currentStep === totalSteps) {
                        nextBtn.classList.add('hidden');
                        seedBtn.classList.remove('hidden');
                        submitBtn.classList.remove('hidden');
                        // Update button text for final step
                        seedBtn.textContent = 'Quick Build';
                        submitBtn.innerHTML = 'üöÄ Build with AI';
                        // Update summary
                        updateSummaryStep();
                    } else {
                        nextBtn.classList.remove('hidden');
                        seedBtn.classList.add('hidden');
                        submitBtn.classList.add('hidden');
                    }
                }

                function bindSliderUpdates() {
                    // Risk posture slider
                    const aggrSlider = document.getElementById('ans_aggr');
                    const aggrDisplay = document.getElementById('aggr_display');
                    const aggrLabels = ['Very Conservative', 'Conservative', 'Balanced Approach', 'Aggressive', 'Very Aggressive'];
                    const aggrDescs = [
                        'Minimal risk, steady returns',
                        'Low risk, stable growth',
                        'Moderate risk tolerance with steady returns',
                        'Higher risk for better returns',
                        'Maximum risk, maximum opportunity'
                    ];
                    aggrSlider?.addEventListener('input', () => {
                        const val = parseInt(aggrSlider.value) - 1;
                        aggrDisplay.innerHTML = `
                            <span class="text-lg font-semibold text-indigo-400">${aggrLabels[val]}</span>
                            <p class="text-xs opacity-70 mt-1">${aggrDescs[val]}</p>
                        `;
                    });

                    // Loss ratio slider
                    const lrSlider = document.getElementById('ans_lr');
                    const lrDisplay = document.getElementById('lr_display');
                    lrSlider?.addEventListener('input', () => {
                        const val = parseFloat(lrSlider.value);
                        const pct = Math.round(val * 100);
                        let desc = 'Balanced risk tolerance';
                        if (val <= 0.5) desc = 'Very conservative approach';
                        else if (val <= 0.6) desc = 'Conservative approach';
                        else if (val <= 0.75) desc = 'Balanced risk tolerance';
                        else if (val <= 0.85) desc = 'Aggressive approach';
                        else desc = 'Very aggressive approach';
                        
                        lrDisplay.innerHTML = `
                            <span class="text-2xl font-bold text-yellow-400">${pct}%</span>
                            <p class="text-xs opacity-70 mt-1">${desc}</p>
                        `;
                    });
                }

                function bindFormUpdates() {
                    // Objective radio buttons - Set initial state
                    const checkedObjective = document.querySelector('input[name="objective"]:checked');
                    if (checkedObjective) {
                        const checkedCard = checkedObjective.closest('.objective-card');
                        checkedCard.classList.remove('border-white/20');
                        checkedCard.classList.add('border-indigo-400', 'bg-indigo-400/10');
                    }
                    
                    document.querySelectorAll('input[name="objective"]').forEach(radio => {
                        radio.addEventListener('change', () => {
                            document.querySelectorAll('.objective-card').forEach(card => {
                                card.classList.remove('border-indigo-400', 'bg-indigo-400/10');
                                card.classList.add('border-white/20');
                            });
                            const checkedCard = document.querySelector('input[name="objective"]:checked').closest('.objective-card');
                            checkedCard.classList.remove('border-white/20');
                            checkedCard.classList.add('border-indigo-400', 'bg-indigo-400/10');
                        });
                    });

                    // Premium range cards
                    const checkedPremium = document.querySelector('input[name="premium_range"]:checked');
                    if (checkedPremium) {
                        const checkedCard = checkedPremium.closest('.premium-card');
                        checkedCard.classList.remove('border-white/20');
                        checkedCard.classList.add('border-indigo-400', 'bg-indigo-400/10');
                        updatePremiumInsight(checkedPremium.value);
                    }
                    
                    document.querySelectorAll('input[name="premium_range"]').forEach(radio => {
                        radio.addEventListener('change', () => {
                            document.querySelectorAll('.premium-card').forEach(card => {
                                card.classList.remove('border-indigo-400', 'bg-indigo-400/10');
                                card.classList.add('border-white/20');
                            });
                            const checkedCard = document.querySelector('input[name="premium_range"]:checked').closest('.premium-card');
                            checkedCard.classList.remove('border-white/20');
                            checkedCard.classList.add('border-indigo-400', 'bg-indigo-400/10');
                            
                            // Show/hide custom inputs
                            const customInputs = document.getElementById('custom_premium_inputs');
                            if (radio.value === 'custom') {
                                customInputs.classList.remove('hidden');
                            } else {
                                customInputs.classList.add('hidden');
                                // Set values based on selection
                                setPremiumValues(radio.value);
                            }
                            updatePremiumInsight(radio.value);
                        });
                    });

                    // TIV size cards
                    const checkedTiv = document.querySelector('input[name="tiv_size"]:checked');
                    if (checkedTiv) {
                        const checkedCard = checkedTiv.closest('.tiv-card');
                        checkedCard.classList.remove('border-white/20');
                        checkedCard.classList.add('border-indigo-400', 'bg-indigo-400/10');
                        setTivValue(checkedTiv.value);
                        updateTivInsight(checkedTiv.value);
                    }
                    
                    document.querySelectorAll('input[name="tiv_size"]').forEach(radio => {
                        radio.addEventListener('change', () => {
                            document.querySelectorAll('.tiv-card').forEach(card => {
                                card.classList.remove('border-indigo-400', 'bg-indigo-400/10');
                                card.classList.add('border-white/20');
                            });
                            const checkedCard = document.querySelector('input[name="tiv_size"]:checked').closest('.tiv-card');
                            checkedCard.classList.remove('border-white/20');
                            checkedCard.classList.add('border-indigo-400', 'bg-indigo-400/10');
                            setTivValue(radio.value);
                            updateTivInsight(radio.value);
                        });
                    });

                    // Set initial checkbox states for preferences
                    const newOnlyCheckbox = document.getElementById('ans_new_only');
                    const goodConCheckbox = document.getElementById('ans_good_con');
                    
                    // Set initial styling for checked checkboxes
                    if (newOnlyCheckbox.checked) {
                        const card = newOnlyCheckbox.closest('.preference-card');
                        card.classList.add('border-indigo-400', 'bg-indigo-400/10');
                        card.classList.remove('border-white/20');
                    }

                    // Premium range updates for custom inputs
                    const premLoInput = document.getElementById('ans_prem_lo');
                    const premHiInput = document.getElementById('ans_prem_hi');

                    // Preference checkboxes styling
                    document.querySelectorAll('.preference-card input[type="checkbox"]').forEach(cb => {
                        cb.addEventListener('change', () => {
                            const card = cb.closest('.preference-card');
                            if (cb.checked) {
                                card.classList.add('border-indigo-400', 'bg-indigo-400/10');
                                card.classList.remove('border-white/20');
                            } else {
                                card.classList.remove('border-indigo-400', 'bg-indigo-400/10');
                                card.classList.add('border-white/20');
                            }
                        });
                    });
                }

                function setPremiumValues(range) {
                    const ranges = {
                        small: {min: 50000, max: 150000},
                        medium: {min: 100000, max: 500000},
                        large: {min: 500000, max: 2000000}
                    };
                    if (ranges[range]) {
                        document.getElementById('ans_prem_lo').value = ranges[range].min;
                        document.getElementById('ans_prem_hi').value = ranges[range].max;
                    }
                }

                function setTivValue(size) {
                    const values = {
                        small_business: 25000000,
                        mid_market: 100000000,
                        large_commercial: 250000000,
                        jumbo: 500000000
                    };
                    if (values[size]) {
                        document.getElementById('ans_tiv').value = values[size];
                    }
                }

                function updatePremiumInsight(range) {
                    const insights = {
                        small: {color: 'green', icon: 'üí°', title: 'Small deal insight', text: 'Fast processing with 75% win rates. Great for building pipeline volume.'},
                        medium: {color: 'indigo', icon: 'üí°', title: 'Mid-market insight', text: 'This range typically sees 65% win rates and offers good risk-return balance for commercial property.'},
                        large: {color: 'purple', icon: 'üí°', title: 'Enterprise insight', text: 'Higher margins but longer sales cycles. Win rates around 55% due to increased competition.'},
                        custom: {color: 'orange', icon: 'üéØ', title: 'Custom range', text: 'Tailored to your specific market focus. Make sure the range aligns with your risk appetite.'}
                    };
                    
                    const insight = insights[range];
                    if (insight) {
                        const insightEl = document.getElementById('premium_insight');
                        insightEl.className = `mt-4 p-3 bg-${insight.color}-500/10 rounded-lg border border-${insight.color}-400/20`;
                        insightEl.innerHTML = `
                            <div class="flex items-start gap-2">
                                <span class="text-${insight.color}-400 text-sm">${insight.icon}</span>
                                <div class="text-xs">
                                    <div class="font-medium text-${insight.color}-400">${insight.title}</div>
                                    <div class="opacity-80 mt-1">${insight.text}</div>
                                </div>
                            </div>
                        `;
                    }
                }

                function updateTivInsight(size) {
                    const insights = {
                        small_business: {color: 'green', icon: 'üõ°Ô∏è', title: 'Small business sweet spot', text: 'Lower risk profile with predictable loss patterns. Excellent for stable portfolio growth.'},
                        mid_market: {color: 'blue', icon: '‚öñÔ∏è', title: 'Mid-market balance', text: 'Good balance of premium size and manageable risk. Popular choice for diversified portfolios.'},
                        large_commercial: {color: 'purple', icon: 'üéØ', title: 'Large commercial sweet spot', text: 'Properties in this range offer substantial premiums while remaining manageable from a risk perspective.'},
                        jumbo: {color: 'orange', icon: 'üëë', title: 'Trophy asset territory', text: 'Premium opportunities with heightened due diligence requirements. Requires specialized expertise.'}
                    };
                    
                    const insight = insights[size];
                    if (insight) {
                        const insightEl = document.getElementById('tiv_insight');
                        insightEl.className = `mt-4 p-3 bg-${insight.color}-500/10 rounded-lg border border-${insight.color}-400/20`;
                        insightEl.innerHTML = `
                            <div class="flex items-start gap-2">
                                <span class="text-${insight.color}-400 text-sm">${insight.icon}</span>
                                <div class="text-xs">
                                    <div class="font-medium text-${insight.color}-400">${insight.title}</div>
                                    <div class="opacity-80 mt-1">${insight.text}</div>
                                </div>
                            </div>
                        `;
                    }
                }

                function updateSummaryStep() {
                    // Update summary cards
                    const riskLevel = parseInt(document.getElementById('ans_aggr').value);
                    const riskLabels = ['Very Conservative', 'Conservative', 'Balanced Approach', 'Aggressive', 'Very Aggressive'];
                    document.getElementById('summary_risk').textContent = riskLabels[riskLevel - 1];
                    
                    const objective = document.querySelector('input[name="objective"]:checked')?.value || 'balance';
                    const objLabels = {balance: 'Balanced Growth', expected_premium: 'Premium Focus', win_rate: 'Win Rate', freshness: 'New Opportunities'};
                    document.getElementById('summary_goal').textContent = objLabels[objective];
                    
                    const premium = document.querySelector('input[name="premium_range"]:checked')?.value || 'medium';
                    const premLabels = {small: 'Small Deals', medium: 'Mid-Market', large: 'Enterprise', custom: 'Custom Range'};
                    document.getElementById('summary_premium').textContent = premLabels[premium];
                    
                    const tivSize = document.querySelector('input[name="tiv_size"]:checked')?.value || 'large_commercial';
                    const tivLabels = {small_business: 'Small Business', mid_market: 'Mid-Market', large_commercial: 'Large Commercial', jumbo: 'Trophy Assets'};
                    document.getElementById('summary_property').textContent = tivLabels[tivSize];
                }

                // Navigation handlers
                document.getElementById('btn_prev')?.addEventListener('click', () => {
                    if (currentStep > 1) {
                        currentStep--;
                        updateProgressBar();
                        showStep(currentStep);
                        updateNavigation();
                    }
                });

                document.getElementById('btn_next')?.addEventListener('click', () => {
                    if (validateCurrentStep()) {
                        if (currentStep < totalSteps) {
                            currentStep++;
                            updateProgressBar();
                            showStep(currentStep);
                            updateNavigation();
                        }
                    }
                });

                function validateCurrentStep() {
                    // Basic validation for each step
                    switch(currentStep) {
                        case 3: // Premium range
                            const lo = parseInt(document.getElementById('ans_prem_lo').value) || 0;
                            const hi = parseInt(document.getElementById('ans_prem_hi').value) || 0;
                            if (lo >= hi) {
                                window.toast?.('Maximum premium must be higher than minimum', 'error');
                                return false;
                            }
                            break;
                    }
                    return true;
                }

                // Persona actions (seed/propose) - updated to work with new flow
                function gatherAnswers(){
                    const con = (document.getElementById('ans_con_list').value || '').split(',').map(s=>s.trim()).filter(Boolean);
                    const objective = document.querySelector('input[name="objective"]:checked')?.value || 'balance';
                    
                    // Get premium values based on selection
                    const premiumRange = document.querySelector('input[name="premium_range"]:checked')?.value || 'medium';
                    let premiumLo, premiumHi;
                    if (premiumRange === 'custom') {
                        premiumLo = Number(document.getElementById('ans_prem_lo').value || 100000);
                        premiumHi = Number(document.getElementById('ans_prem_hi').value || 1500000);
                    } else {
                        const ranges = {
                            small: {min: 50000, max: 150000},
                            medium: {min: 100000, max: 500000},
                            large: {min: 500000, max: 2000000}
                        };
                        premiumLo = ranges[premiumRange]?.min || 100000;
                        premiumHi = ranges[premiumRange]?.max || 1500000;
                    }
                    
                    return {
                        aggressiveness: Number(document.getElementById('ans_aggr').value || 3),
                        objective: objective,
                        premium_lo: premiumLo,
                        premium_hi: premiumHi,
                        max_lr: Number(document.getElementById('ans_lr').value || 0.65),
                        tiv_max: Number(document.getElementById('ans_tiv').value || 150000000),
                        new_only: !!document.getElementById('ans_new_only').checked,
                        strict_construction: !!document.getElementById('ans_good_con').checked,
                        construction_pref: con,
                        comments: document.getElementById('ans_comments').value || '',
                    };
                }
                
                // Seed/Submit: use onclick to avoid duplicate handlers across pages
                const _personaSeed = document.getElementById('persona_seed');
                if (_personaSeed) _personaSeed.onclick = async ()=>{
                    const ans = gatherAnswers();
                    const status = document.getElementById('persona_status');
                    try{
                        status.textContent = 'Creating seed profile...';
                        await fetchJSON('/api/persona/seed', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({answers: ans}) });
                        setActiveMode('custom');
                        // stamp last refined time
                        const d = new Date(); const hh = d.getHours().toString().padStart(2,'0'); const mm = d.getMinutes().toString().padStart(2,'0'); localStorage.setItem('LAST_REFINED_AT', `${hh}:${mm}`);
                        await populateGlobalModes();
                        document.getElementById('persona_modal')?.classList?.add('hidden');
                        window.toast?.('Seed profile created successfully', 'success');
                    } catch(e){ window.toast?.('Seed failed: '+e.message, 'error'); }
                    finally{ status.textContent = ''; }
                };
                
                const _personaSubmit = document.getElementById('persona_submit');
                if (_personaSubmit) _personaSubmit.onclick = async ()=>{
                    const ans = gatherAnswers();
                    const status = document.getElementById('persona_status');
                    try{
                        status.textContent = 'Building with AI... This may take a moment ‚ú®';
                        await fetchJSON('/api/persona/propose', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({answers: ans, goal_text: ans.comments || ''}) });
                        setActiveMode('custom');
                        const d = new Date(); const hh = d.getHours().toString().padStart(2,'0'); const mm = d.getMinutes().toString().padStart(2,'0'); localStorage.setItem('LAST_REFINED_AT', `${hh}:${mm}`);
                        await populateGlobalModes();
                        document.getElementById('persona_modal')?.classList?.add('hidden');
                        window.toast?.('üéâ AI-powered persona created and activated!', 'success');
                    } catch(e){ window.toast?.('AI proposal failed: '+e.message, 'error'); }
                    finally{ status.textContent = ''; }
                };
                // Initial
                document.getElementById('global_mode_label').textContent = prettyMode(getActiveMode());
                populateGlobalModes();
            })();
        </script>

        <!-- Core helpers (toast/fetch/loading) -->
        <script src="{{ url_for('static', filename='js/app.js') }}"></script>

        <!-- Personalization & vibes -->
        <script>
            (function personalize(){
                const vibes = [
                  { key:'aurora', label:'Aurora', colors:['#6366f1','#10b981','#f43f5e'] },
                  { key:'sunset', label:'Sunset', colors:['#f97316','#f43f5e','#eab308'] },
                  { key:'neon',   label:'Neon',   colors:['#22c55e','#3b82f6','#f43f5e'] },
                  { key:'sakura', label:'Sakura', colors:['#f472b6','#e879f9','#a78bfa'] },
                  { key:'ocean',  label:'Ocean',  colors:['#0ea5e9','#14b8a6','#818cf8'] },
                ];
                const getVibe = () => localStorage.getItem('VIBE') || 'aurora';
                const setVibe = (v) => { localStorage.setItem('VIBE', v); applyVibe(); };
                const applyVibe = () => {
                  const v = getVibe();
                  document.body.classList.remove(...vibes.map(x=>'vibe-'+x.key));
                  document.body.classList.add('vibe-'+v);
                  document.getElementById('vibe_label')?.replaceChildren(document.createTextNode(v.charAt(0).toUpperCase()+v.slice(1)));
                };
                const getSat = () => Number(localStorage.getItem('VIBE_SAT') || '120');
                const setSat = (n) => { localStorage.setItem('VIBE_SAT', String(n)); document.documentElement.style.setProperty('--v-sat', n+'%'); };

                // Build vibe menu
                const list = document.getElementById('vibe_list');
                if (list){
                  list.innerHTML = vibes.map(v=>{
                    const grad = `linear-gradient(135deg, ${v.colors[0]}, ${v.colors[1]})`;
                    return `<button class="vibe-dot" data-vibe="${v.key}" title="${v.label}" style="background:${grad}"></button>`;
                  }).join('');
                  list.querySelectorAll('[data-vibe]').forEach(btn=>{
                    btn.addEventListener('click', ()=>{ setVibe(btn.getAttribute('data-vibe')); window.toast?.('Vibe set to ' + btn.title, 'success'); closeVibeMenu(); });
                  });
                }
                const sat = document.getElementById('vibe_sat');
                if (sat){ sat.value = getSat(); sat.addEventListener('input', ()=> setSat(Number(sat.value))); }

                function toggleVibeMenu(){
                  const m = document.getElementById('vibe_menu');
                  const hidden = m.classList.contains('hidden');
                  m.classList.toggle('hidden');
                  document.getElementById('vibe_btn').setAttribute('aria-expanded', String(!hidden));
                }
                function closeVibeMenu(){
                  const m = document.getElementById('vibe_menu');
                  m.classList.add('hidden');
                  document.getElementById('vibe_btn').setAttribute('aria-expanded','false');
                }
                document.getElementById('vibe_btn')?.addEventListener('click', (e)=>{ e.stopPropagation(); toggleVibeMenu(); });
                document.addEventListener('click', (e)=>{
                  const host = document.getElementById('vibe_host');
                  const menu = document.getElementById('vibe_menu');
                  if (menu && !menu.classList.contains('hidden') && host && !host.contains(e.target)) closeVibeMenu();
                });

                // Initial apply
                applyVibe();
                setSat(getSat());

                // User name / greeting
                const getName = () => localStorage.getItem('USER_NAME') || '';
                const setName = (s) => { localStorage.setItem('USER_NAME', s); applyName(); };
                function initials(s){
                  const parts = String(s).trim().split(/\s+/).filter(Boolean);
                  if (!parts.length) return 'U';
                  return (parts[0][0] + (parts[1]?.[0] || '')).toUpperCase();
                }
                function greeting(){
                  const h = new Date().getHours();
                  if (h < 12) return 'Good morning';
                  if (h < 18) return 'Good afternoon';
                  return 'Good evening';
                }
                function applyName(){
                  const n = getName();
                  const greet = greeting() + (n ? ', ' + n : '');
                  const av = document.getElementById('user_avatar');
                  const gg = document.getElementById('user_greet');
                  const inp = document.getElementById('user_name');
                  if (av) av.textContent = initials(n);
                  if (gg) gg.textContent = greet;
                  if (inp && inp !== document.activeElement) inp.value = n;
                }
                document.getElementById('user_btn')?.addEventListener('click', (e)=>{
                  e.stopPropagation();
                  const m = document.getElementById('user_menu');
                  const hidden = m.classList.contains('hidden');
                  m.classList.toggle('hidden');
                  document.getElementById('user_btn').setAttribute('aria-expanded', String(!hidden));
                });
                document.getElementById('user_save')?.addEventListener('click', ()=>{
                  const v = document.getElementById('user_name').value || '';
                  setName(v);
                  document.getElementById('user_menu').classList.add('hidden');
                  window.toast?.('Saved your name', 'success');
                });
                document.addEventListener('click', (e)=>{
                  const host = document.getElementById('user_host');
                  const menu = document.getElementById('user_menu');
                  if (menu && !menu.classList.contains('hidden') && host && !host.contains(e.target)){
                    menu.classList.add('hidden');
                    document.getElementById('user_btn').setAttribute('aria-expanded','false');
                  }
                });
                applyName();
                // Keep greeting fresh hourly
                setInterval(applyName, 60*60*1000);
            })();
        </script>
    </body>
</html>
